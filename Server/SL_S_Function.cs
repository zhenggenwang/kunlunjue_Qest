//■■■■■■■■■■■点击NPC触发的脚本■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■创建掉落包的公告■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■创建掉落包命令整合■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■刷新怪物命令整合■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■刷新采集物命令整合■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■刷新陷阱命令整合■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■刷新特效命令整合■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■传送地图脚本■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■飞行点触发■■■■■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■新建人物出生点坐标■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■新手角色初始化脚本■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■角色成功登陆■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■角色切换线程■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■角色切换地图■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■角色下线触发■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■登录时修正坐标■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色登录Or切换线程Or切换地图都要执行的命令■■■■■
//■■■■■■■■■■■机器人登陆触发脚本■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色升级■■■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■神兽升级■■■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■角色死亡■■■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■角色复活■■■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■角色升级前置判断■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■特定过滤某些共享任务的脚本方法■■■■■■■■■■■
//■■■■■■■■■■■道具鉴定脚本■■■■■■■■■■■■■■■■■■■■ 
//■■■■■■■■■■■学习生活技能自动学会配方■■■■■■■■■■■■■■

//■■■■■■■■■■■服务器定时刷新各种活动■■■■■■■■■■■■■■■

//■■■■■■■■■■■发送任务特效■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■系统邮件事件处理脚本■■■■■■■■■■■■■■■■
//■■■■■■■■■■■验证码脚本接口■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■上缴道具神兽成功后回调函数■■■■■■■■■■■■■
//■■■■■■■装备鉴定、进阶、刻铭、打孔、镶嵌操作完成后回调■■■■■■■
//■■■■■■■■■■■神兽进阶品阶触发■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■队伍操作■■■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■获取目标朝向的反面■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■善恶值触发事件■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■玩家死亡善恶值符合触发脚本■■■■■■■■■■■■■
//■■■■■■■■■■■跨地图执行脚本■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■加油上BUFF设置■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■服务器开启时自动执行■■■■■■■■■■■■■■■■
//■■■■■■■■■■■客户端通讯脚本■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■■离线经验奖励领取■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■玩家被玩家击败触发■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■各大地图击败公告■■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■给予经验的统一管理■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■活跃度增加统一管理■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■姻缘成功调用■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■统一增加帮派数据■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■化神升级境界时触发■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■进入副本获得双倍经验调用■■■■■■■■■■■■■■
//■■■■■■■■■■■触发验证码调用■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■玩家复活点复活坐标返回■■■■■■■■■■■■■■■
//■■■■■■■■■■■满血满蓝复活■■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■检测是否已经隔天■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■更新所有地图脚本命令■■■■■■■■■■■■■■■■
//■■■■■■■■■■■跨线程队友发送消息■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■师徒拜师出师成功触发■■■■■■■■■■■■■■■■
//■■■■■■■■■■■因为特殊原因需要获取复活点坐标■■■■■■■■■■■
//■■■■■■■■■■■洗炼成功后调用■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■集合符和召唤符■■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■千里眼功能扣除物品■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■获取副本中过滤最低等级后的平均等级函数■■■■■■■
//■■■■■■■■■■■计时器结束后触发脚本■■■■■■■■■■■■■■■■

//■■■■■■■■■■■化神激活境界时触发■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■副本内通知设置头顶标示■■■■■■■■■■■■■■■
//■■■■■■■■■■■副本中给所有玩家添加调度状态命令■■■■■■■■■■
//■■■■■■■■■■■设置副本所有玩家头顶标记■■■■■■■■■■■■■■
//■■■■■■■■■■■返回星宿功能所需内容■■■■■■■■■■■■■■■■
//■■■■■■■■■■■兑换活跃积分成功触发■■■■■■■■■■■■■■■■

//■■■■■■■■■■■玩家提取元宝触发■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■全服事件回调脚本■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■传送地图时检查网格是否合法，否则传送初始位置■■■■
//■■■■■■■■■■■设置特殊地图不显示玩家名称■■■■■■■■■■■■■

//■■■■■■■■■■■统一添加道具，若包裹已满则发送邮件■■■■■■■■■
//■■■■■■■■■■■判断获取月、日时间■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■固定礼包开启触发■■■■■■■■■■■■■■■■■■
//■■■■■■■■■■■改名功能■■■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■【服务器公告】■■■■■■■■【可开启界面链接】■■■

//■■■■■■■■■■【商城相关】■■■■■■■■【商城购买物品触发】■■■
//■■■■■■■■■■【武魂相关】■■■■■■■■【每次搜魂触发】■■■■■


//■■■■■■■■■■■■■■■【化神提升触发】■■■■■■■■■■■■■■
//■■■■■■■■■■■■■■■【神兽变异触发】■■■■■■■■■■■■■■
//■■■■■■■■■■■■■■■【经脉冲穴触发】■■■■■■■■■■■■■■
//■■■■■■■■■■■■■■■【搜出橙色武魂触发】■■■■■■■■■■■■
//■■■■■■■■■■■■■■■【野外换线相关】■■■■■■■■■■■■■■
//■■■■■■■■■■■■■■■【获取当前队伍的队长】■■■■■■■■■■■
//■■■■■■■■■■■■■■■【攻略界面在服务端的记录】■■■■■■■■■
//■■■■■■■■■■■■■■■【使用喇叭诅咒和祝福】■■■■■■■■■■■
//■■■■■■■■■■■■■■■【成就添加接口】■■■■■■■■■■■■■■
//■■■■■■■■■■■■■■■【删除包裹道具】■■■■■■■■■■■■■■
//■■■■■■■■■■■定位符免费次数记录■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■点击NPC触发的脚本■■■■■■■■■■■■■■■■■
function NpcObject::OnTrigger(%Npc,%Player,%State,%Param)
{

	//获取NPC编号
	%NpcID=%Npc.GetDataID();
	PutOut("%NpcID = " @ %NpcID @ "  %State==" @ %State  @ " %NpcName = " @ %Npc.GetObjectName() @ "  %Pos == " @ %Player.GetPosition()  @ "    %Param===" @ %Param);
	if (%State==0)
		%Player.NPC_MissionLs=0;

	%Conv=%Player.GetConversation();
	%Conv.Reset();		//重置所有选项
	%Conv.SetType(1);	//对话方式（无选项）

	if (%State==-1)
	{
		%Conv.SetType(4);	//关闭对话
		%Conv.Send(%Player);
		return;
	}

	//执行Npc点击触发的脚本
	NpcOnTrigger(%Conv,%Npc,%Player,%State,%Param);

	//判断NPC交互延迟
	NpcOnSlowTime(%Npc);

	%Conv.Send(%Player);
}

//执行Npc点击触发的脚本
function NpcOnTrigger(%Conv,%Npc,%Player,%State,%Param)
{
	//显示NPC默认对话
	%Conv.SetText(%Npc.GetDataID());
	//echo( "执行Npc点击触发的脚本===" @  %State );
	//用于临时修复的内容，最优先位置
	//Npc_Hotfix_Opition(%Npc, %Player, %State, %Conv);

	if ((%State==0)||(strlen(%State)==8))
	{
		Mission_Special(%Npc,%Player,%State,%Conv,%Param);	//特殊任务脚本
		Mission_Normal(%Npc,%Player,%State,%Conv,%Param);		//普通任务脚本
	}
	//%State变量少于等于6位时，进入此地
	Npc_Job(%Npc,%Player,%State,%Conv);		//NPC功能性脚本
	//活动相关脚本
	NpcOnTrigger_PlayGame(%Npc,%Player,%State,%Conv,%Param);

	//副本相关脚本
	NpcOnTrigger_CopyMap(%Npc,%Player,%State,%Conv,%Param);



	//		Npc_Job_Opition(%Npc, %Player, %State, %Conv);

	//用于Debug的测试相关功能//月光宝盒
	if (GetBuildString() $="Debug")
		MoonLightBaoHe(%Npc,%Player,%State,%Conv);
}

//判断NPC交互延迟
function NpcOnSlowTime(%Npc)
{
	switch$(%Npc.GetDataID())
	{
		//设置NPC交互延迟时间
		case "401103045":%Npc.SetInteractionDelay(5000);
		case "400001636":%Npc.SetInteractionDelay(30*1000);
	}
}
//■■■■■■■■■■■点击NPC触发的脚本■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■创建掉落包的公告■■■■■■■■■■■■■■■■■■
//NpcShowDropItemInfoTips(0,264052,107020201,1,3);
function PlayerShowDropItemInfoTips(%Player,%DestBuff)
{
	//echo( "%DestBuff==========" @ %DestBuff );
	%ItemName="<l i='" @ %DestBuff @"' t='item'/>";
	%PlayerName1=GetPlayerZiTiName(%Player,1);
	%PlayerName2=GetPlayerZiTiName(%Player,2);
	%MapName1=GetMapName(%Player,1);
	%MapName2=GetMapName(%Player,2);
	%Text1=%ItemName @ "<t>从</t>" @ %PlayerName1 @ "<t>身上掉落在</t>" @ %MapName1 @ "<t>。</t>";
	%Text2=%ItemName @ "<t>从</t>" @ %PlayerName2 @ "<t>身上掉落在</t>" @ %MapName2 @ "<t>。</t>";
	SendOneLineMessage($Get_Dialog_GeShi[31419] @ %Text1 @ "</t>");
	SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
}
function NpcShowDropItemInfoTips(%Monster,%Player,%ItemID,%ItemNum,%Msgtype)
{
	//echo( "掉落包公告====" @ %Msgtype  );
	//echo( "%Player.GetObejctname()==" @ %Player.GetObjectname( )  @ "  " @ %Player);
	if (%Msgtype < 1)
		return;

	%ItemName1=GetItemName(%ItemID,1);
	%ItemName2=GetItemName(%ItemID,2);
	%Path=GetMapName(%Player,1);
	%MapName=GetMapName(%Player,2);
	//echo( "%Path ===" @ %Path );
	//echo( "%MapName ===" @ %MapName );
	%Text1=%ItemName1 @ "<t>掉落在</t>" @ %Path @ "<t>。</t>";
	%Text2=%ItemName2 @ "<t>掉落在</t>" @ $Get_Dialog_GeShi[60002] @ %MapName @ "</t>" @ "<t>。</t>";
	//echo( %Text1 );
	switch (%Msgtype)
	{
		case 1:
			SendOneLineMessage($Get_Dialog_GeShi[31419] @ %Text1 @ "</t>");
		case 2:
			SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
		case 3:
			SendOneLineMessage($Get_Dialog_GeShi[31419] @ %Text1 @ "</t>");
			SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
	}
}
//■■■■■■■■■■■创建掉落包的公告■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■创建掉落包命令整合■■■■■■■■■■■■■■■■■

//SpNewDropItem(262983,262921,108020208,1 );
function SpNewDropItem(%Npc,%Player,%ItemID,%ItemCount,%Msgtype)
{
	%istrue=%Npc.DropItemAddToMap(%Player.GetPlayerID(),%ItemID,%ItemCount);
	//echo( "%Obj===" @ %Obj );
	if (!%istrue)
		return;
	%ItemType=GetItemData(%ItemId,2);//道具类型
	%ItemClor=GetItemData(%ItemID,20);//道具颜色
	//switch( %ItemClor )
	//{
	//	case 1://灰色
	//	case 2: %Obj.addpacket( 260051 );//掉物特效	白色
	//	case 3: %Obj.addpacket( 260052 );//掉物特效	绿色
	//	case 4: %Obj.addpacket( 260053 );//掉物特效	蓝色
	//	case 5: %Obj.addpacket( 260054 );//掉物特效	紫色
	//	case 6: %Obj.addpacket( 260055 );//掉物特效	橙色
	//	case 7: %Obj.addpacket( 260055 );//红色
	//}
	//echo( "%ItemClor===" @ %ItemClor );
	if (%ItemClor > 4&&%Msgtype > 0)
	{
		%ItemName=GetItemName(%ItemID,1);
		%ItemName2=GetItemName(%ItemID,2);
		%TriggerID=%Player.GetTriggerID();
		%Path=GetMapName(%Player,1);
		%MapName=GetMapName(%Player,2);

		%Text=%ItemName @ "<t>掉落在</t>" @ %Path @ "<t>。</t>";
		%Text2=%ItemName2 @ "<t>掉落在</t>" @ $Get_Dialog_GeShi[60002] @ %MapName @ "</t>" @ "<t>。</t>";
		switch (%Msgtype)
		{
			case 1:
				SendOneLineMessage($Get_Dialog_GeShi[31419] @ %Text @ "</t>");
			case 2:
				SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
			case 3:
				SendOneLineMessage($Get_Dialog_GeShi[31419] @ %Text @ "</t>");
				SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
		}
	}
}
function SetKLJNpcPrizeBox(%objecid)
{
	$g_id=%objecid;
}
//■■■■■■■■■■■创建掉落包命令整合■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■刷新怪物命令整合■■■■■■■■■■■■■■■■■■
//Player 怪物ID 坐标 副本层 朝向 大小
//刷新Npcd
function SpNewNpc(%Player,%NpcID,%Pos,%CopyMapID)
{
	if (%CopyMapID !$="0")
		%obj=SpawnNpc(%NpcID,%CopyMapID);
	else
		%obj=SpawnNpc(%NpcID);

	if (%Pos !$="0")
		%obj.SetPosition(%Pos);
	else
		%obj.SetPosition(%Player.GetPosition());
	AddSkill_TongYongAI(%obj,%NpcID);
	return %obj;
}

//刷新Npc，有带朝向参数
function SpNewNpc2(%Player,%NpcID,%Pos,%CopyMapID,%Rot)
{
	if (%CopyMapID !$="0")
		%obj=SpawnNpc(%NpcID,%CopyMapID);
	else
		%obj=SpawnNpc(%NpcID);

	//判断坐标参数
	if (%Pos $="0")
		%Pos=%Player.GetPosition();

	//判断朝向参数
	if (%Rot !$="0")
	{
		%obj.SetPosition(%Pos,mDegToRad(%Rot));
		%obj.initRotz=mDegToRad(%Rot);
	}
	else
		%obj.SetPosition(%Pos);

	AddSkill_TongYongAI(%obj,%NpcID);

	return %obj;
}

//刷新Npc，有带朝向参数，带放大参数
function SpNewNpc3(%Player,%NpcID,%Pos,%CopyMapID,%Rot,%Scale)
{
	if (%CopyMapID !$="0")
		%obj=SpawnNpc(%NpcID,%CopyMapID);
	else
		%obj=SpawnNpc(%NpcID);

	//判断坐标参数
	if (%Pos $="0")
		%Pos=%Player.GetPosition();

	//判断朝向参数
	if (%Rot !$="0")
	{
		%obj.SetPosition(%Pos,mDegToRad(%Rot));
		%obj.initRotz=mDegToRad(%Rot);
	}
	else
		%obj.SetPosition(%Pos);

	//判断模型放大参数
	if (%Scale !$="0")
		%obj.SetScale(%Scale);

	AddSkill_TongYongAI(%obj,%NpcID);

	return %obj;
}
//■■■■■■■■■■■刷新怪物命令整合■■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■刷新采集物命令整合■■■■■■■■■■■■■■■■■
//Player 采集物ID 坐标 副本层 朝向 大小
function SpNewCj(%Player,%ID,%Pos,%Rot,%Scale)
{
	if ((%Player !$="0")&&(%Pos==0))
		%Pos=%Player.GetPosition();

	%obj=CreateCollectionObject(%ID,%Pos,%Rot,%Scale,0);

	return %obj;
}

//带副本层
function SpNewCj2(%Player,%ID,%Pos,%CopyMapID,%Rot,%Scale)
{
	if ((%Player !$="0")&&(%Pos==0))
		%Pos=%Player.GetPosition();

	%obj=CreateCollectionObject(%ID,%Pos,%Rot,%Scale,%CopyMapID);

	return %obj;
}

//■■■■■■■■■■■刷新陷阱命令整合■■■■■■■■■■■■■■■■■■
//Player 采集物ID 坐标 副本层 朝向 大小
function SpNewTrap(%Player,%NpcID,%Pos,%CopyMapID,%Rot,%Scale)
{
	if (%CopyMapID !$="0")
		%obj=SpawnTrap(%NpcID,%CopyMapID);
	else
		%obj=SpawnTrap(%NpcID);

	//判断坐标参数
	if (%Pos $="0")
		%Pos=%Player.GetPosition();

	//判断朝向参数
	if (%Rot !$="0")
		%obj.SetPosition(%Pos,mDegToRad(%Rot));
	else
		%obj.SetPosition(%Pos);

	//判断模型放大参数
	if (%Scale !$="0")
		%obj.SetScale(%Scale);

	return %obj;
}
//■■■■■■■■■■■刷新陷阱命令整合■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■刷新特效命令整合■■■■■■■■■■■■■■■■■■
function SpNewEff(%Player,%EffectID,%Pos)
{
	if (%Pos $="0")
		%Pos=%Player.GetPosition();

	//获取副本层
	%CopyMapID=%Player.GetLayerId();

	return AddEffectPacket(%EffectID,0,%Pos,"1 0 0 0",0,0,-1,%CopyMapID);
}
//■■■■■■■■■■■刷新特效命令整合■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■传送地图脚本■■■■■■■■■■■■■■■■■■■■
function GoToNextMap(%Player,%Destination,%Spare)
{
	//%Destination 目的地  	4位地图ID或者 9位区域ID   
	//%Spare	备用参数
	//echo( "%Destination===" @ %Destination );
	//echo( %Player.GetTriggerid( ) );
	%Index=CanTransportobject(%Player,1);//传送前置判断
	if (%Index==0)
		return;
	//--------------------读取各类信息,判断传送是否合法--------------------------------
	if (strlen(%Destination)==4)//地图 -->地图 传送
	{
		%StartMap=GetSubStr(GetZoneid(),0,4);
		%EndMap=%Destination;
		%Player.MaptoMapRecord=%Destination @ " " @ $Transport_Xyz[%Destination];
		//echo( %Destination @ " " @ $Transport_Xyz[ %Destination ] );
		//echo( "%Player.MaptoMapRecord=A==" @ %Player.MaptoMapRecord );
	}
	else if (strlen(%Destination)==9)//区域-->区域 传送
	{
		%EndMap=GetSubStr(%Destination,1,4);

		%StartTriggerid=%Player.GetTriggerid();
		//echo( %Player.GetTriggerid( ) );
		%StartMap=GetSubStr(%StartTriggerid,1,4);

		if ($Transport_Xyz[%StartTriggerid,%Destination] $="")
		{
			//echo( "%StartTriggerid==" @ %StartTriggerid );
			//echo( "%Destination==" @ %Destination );
			//echo( "$Transport_Xyz[ %StartTriggerid, %Destination ]===" @ $Transport_Xyz[ %StartTriggerid, %Destination ] );
			if ($Transport_Xyz[%Destination] !$="")
				%Player.MaptoMapRecord=%EndMap @ " " @ $Transport_Xyz[%Destination];
			else if ($Transport_Xyz[%EndMap] !$="")
				%Player.MaptoMapRecord=%EndMap @ " " @ $Transport_Xyz[%EndMap];
			else
			{
				for (%i=1; %i<=4; %i++)
				{
					%NeeID="8" @ %StartMap @ "0" @ %i @ "00";
					if ($Transport_Xyz[%NeeID,%Destination] !$="")
					{
						%StartTriggerid=%NeeID;
						%Player.MaptoMapRecord=%EndMap @ " " @ $Transport_Xyz[%StartTriggerid,%Destination];
						break;
					}
				}
			}
		}
		else
			%Player.MaptoMapRecord=%EndMap @ " " @ $Transport_Xyz[%StartTriggerid,%Destination];
	}
	else
	{
		%Txt1="目的地图有误！错误代码-" @ %StartMap @ ":" @ %Destination;
		SendOneScreenMessage(2,%Txt1,%Player);
		SendOneChatMessage($chatMsg_System,"<t>" @ %Txt1 @ "</t>",%Player);
		return;
	}
	//echo("%Player.MaptoMapRecord=B==" @ %Player.MaptoMapRecord);
	//----------------判断目标是否可以到达-----------
	if (%StartMap < 1300&&%EndMap>=1300)//进入副本
	{
		if (%Player.GetCaptivateState() >= 1)
			HelpDirectByIndex(%Player.GetPlayerID(),29);	//通讯客户端
		else
			schedule(100,0,"TransportPlayerMaptoMap",%Player,1);
	}
	else if (%StartMap>=1300&&%EndMap < 1300)//离开副本
	{
		%Player.ShowDialogOk(2000000001,1,1);
	}
	else if (%StartMap==%EndMap && %StartMap > 1300&&%EndMap > 1300)
	{
		schedule(100,0,"TransportPlayerMaptoMap",%Player,3);
	}
	else if (%StartMap < 1300&&%EndMap < 1300)//普通传送
	{
		if (%StartMap==%EndMap)//不跨地图的传送
			schedule(100,0,"TransportPlayerMaptoMap",%Player,3);
		else //跨地图传送
			schedule(100,0,"TransportPlayerMaptoMap",%Player,4);
	}
	else
	{
		%Txt1="目的地图有误！错误代码---" @ %StartMap @ ":" @ %Destination;
		SendOneScreenMessage(2,%Txt1,%Player);
		SendOneChatMessage($chatMsg_System,"<t>" @ %Txt1 @ "</t>",%Player);
		return;
	}
}
function TransportPlayerMaptoMap(%Player,%optype)
{
	//echo( "%Player.MaptoMapRecord===" @ %Player.MaptoMapRecord );
	%MapID=GetWord(%Player.MaptoMapRecord,0);
	%X=GetWord(%Player.MaptoMapRecord,1)*1;
	%Y=GetWord(%Player.MaptoMapRecord,2)*1;
	%Z=GetWord(%Player.MaptoMapRecord,3)*1;
	if (%X==0&&%Y==0&&%Z==0)
	{
		%Txt1="目的坐标错误！错误代码-" @ %Player.MaptoMapRecord;
		echo("%Txt1 ===" @ %Txt1);
		SendOneScreenMessage(2,%Txt1,%Player);
		SendOneChatMessage($chatMsg_System,"<t>" @ %Txt1 @ "</t>",%Player);
		return;
	}
	//传送特效
	SpNewEff(%Player,$SP_Effect[6],0);
	%Player.SetSchbuff(1003);//虚无BUFF
	%PlayerID=%Player.GetPlayerID();
	switch (%optype)
	{
		case 1://进入副本
			//if ( %MapID == 1304 )
			//	SptCopyMap_TransportPlayerEx( %PlayerID, %MapID, 0, %X @ " " @ %Y @ " " @ %Z, 0 );
			////else if ( %Ex == 2 )
			////	SptCopyMap_TransportPlayerByCorps( %PlayerID, %Map, %Xyz, 0 );
			////else
			//SptCopyMap_TransportPlayer( %PlayerID, %MapID, %X @ " " @ %Y @ " " @ %Z, 0 );

			switch (%MapID)
			{
				case 1304:%Ex=1;
				case 1307:%Ex=1;
				case 1308:%Ex=1;
				case 1309:%Ex=1;
				case 1313:%Ex=1;
				case 1314:%Ex=1;
				case 1315:%Ex=1;
				case 1316:%Ex=3;
				default:%Ex=4;
			}
			//echo(%X @ " " @ %Y @ " " @ %Z);

			if (%Ex==1)
				SptCopyMap_TransportPlayerEx(%PlayerID,%MapID,0,%X @ " " @ %Y @ " " @ %Z,0);//所有使用此命令传送的玩家会被传送到同一副本层
			else if (%Ex==2)
				SptCopyMap_TransportPlayerByCorps(%PlayerID,%MapID,%X @ " " @ %Y @ " " @ %Z,0);//以团队为单位进行传送，同一团队的玩家传送到同一副本层
			else if (%Ex==3)
			{
				echo("%Ex===========以帮会为单位进行传送=========================" @ %Ex);
				SptCopyMap_TransportOrgCopy(%PlayerID,%MapID,%X @ " " @ %Y @ " " @ %Z,0);//以帮会为单位进行传送，同一帮会的玩家传送到同一副本层
			}
			else
				SptCopyMap_TransportPlayer(%PlayerID,%MapID,%X @ " " @ %Y @ " " @ %Z,0);//以小队为单位进行传送
		case 2://离开副本
			SptCopymap_RemovePlayer(%PlayerID,%X @ " " @ %Y @ " " @ %Z,%MapID);
		case 3://不跨地图的传送
			%Player.TransportObject(0,0,%X,%Y,%Z);
		case 4://跨地图的传送
			%Player.TransportObject(0,%MapID,%X,%Y,%Z);
	}
}


//－－－跨地图的NPC传送－－－
function QueryNPCTransport(%Player,%Npc,%CurMapId,%DestTriggerId)
{
	//echo("%Player ===" @ %Player  @ "%Npc ==" @ %Npc.Getobjectname() @ "     %CurMapId===" @  %CurMapId @ "     %DestTriggerId===" @ %DestTriggerId);
	//%Player ===263138%Npc ==263098     %CurMapId===810100100     %DestTriggerId===810010100
	//先看看当前是不是在副本内，副本内不传送
	//目的地如果是副本，也不能传送
	//只打开NPC对话框
	if (GetSubStr(GetZoneID(),1,1) $="3")
	{
		SendOneScreenMessage(2,"您正在副本内，无法直接前往",%Player);
		SendOneChatMessage($chatMsg_System,"<t>您正在副本内，无法直接前往</t>",%Player);
	}
	else if (GetSubStr(%DestTriggerId,2,1) $="3")
	{
		SendOneScreenMessage(2,"目标在副本内，无法直接前往",%Player);
		SendOneChatMessage($chatMsg_System,"<t>目标在副本内，无法直接前往</t>",%Player);
	}
	else
	{
		if (GetNpcData(%Npc.GetDataid(),0) > 0)
		{
			%DestTriggerId=GetQueryNPCTransportTarGetId(%Player,%Npc,%CurMapId,%DestTriggerId);//修正目的地
			NpcTransportObject(%Npc,%Player,"5" @ GetSubStr(%DestTriggerId,1,8),0);
		}

	}
}
function GetQueryNPCTransportTarGetId(%Player,%Npc,%CurMapId,%DestTriggerId)
{
	if ($QueryNPCTransport[%DestTriggerId] !$="")
		return $QueryNPCTransport[%DestTriggerId];

	%NpcID=%Npc.GetDataID();
	%Number=GetWordCount($Transport_Npc[%NpcID],";");
	for (%i=0; %i < %Number; %i++)
	{
		%MsgList=GetWord($Transport_Npc[%NpcID],%i,";");
		%WanttoMapID=GetWord(%MsgList,0);
		if (Strlen(%WanttoMapID)==9&&GetSubStr(%DestTriggerId,1,4) $=GetSubStr(%WanttoMapID,1,4))
		{
			$QueryNPCTransport[%DestTriggerId]=%WanttoMapID;
			break;
		}
		if (Strlen(%WanttoMapID)==4&&%WanttoMapID $=GetSubStr(%DestTriggerId,1,4))
		{
			$QueryNPCTransport[%DestTriggerId]="8" @ %WanttoMapID @ "0100";
			break;
		}
	}
	return $QueryNPCTransport[%DestTriggerId];
}
//■■■■■■■■■■■传送地图脚本■■■■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■飞行点触发■■■■■■■■■■■■■■■■■■■■■
function FlyMeToTheMoon(%Player,%FlyID,%MountID)
{
	if ((%FlyID > 0)&&(%MountId > 0))
		return %Player.SetFlyPath(%FlyID,%MountId);

	return false;
}

//■■■■■■■■■■■飞行点触发■■■■■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■苍山雪海临时传送员■■■■■■■■■■■■■■■■■■■■

function Npc_Dialog_411020012(%Npc,%Player,%State,%Conv,%Param)
{
	switch (%State)
	{
		case 0:
			%Conv.AddOption(600000034,600000034);
			%Conv.AddOption(600000035,600000035);
			%Conv.AddOption(600000036,600000036);
		case 600000034:
			gotonextmap(%Player,"811020101","");
		case 600000035:
			gotonextmap(%Player,"811020102","");
		case 600000036:
			gotonextmap(%Player,"811020103","");
	}
}
//■■■■■■■■■■■苍山雪海临时传送员■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■新建人物出生点坐标■■■■■■■■■■■■■■■■■
function SvrGetNewbiePosition(%Class)
{
	return "100 -210 107";
}
//■■■■■■■■■■■新建人物出生点坐标■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■新手角色初始化脚本■■■■■■■■■■■■■■■■■
//－－－角色初始化－－－
//－－－镜头触发－－－
//－－－动画开始－－－
//－－－动画结束－－－
//－－－预创建玩家奖励－－－

//－－－角色初始化－－－
function NewbieInit(%Player)
{
	//添加物品到装备栏
	%Classes=%Player.GetClasses(0);
	switch (%Classes)
	{
		case 1:%ZuoQI=704003701; %Skill[1]=210010001; %Skill[2]=210020001; //战士
		case 2:%ZuoQI=704003701; %Skill[1]=220010001; %Skill[2]=220020001; //刺客
		case 3:%ZuoQI=704003701; %Skill[1]=230010001; %Skill[2]=230020001; //法师
		case 4:%ZuoQI=704003701; %Skill[1]=240010001; %Skill[2]=240020001; //道士
		case 5:%ZuoQI=704003701; %Skill[1]=250010001; %Skill[2]=250020001; //猎人
	}
	//添加法宝
	%Player.AddItemToEquip(117010211,1);

	//添加武器 
	//%Player.AddItemToEquip( %Item[ 1 ], 11 );

	//月光宝盒
	if ($YueGuangBaoHe_108020208==1)
	{
		if (GetBuildString() $="Debug")
		{
			%Player.PutItem(108020208,1);
			%Player.PutItem(105109500,1);//测试礼包
			%Player.PutItem(105109495,16);
			%Player.AddItem(13,15);
		}
	}

	//添加时装
	//%Player.AddItemToEquip($ShapeFashion[%Classes, %Player.GetFace()], 0);

	//添加技能
	%Player.AddSkill(200330001);	//跳跃技能
	%Player.AddSkill(201010001);  //普攻
	//%Player.AddSkill( %Skill[ 1 ] );	//职业技能1
	//%Player.AddSkill( %Skill[ 2 ] );	//职业技能2

	%Player.AddSkill(200160001);//调息打坐技能
	%Player.AddSkill(200180001);//回城术技能
	%Player.addskill(200190001);//搜寻灵脉
	//设置快捷栏
	%Player.AddObjectToPanel(2,200330001,6);
	%Player.AddObjectToPanel(2,200160001,7);
	%Player.AddObjectToPanel(2,200180001,8);
	%Player.AddObjectToPanel(2,201010001,0);
	//%Player.AddObjectToPanel( 2, %Skill[ 1 ], 0 );
	//%Player.AddObjectToPanel( 2, %Skill[ 2 ], 1 );

	//添加坐骑
	//GenerateMountInfo( %Player.GetPlayerID( ), %ZuoQI );
	//%Player.AddObjectToPanel( 5, 0, 9 );
	//添加生活技能
	//LearnLivingSkill( %Player, 501011001 );//挖矿技能
	//LearnLivingSkill( %Player, 506011001 );//炼丹技能
	//LearnLivingSkill( %Player, 505011001 );//符咒技能
	//LearnLivingSkill( %Player, 504011001 );//工艺技能
	//LearnLivingSkill( %Player, 503011001 );//裁缝技能
	//LearnLivingSkill( %Player, 502011001 );//铸造技能
	//LearnLivingSkill( %Player, 501051001 );//采药技能

	LearnLivingSkill(%Player,501011101);//元宝挖矿技能
	LearnLivingSkill(%Player,501031101);//活动钓鱼技能
	//LearnLivingSkill( %Player, 501021001 );//伐木技能
	//LearnLivingSkill( %Player, 507011001 );//烹饪技能
	LearnLivingSkill(%Player,510011001);//宝石基础
	LearnLivingSkill(%Player,520011001);//通用采集
	LearnLivingSkill(%Player,520011002);//通用采集
	LearnLivingSkill(%Player,520011003);//通用采集
	LearnLivingSkill(%Player,520011004);//通用采集
	LearnLivingSkill(%Player,520011005);//通用采集
	LearnLivingSkill(%Player,520011006);//通用采集
	LearnLivingSkill(%Player,520011007);//通用采集
	LearnLivingSkill(%Player,520011008);//通用采集
	LearnLivingSkill(%Player,520011009);//通用采集
	LearnLivingSkill(%Player,520011010);//通用采集
	LearnLivingSkill(%Player,520011011);//通用采集
	LearnLivingSkill(%Player,520011012);//通用采集
	LearnLivingSkill(%Player,520011013);//通用采集
	LearnLivingSkill(%Player,520011014);//通用采集
	LearnLivingSkill(%Player,520011015);//通用采集
	LearnLivingSkill(%Player,520011016);//通用采集
	LearnLivingSkill(%Player,520011017);//通用采集
	LearnLivingSkill(%Player,520011018);//通用采集
	LearnLivingSkill(%Player,520011019);//通用采集
	LearnLivingSkill(%Player,520011020);//攻击木桩
	LearnLivingSkill(%Player,520011021);//拾取

	//给予玩家【新手】任务
	AddMissionAccepted(%Player,0,10001);

	//角色出生时统一客户端触发
	Schedule(500,0,"HelpDirectByIndex",%Player.GetPlayerID(),6);

	SetAct(%Player,4019,$CurrentLineId,$CurrentLineId);
	SetAct(%Player,4021,$NowServerTime2,0);
	ChangeLogicFloor(%Player,0,%Player);
	//%Player.SetFamily(1);
	CameraPathBegin(%Player.GetControllingClient(),10100005);
}
//礼包回调函数
function onAccountStatusSet(%Player,%bit,%val)
{
	//echo("GetCurrentLineId===" @ GetCurrentLineId() @ "  礼包回调函数====" @ %Player.getobjectname() @ " %Bit===" @ %Bit @ "   %val===" @ %val);
	switch (%Bit)
	{
		case 0:	//角色预创建
			if (%val==0)
			{
				%Player.PutItem(105180231, 1);
				%Player.AddItem(5, 1047);
			}

			//充值返利活动
		case 1:
			/*if ( %val == 1 )
			{
			%Txt  = "<t>由于您一次性提取元宝数目超过5000元宝，特赠送您价值50元的【黄金礼包】，此礼包每个账号只可获得一次！</t>";
			%Txt2 = "恭喜您获得价值50元的【黄金礼包】，系统已通过邮件发送给您，请注意查收";
			SptMail_Send( %Player.GetPlayerID( ), 105101720, 1, 0, 0, "充值返利", %Txt );
			SendOneChatMessage( $chatMsg_System, $Get_Dialog_GeShi[ 31204 ] @ %Txt2 @ "</t>", %Player );
			}*/
		case 2:
			/*if ( %val == 1 )
			{
			%Txt  = "<t>由于您一次性提取元宝数目超过10000元宝，特赠送您价值150元的【白金礼包】，此礼包每个账号只可获得一次！</t>";
			%Txt2 = "恭喜您获得价值150元的【白金礼包】，系统已通过邮件发送给您，请注意查收";
			SptMail_Send( %Player.GetPlayerID( ), 105101721, 1, 0, 0, "充值返利", %Txt );
			SendOneChatMessage( $chatMsg_System, $Get_Dialog_GeShi[ 31204 ] @ %Txt2 @ "</t>", %Player );
			}*/
		case 3:
			/*if ( %val == 1 )
			{
			%Txt  = "<t>由于您一次性提取元宝数目超过30000元宝，特赠送您价值600元的【至尊礼包】，此礼包每个账号只可获得一次！</t>";
			%Txt2 = "恭喜您获得价值600元的【至尊礼包】，系统已通过邮件发送给您，请注意查收";
			SptMail_Send( %Player.GetPlayerID( ), 105101722, 1, 0, 0, "充值返利", %Txt );
			SendOneChatMessage( $chatMsg_System, $Get_Dialog_GeShi[ 31204 ] @ %Txt2 @ "</t>", %Player );
			}*/
	}
}

//－－－镜头触发－－－
function onPlayerCreated(%Player,%Newbie)
{
	//新角色创建电影镜头//程序自动调用
	if (%Newbie)
	{
		//各圣地镜头路径
		if (GetHomeplace(%Player)==1){ %luX=10080002; }
		else if (GetHomeplace(%Player)==2){ %luX=10040002; }
		else if (GetHomeplace(%Player)==3){ %luX=10070002; }
		else if (GetHomeplace(%Player)==4){ %luX=10060002; }
		else if (GetHomeplace(%Player)==5){ %luX=10050002; }
		//		CameraPathBegin(%Player.GetControllingClient(), %luX);//镜头模式
	}
}

//－－－动画开始－－－
function CameraPathBegin(%Conn,%PathID)
{
	//记录玩家被控制
	%Player=%Conn.Player;


	if (%Player.isRobot()==1)
		return;

	%Player.SetMovieMode(1,%PathID);//开始

	//确保控制对象为玩家的情况下执行
	if (%Conn.getControlObject()!=%Conn.Player)
		return;

	//切换视角到camera ServerCmdToggleCamera(263230.GetControllingClient());
	ServerCmdToggleCamera(%Conn);

	//设置摄像机路径
	%Conn.camera.setPathMode(%pathId);
}

//－－－动画结束－－－
function CameraPathEnd(%Conn)
{
	//确保控制对象为摄像机的情况下执行
	if (%Conn.getControlObject()!=%Conn.camera)
		return;

	//切换视角到Player
	serverCmdToggleCamera(%Conn);
	%Player=%Conn.GetControlObject();
	%Player.SetMovieMode(0);//结束
}

//-------用于录视频的，不用管--------
function CameraPathBegin_1( %Conn, %PathID )
{
	//记录玩家被控制
	%Player=%Conn.Player;


	if ( %Player.isRobot( )==1 )
		return;

	//%Player.SetMovieMode( 1, %PathID );//上下2个黑框去掉

	//确保控制对象为玩家的情况下执行
	if ( %Conn.getControlObject( )!=%Conn.Player )
		return;

	//切换视角到camera ServerCmdToggleCamera(263230.GetControllingClient());
	ServerCmdToggleCamera( %Conn );

	//设置摄像机路径
	%Conn.camera.setPathMode( %pathId );
}
//-------------------------

//■■■■■■■■■■■新手角色初始化脚本■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色成功登陆■■■■■■■■■■■■■■■■■■■■
//－－－角色成功登录－－－
//－－－修复错误数据－－－

//－－－角色成功登录－－－

function SvrEventLogin(%Player)
{
	//获取PlayerID
	%PlayerID=%Player.GetPlayerID();
	%CopyMapID=%Player.GetLayerId();
	%MapID=GetZoneId();
	//创建竞技场信息
	//SptChallengeStart( %PlayerID );

	//发送欢迎消息
	SendOneChatMessage($chatMsg_System,$Get_Dialog_GeShi[31406] @ "欢迎进入《昆仑决》世界，世界为你精彩！</t>",%Player);
	SendOneChatMessage($chatMsg_System,$Get_Dialog_GeShi[31406] @ "<t>《昆仑决》唯一官方网站</t>" @ GetTraceButton("OpenGuanFangWeb();","<t>https://klj.wdgame.com.cn</t></t>"),%Player);

	//剧情副本掉线后，传送至副本入口
	%CopymapDataID=SptGetCopymapDataId(%CopyMapID);
	//if($story_CopyMap_Xyz[%CopymapDataID] !$= "")
	//	NoGoToNextMap(%Player, $story_CopyMap_Xyz[%CopymapDataID], 0, 0);
	//如果是在镇魔殿，直接踢出去
	if (%MapID==1118)
	{
		gotonextmap(%Player,1102,"");
	}
	//更新玩家城主称号
	//Player_Family_Master( %Player, %PlayerID );

	//登陆时延迟3秒，解决登陆时无法立即获得的信息
	Schedule(3000,0,"Schedule_SvrEventLogin",%Player);
	
	//限时抢购，更新玩家activity值
	XianShiQiangGou_UpdateActivity(%Player);

	//角色预创建礼包发放
	if (%Player.GetAccountStatus(0))
		%Player.SetAccountStatus(0,0);

	SetAct(%Player,4019,GetAct(%Player,4019,0),$CurrentLineId);
	//角色登录Or切换线程Or切换地图都要执行的命令，保证该在最后。
	SvrEvent_Login_SwitchLine_Transport(1,%Player);
}

//登陆延迟处理
function Schedule_SvrEventLogin(%Player)
{
	//若玩家是IVP6，则清除闭关修炼状态
	//if ( GetYuanBaovip( %Player ) >= 6 )
	//	%Player.RemoveSchBuff( 86 );
	%PlayerID=%Player.GetPlayerID();
	%Level=%Player.GetLevel();
	SendShiJieLevelto1001(%PlayerID,%Level);//计算是否需要刷新全服最高等级

	//------处理是否要重置随机商店---------------
	%Act3998_0=GetAct(%Player,3998,0);
	if (%Act3998_0 < $RandomStoreGoodsRecord)
	{
		SetAct(%Player,3998,$RandomStoreGoodsRecord,GetAct(%Player,3998,1));
		%Player.DelActivity(4000);
		%Player.DelActivity(4001);
		%Player.DelActivity(4002);
		%Player.DelActivity(4003);
		%Player.DelActivity(4004);
		%Player.DelActivity(4005);
		%Player.DelActivity(4006);
		%Player.DelActivity(4007);
		%Player.DelActivity(4008);
		%Player.DelActivity(4009);
		%Player.DelActivity(4010);
		%Player.DelActivity(4011);
	}
}

//■■■■■■■■■■■角色成功登陆■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色切换线程■■■■■■■■■■■■■■■■■■■■
function SvrEventSwitchLine(%Player)
{
	//角色登录Or切换线程Or切换地图都要执行的命令
	SvrEvent_Login_SwitchLine_Transport(2,%Player);
}
//■■■■■■■■■■■角色切换线程■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色切换地图■■■■■■■■■■■■■■■■■■■■
function SvrEventTransport(%Player)
{
	//获取地图ID
	%MapID=GetZoneID();
	//如果是在镇魔殿
	if (%MapID==1118)
	{
		SendOneScreenMessage(2,"当前区域极度危险，危急时刻可使用回城卷离开",%Player);
		SendOneChatMessage($chatMsg_System,$Get_Dialog_GeShi[31406] @ "当前区域极度危险，危急时刻可使用回城卷迅速撤离。</t>",%Player);
		SendOneChatMessage($chatMsg_System,$Get_Dialog_GeShi[31406] @ "您进入了镇魔殿，此地图极度危险，下线重登录或者使用回城卷可离开当前地图。</t>",%Player);
	}
	//传送特效
	SpNewEff(%Player,$SP_Effect[6],0);
	

	//通知客户端，我切换地图了

	//角色登录Or切换线程Or切换地图都要执行的命令，保证该在最后。
	SvrEvent_Login_SwitchLine_Transport(3,%Player);
}
//■■■■■■■■■■■角色切换地图■■■■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■角色下线触发■■■■■■■■■■■■■■■■■■■■
function SvrPlayerLogoutScene(%Player)
{

}
//■■■■■■■■■■■角色下线触发■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■登录时修正坐标■■■■■■■■■■■■■■■■■■■
function SvrPlayerrevisepos(%playerID,%triggerid)
{
	Schedule(3000,0,"SvrPlayerreviseposA",%playerID,%triggerid);

}
function SvrPlayerreviseposA(%playerID,%triggerid)
{
	//echo( "修正坐标=aa===" @ %triggerid @ " " @ %player.getposition( ) );
	%player=sptgetplayer(%playerID);
	//echo( %player @ "=============" );
	if (!isobject(%player))
		return;
	//echo( "修正坐标====" @ %triggerid @ " " @ %player.getposition( ) );
	%MapID=getsubstr(%triggerid,1,4);
	switch (%MapID)
	{
		case 1103:
			%TargetMap=0;
			%Pos="-68.0287 -105.253 121.718";
		default:
			if ($Transport_Xyz[%MapID] !$="")
			{
				%TargetMap=0;
				%Pos=$Transport_Xyz[%MapID];
			}
			else if ($Transport_Xyz[%triggerid] !$="")
			{
				%TargetMap=0;
				%Pos=$Transport_Xyz[%triggerid];
			}
			else
			{
				%TargetMap=1001;
				%Pos=$Transport_Xyz[1001];
			}
	}
	%Pos_X=getword(%Pos,0);
	%Pos_Y=getword(%Pos,1);
	%Pos_Z=getword(%Pos,2);
	%player.TransportObject(0,%TargetMap,%Pos_X,%Pos_Y,%Pos_Z);
}
//■■■■■■■■■■■登录时修正坐标■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色登录Or切换线程Or切换地图都要执行的命令■■■■■
//角色登录Or切换线程Or切换地图都要执行的命令（1登录，2切换线程，3切换地图）（内含功能开关配置，各种状态更新）
function SvrEvent_Login_SwitchLine_Transport(%Type,%Player)
{
	//成功切换地图后，给予相应的Buff以免出错
	%Player.SetSchBuff(1003);		//虚无BUFF
	%Player.SetSchBuff(1000);		//虚无BUFF
	%Player.AddBuff(390030003);	//无敌BUFF


	ServerOnSptAction(%Player.GetPlayerID(),%Type,17);//通讯客户端
	InfluenceDispose(%Player);//玩家势力处理

	DengLuZaiXianJiShi(%Player);//登录在线计时
	YaBiaoHuoDongChuLi(%Player);
	BingHuoShiLianChuLi(%Player);
	ShiJieLevelJiaCheng(%Player);//计算和添加当前的加成BUFF等级
	Refresh_FengMoCityDesignation(%Player); //封魔城称号清理
	XianShiQiangGou_SendClientKuCunNum(%Player);	//向客户端发送限时抢购的物品库存

	%Player.SendPlayerString(2,$SL_HuoDong,0);//发送活动配置开关
	SendPlayerStringToClient(%Player, 10);//发送运营活动配置开关
	sendNewXianShiQiangGouItemInfo(%Player, $SL_XianShiQiangGou_NewInfo);	//更新限时抢购物品信息
	%Player.SendPlayerString(11,$SL_JieMianKaiGuan,0);//发送界面配置开关


	//--判断是否需要进行排行榜奖励的计算------------
	if (GetAct(%Player,4100,1)!= 1  && %Player.Getlevel() >= 50)
	{
		%player.KLJRequestLastWeekRankReward();
		SetAct(%Player,4100,0,1);
	}
	//用Hotfix来修复功能，保证该函数在最后
	Hotfix_Login_SwitchLine_Transport(%Type,%Player);
}
//■■■■■■■■■■■角色登录Or切换线程Or切换地图都要执行的命令■■■■■


//■■■■■■■■■■■机器人登陆触发脚本■■■■■■■■■■■■■■■■■
function onFakeLogin(%Player)
{
	//添加物品到装备栏
	%Classes=%Player.GetClasses(0);

	//获取玩家等级
	%Leve=%Player.GetLevel();

	if (%Classes==1){ %ZuoQI_A=730050301; %Item="101016001	101016002	101016003	102016001	102016011	102016021	102026001	102026011	102026021	102036001	102036011	102036021	102046001	102046011	102046021	102055001	102055011	102055021	102066001	102066011	102066021	102076001	102076011	102076021	103016001	103016011	103016021	103026001	103026011	103026021	103036001	103036011	103036021"; }
	else if (%Classes==2){ %ZuoQI_A=730050401; %Item="101026001	101026002	101026003	102016002	102016012	102016022	102026002	102026012	102026022	102036002	102036012	102036022	102046002	102046012	102046022	102055002	102055012	102055022	102066002	102066012	102066022	102076002	102076012	102076022	103016002	103016012	103016022	103026002	103026012	103026022	103036002	103036012	103036022"; }
	else if (%Classes==3){ %ZuoQI_A=730050501; %Item="101046001	101046002	101046003	102016004	102016014	102016024	102026004	102026014	102026024	102036004	102036014	102036024	102046004	102046014	102046024	102055004	102055014	102055024	102066004	102066014	102066024	102076004	102076014	102076024	103016004	103016014	103016024	103026004	103026014	103026024	103036004	103036014	103036024"; }
	else if (%Classes==4){ %ZuoQI_A=730050601; %Item="101056001	101056002	101056003	102016005	102016015	102016025	102026005	102026015	102026025	102036005	102036015	102036025	102046005	102046015	102046025	102055005	102055015	102055025	102066005	102066015	102066025	102076005	102076015	102076025	103016005	103016015	103016025	103026005	103026015	103026025	103036005	103036015	103036025"; }
	else if (%Classes==5){ %ZuoQI_A=730050701; %Item="101036001	101036002	101036003	102016003	102016013	102016023	102026003	102026013	102026023	102036003	102036013	102036023	102046003	102046013	102046023	102055003	102055013	102055023	102066003	102066013	102066023	102076003	102076013	102076023	103016003	103016013	103016023	103026003	103026013	103026023	103036003	103036013	103036023"; }

	%Random=GetRandom(1,9);
	if (%Random > 6)
	{
		if (%Player.GetLevel()>=10)
			%ZuoQI=%ZuoQI_A;

		if (%ZuoQI > 0)
		{
			//添加坐骑
			GenerateMountInfo(%Player.GetPlayerID(),%ZuoQI);

			//召唤坐骑
			%Player.SpawnMount(0);
		}
	}

	%ItemNum=GetWordCount(%Item);
	for (%i=0; %i < %ItemNum; %i++)
	{
		%ItemID=GetWord(%Item,%i);
		%Player.AddItemToEquip(%ItemID,1);
	}

	if (%Player.GetLevel()>=70)
	{
		%Random=GetRandom(1,10);
		if (%Random==1)%ShiZhuang=102106004;	//凤翅紫金亮甲
		else if (%Random==2)%ShiZhuang=102106005;	//青曦时装
		else if (%Random==3)%ShiZhuang=102106006;	//紫岚灵裳
		else if (%Random==4)%ShiZhuang=102106007;	//曦凤龙袍
		else if (%Random==5)%ShiZhuang=102106008;	//伏龙至尊黄金甲
		else if (%Random==6)%ShiZhuang=102106010;	//秦朝帝王装
		else if (%Random==7)%ShiZhuang=102106011;	//结婚礼服
		else if (%Random==8)%ShiZhuang=102106012;	//锦绣江河装
		else if (%Random==9)%ShiZhuang=102106013;	//双龙长生装
		else if (%Random==10)%ShiZhuang=102106014;	//杨公镇国装
	}
	else if (%Player.GetLevel()>=21)
		%ShiZhuang=102106002;
	else
		%ShiZhuang=102106001;

	//添加时装
	%Player.AddItemToEquip(%ShiZhuang,1);
}

//■■■■■■■■■■■机器人登陆触发脚本■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色升级■■■■■■■■■■■■■■■■■■■■■■
function SvrEventLevelUp(%Player,%ScrLv)//玩家对象，玩家初始等级
{

	%PlayerID=%Player.GetPlayerID();
	%PlayerLv=%Player.GetLevel();

	//发送升级特效
	AddEffect(1,%Player,$SP_Effect[5]);

	//执行升级到特定等级的脚本触发事件
	for (%i=%ScrLv+1; %i<=%PlayerLv; %i++)
		SvrEventLevelUpEx(%Player,%i);
	
}

//玩家升级到固定等级需要执行的事件
function SvrEventLevelUpEx(%Player,%PlayerLv)
{
	%PlayerID=%Player.GetPlayerID();
	switch (%PlayerLv)
	{
		case 35:
			//AddMissionAccepted( %Player, 0, 30001 ); //生活技能一
			//AddMissionAccepted( %Player, 0, 30002 ); //生活技能二

			
			//case 45: LearnLivingSkill( %Player, 501031001 );//1级钓鱼
			//case 30: 
			//	if ( isLearnLivingSkill( %Player.GetPlayerID( ), 501011101 ) == 0 )	 //判断该生活技能是否已经学会,0没有学过,1学会
			//		LearnLivingSkill( %Player, 501011101 );//元宝挖矿技能

			//case 40: LearnLivingSkill( %Player, 501011002 );//2级挖矿
		case 50: //LearnLivingSkill( %Player, 501011003 );//3级挖矿	
			SetStrategyRecord(%Player,$StrategySubBtnSrc[2,2]);//攻略触发记录
			//case 60: LearnLivingSkill( %Player, 501011004 );//4级挖矿
			//case 70: LearnLivingSkill( %Player, 501011005 );//5级挖矿	
			//case 80: LearnLivingSkill( %Player, 501011006 );//6级挖矿
			//case 90: LearnLivingSkill( %Player, 501011007 );//7级挖矿	
			//case 100:LearnLivingSkill( %Player, 501011008 );//8级挖矿	
			//case 110:LearnLivingSkill( %Player, 501011009 );//9级挖矿
			//case 120:LearnLivingSkill( %Player, 501011010 );//10级挖矿	
	}

	SendShiJieLevelto1001(%PlayerID,%PlayerLv);//计算是否需要刷新全服最高等级
	ShiJieLevelJiaCheng(%Player);//重新计算当前世界等级经验加成系数

	if (Take_remainder(%PlayerLv, 5)==0)//每5级下发一次开关
		%Player.SendPlayerString(2, $SL_HuoDong, 0);//发送所有活动配置开关
}

//■■■■■■■■■■■角色升级■■■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■神兽升级■■■■■■■■■■■■■■■■■■■■■■
function OnServerAddPetLevel(%Player,%PetSlot)
{
	//发送升级特效
	AddEffect(1,%Pet,$SP_Effect[5]);
}
//■■■■■■■■■■■神兽升级■■■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色死亡■■■■■■■■■■■■■■■■■■■■■■
function SvrEventOnDisabled(%Player)
{
	%PlayerID=%Player.GetPlayerID();
	%PlayerName=%Player.GetPlayerName();

	%MapId = GetZoneID();
	//switch (%MapID)
	//{
	//	case 1119:PlayerOnDisabled_1119(%Player);
	//}
	//所有副本中的角色死亡事件都走这里
	%CopyMapID=%Player.GetLayerId();
	%CopymapDataID=SptGetCopymapDataId(%CopyMapID);
	%Trig=%Player.GetTriggerId();
	//echo("%CopymapDataID= ===" @ %CopymapDataID);
	switch (%CopymapDataID)
	{
		case 1304:
			SvrEventOnDisabled_1304(%Player,0);
		case 1307://鸿蒙试炼
			SvrEventOnDisabled_1307(%Player,0);
		case 1308://鸿蒙试炼
			SvrEventOnDisabled_1307(%Player,0);
		case 1309://鸿蒙试炼
			SvrEventOnDisabled_1307(%Player,0);
		case 1313:SvrEventOnDisabled_1313_1315(%Player);
		case 1314:SvrEventOnDisabled_1313_1315(%Player);
		case 1315:SvrEventOnDisabled_1313_1315(%Player);
			//case 1303:
			//	//复活玩家
			//	if ( %Player.GetDamageState( ) $= "Disabled" )
			//		%Player.SetDamageState( Enabled );
	}
	//低于15级死亡直接复活
	Schedule(3000,0,"PlayerLevel15_PlayerDisabled",%Player);
}

//低于15级死亡直接复活
function PlayerLevel15_PlayerDisabled(%Player)
{
	if (%Trig==810100200)//蓬莱禁地复活
	{
		if (%Player.GetDamageState() $="Disabled")
			%Player.SetDamageState(Enabled);
	}
	if (%Player.GetLevel() < 30)
	{
		//复活玩家
		if (%Player.GetDamageState() $="Disabled")
			%Player.SetDamageState(Enabled);

		//添加回血状态
		%Player.AddBuff(399020200,%Player,100);
		//复活保护
		%Player.AddBuff(399010001,%Player,1);
		//文字公告
		%Txt=$Get_Dialog_GeShi[31404] @ "您受到蓬莱之光的祝福，死亡后可马上原地复活。</t>";
		SendOneChatMessage($chatMsg_System,%Txt,%Player);
		SendOneScreenMessage(1,"您受到蓬莱之光的祝福！",%Player);
	}
}

//服务端 扣除原地复活道具
function expend_riseonthespot(%Player)
{
	if ((%Player.GetMetempsychosis()==0)&&(%Player.GetLevel() < 40))
		return 0;

	else if (%Player.GetLevel()>=40)
	{
		%Cs=%Player.GetOntheSpotRiseCount();

		if (%Cs > 0)
		{
			%Player.SetOntheSpotRiseCount(%CS-1);
			return 0;
		}
		else if (%Player.GetItemCount(105090008) > 0)
		{
			%ItemAdd=%Player.PutItem(105090008,-1);
			%ItemAdd=%Player.AddItem(5,1023);
			return 0;
		}
		else if (%Player.GetItemCount(105090009) > 0)
		{
			%ItemAdd=%Player.PutItem(105090009,-1);
			%ItemAdd=%Player.AddItem(5,1023);
			return 0;
		}
		else
			return 8105;
	}
}
//■■■■■■■■■■■角色死亡■■■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色复活■■■■■■■■■■■■■■■■■■■■■■
function IsUseScriptToSetEnabled(%Player)//判断原地复活功能是否转为走脚本处理
{
	//Putout("■■■角色复活前置判断■■" @ %Player @ "   " @ %Player.GetObjectName());
	%MapId = GetSubStr(GetZoneID(), 0, 4);
	%orgID = SptOrg_GetOrgID(%Player.GetPlayerID());		//家族ID
	if (%MapId == 1119 && $IsAttackCityWar_State_bActive == 1 && $NowGuardOrgID == %orgID)
		return 1;
	return 0;
}
function SvrSetEnabled(%Player)//脚本处理原地复活功能
{
	Putout("■■■脚本处理原地复活功能■■" @ %Player @ "   " @ %Player.GetObjectName());
	%MapId=GetSubStr(GetZoneID(), 0, 4);

	if (%MapId == 1119)
		PlayerSetEnabled_1119(%Player);//攻城战时，皇宫占领帮派复活处理
}
function SvrEventOnEnabled(%Player)//角色复活触发函数
{
	//Putout("■■■角色复活■■" @ %Player @ "   " @ %Player.GetObjectName());
	//获取地图ID
	%MapId=GetSubStr(GetZoneID(),0,4);

	//复活特效
	%Player.AddPacket(616005);

	%TriggerID=%Player.GetTriggerId();
	if (GetSubStr(%TriggerID,0,6) $="813330" && GetSubStr(%TriggerID,6,1)>=2)
		ChangePointForZXZZ(%Player,0);

	//特殊地图-特殊处理
	%CopyMapID=%Player.GetLayerId();	//获取副本层
	%CopymapDataID=SptGetCopymapDataId(%CopyMapID);	//获取副本DataID
	//switch(%CopymapDataID)
	//{
	//	case 1364:SvrEventOnEnabled_1302(%Player);
	//}

	if (%Buff_No > 0)
	{
		%Player.AddBuff(390030003);//无敌BUFF
		Schedule(0,0,"Relive_AddBuff",%Player);
	}
}
//■■■■■■■■■■■角色复活■■■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■角色升级前置判断■■■■■■■■■■■■■■■■■■
//%IsAuto = 0;手动
//%IsAuto = 1;自动

//经验不足时，点击升级触发  
function ClientClickLevelUp(%Player,%IsAuto)
{
	//echo("角色升级前置判断=A===" @ %IsAuto);
}

//经验满足时，点击升级前置触发
function CanPlayerLevelUp(%Player,%IsAuto)
{
	//echo("角色升级前置判断=B===" @ %IsAuto);
	%Lvev=%Player.GetLevel();
	%Zsleve=%Player.GetMetempsychosis();

	if (%Lvev>= 85)
		return 0;
	return 1;
}

function BeforPlayerAddLevel(%Player)//在addlevel时最后判断一次是否允许升级
{
	//echo("在addlevel时最后判断一次是否允许升级===" @ %player);
	return 85;
}
//■■■■■■■■■■■角色升级前置判断■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■特定过滤某些共享任务的脚本方法■■■■■■■■■■■
//特定过滤某些共享任务的脚本方法
function FilterShareMission(%Player)
{
	%count=%Player.GetShareMissionCount();	//获取玩家所有可以共享的任务总数
	%NeedDelCount=0;

	for (%i=0; %i < %count; %i++)
	{
		%Mid=%Player.GetShareMission(%i);	//获取指定位置的共享任务编号
		if (%Mid!=-1)
		{
			%bCanBeShared=GetMissionData(%Mid,$Mission_Data_Classes);//DATA中能否被共享选项
			if (%bCanBeShared==0)
			{
				%NeedDelMid[%NeedDelCount]=%Mid;
				%NeedDelCount++;
			}
		}
	}

	for (%i=0; %i < %NeedDelCount; %i++)
	{
		%Player.DelShareMission(%NeedDelMid[%i]);
	}
}
//■■■■■■■■■■■特定过滤某些共享任务的脚本方法■■■■■■■■■■■


//■■■■■■■■■■■道具鉴定脚本■■■■■■■■■■■■■■■■■■■■
function ManualIdentify(%Player,%index,%ItemID,%index1,%type)
{
	//鉴定符等级
	%JianDingItemLv=$JianDingFu[%ItemID,1];

	//判断鉴定符是否存在
	if (%JianDingItemLv !$="")
	{
		//目标道具等级
		%Itemlv=%Player.GetItemlimitlevel(%index);
		%Itemlv=%Player.GetItemlimitlevel(%index);

		//判断鉴定符鉴定符等级
		if (%Itemlv<=%JianDingItemLv)
		{
			//获取道具是否必定逆天
			%Biding=GetItemData(%Player.GetitemID(%index),23);
			if (HasBit(%Biding,30) > 0)
			{
				//逆天属性
				%JianDingItemJiLvMax=1000; %JianDingItemJiLvMin=-1000;

				//设置鉴定
				%Player.SetIdentify(%index,%JianDingItemJiLvMax,%JianDingItemJiLvMin,%index1,%type);

				return;
			}

			//记录获取
			%JianDingItemJiLv[0]=GetWord($JianDingFu[%ItemID,2],0)*100; //普通几率
			%JianDingItemJiLv[1]=GetWord($JianDingFu[%ItemID,2],1)*100; //精良几率
			%JianDingItemJiLv[2]=GetWord($JianDingFu[%ItemID,2],2)*100; //完美几率
			%JianDingItemJiLv[3]=GetWord($JianDingFu[%ItemID,2],3)*100; //逆天几率

			%Random=GetRandom(1,10000);
			for (%i=0; %i < 3; %i++)
			{
				%JianDingItemJiLv=%JianDingItemJiLv[%i]+%JianDingItemJiLv;
				if (%Random>=(10000-%JianDingItemJiLv))
				{
					if (%i==0){ %JianDingItemJiLvMax=990; %JianDingItemJiLvMin=-1000; }
					else if (%i==1){ %JianDingItemJiLvMax=999; %JianDingItemJiLvMin=-1000; }
					else if (%i==2){ %JianDingItemJiLvMax=1000; %JianDingItemJiLvMin=-1000; }

					//设置鉴定
					%Player.SetIdentify(%index,%JianDingItemJiLvMax,%JianDingItemJiLvMin,%index1,%type);


					return;
				}

			}
		}
		else
			%WhyNot="鉴定符等级太低，无法鉴定高级的目标物品";
	}
	else
		%WhyNot="鉴定符无法使用";

	if (%WhyNot !$="")
	{
		SendOneChatMessage($chatMsg_System,"<t>" @ %WhyNot @ "</t>",%Player);
		SendOneScreenMessage(2,%WhyNot,%Player);
	}
}
//■■■■■■■■■■■道具鉴定脚本■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■学习生活技能自动学会配方■■■■■■■■■■■■■■
function CallbackLearnLivingSkill(%Player,%livingSkillId)
{
	//学会生活技能触发任务旗标
	//%Mid = 0;
	//switch$( %livingSkillId )
	//{
	//	case "501031001":%Mid = 22002;
	//	case "501061001":%Mid = 22004;
	//	case "501051001":%Mid = 22006;
	//	case "501041001":%Mid = 22008;
	//	case "501021001":%Mid = 22010;
	//	case "501011001":%Mid = 22012;
	//}

	//if ( %Mid > 0 )
	//if ( %Player.IsAcceptedMission( %Mid ) )
	//if ( %Player.GetMissionFlag( %Mid, 8100 ) == 0 )
	//	%Player.SetMissionFlag( %Mid, 8100, 1, true );

	////学会生活技能后给予部分配方
	//for ( %i=1; %i<=$LivingSkillId_Pres_Add[ %livingSkillId ]; %i++ )
	//	AddPrescription( %Player, $LivingSkillId_Pres_Add[ %livingSkillId, %i ] );
	if ($LivingSkillIdDesignation[%livingSkillId] !$="")
	{

		if (!%Player.sptIsDesignationExist($LivingSkillIdDesignation[%livingSkillId]))
			%Player.AddDesignation($LivingSkillIdDesignation[%livingSkillId]);//添加称号
	}
	//if ($LivingSkillIdAchRecord[%livingSkillId] !$="")
	//	AddAchievementWatch(%Player,1,$LivingSkillIdAchRecord[%livingSkillId],1);//记录成就
}

//■■■■■■■■■■■学习生活技能自动学会配方■■■■■■■■■■■■■■

//■■■■■■■■■■■服务器定时刷新各种活动■■■■■■■■■■■■■■■
function SL_S_Hotfix()
{
	//重新加载S_Hotfix.cs脚本文件
	Exec("./SL_S_Hotfix.cs");//在线修复脚本
}

function CheckServerTime()
{
	%MapID=GetZoneID();

	//重新加载S_Config.cs脚本文件
	Exec("./SL_S_Config.cs");

	//稍缓再加载S_Hotfix.cs在线修复脚本文件
	Schedule(GetSubStr(%MapID,0,4)*10,0,"SL_S_Hotfix");

	//获取基础信息
	%Time=GetLocalTime();
	%YY=GetWord(%Time,0);//年
	%MM=GetWord(%Time,1);//月
	%DD=GetWord(%Time,2);//日
	%H=GetWord(%Time,3);//小时
	%M=GetWord(%Time,4);//分钟
	%S=GetWord(%Time,5);//秒

	$NowServerTime1=%YY*10000+%MM*100+%DD;
	$NowServerTime2=Get2K_To_Day($NowServerTime1);
	$NowServerTime3=%H*60+%M;
	SetPlayGameReturnTime(%YY,%MM,%DD,%H,%M,%S); //倒计时清除的值列表
	Bactive_PlayGame(%YY,%MM,%DD,%H,%M,%S);//计算所有的常置活动开关
	Bactive_YunYingPlayGame(%YY,%MM,%DD,%H,%M,%S);//计算所有的运营活动开关
	QunYingHuiJu_StytemMsg(%YY,%MM,%DD,%H,%M,%S);//群英汇聚
	CopyMap_XuanWuMen_StytemMsg(%YY,%MM,%DD,%H,%M,%S);//时空裂痕
	//Calculation_Probability_KuangMai( );//刷新矿脉产出的公式表
	GetAll_SrcNumbers();//计算所有的SRC值,建立索引表
	CopyMap_HuanJingZhengBa_StytemMsg(%YY,%MM,%DD,%H,%M,%S);//幻境争霸
	HuoDong_ShiJieBoss_Create(%YY,%MM,%DD,%H,%M,%S);//世界BOSS刷新
	YunXianJie_Msg(%YY,%MM,%DD,%H,%M,%S);//鸿蒙试炼活动
	YaBiaoHuoDong_Information(%YY,%MM,%DD,%H,%M,%S);//押镖活动
	DiaoYuHuoDong_StytemMsg(%YY,%MM,%DD,%H,%M,%S);//钓鱼活动
	LingJingWuDaoHuoDongStart(%YY,%MM,%DD,%H,%M,%S);//聆经悟道
	ShouZuoLunJingHuoDongStart(%YY,%MM,%DD,%H,%M,%S);//首座论经
	GetShiJieZuiGaoLevel();//获取全服最高等级
	DelServerRenShuTongJi(%YY,%MM,%DD,%H,%M,%S);//服务器活跃人数清除
	RecordGemRecastStoneChongZhu();//更新宝石重铸的概率表
	DaoJianShenYu_StytemMsg(%YY,%MM,%DD,%H,%M,%S);//刀剑神域
	CaoBaoTu_YaoWangNumBer(%YY,%MM,%DD,%H,%M,%S);//计算藏宝图的妖王数量限制
	TeHuiTeXiaoShuaXin(%YY,%MM,%DD,%H,%M,%S);//0 6 12 18点时刷新特惠按钮的特效
	WangXianGu_YunYouYinShi_ShuaXin(%YY,%MM,%DD,%H,%M,%S);//望仙谷--云游隐士刷新
	XianTongJiangLin(%YY,%MM,%DD,%H,%M,%S);//运营活动 仙童降临
	Refresh_CitityWar(%YY, %MM, %DD, %H, %M, %S); //刷新城战信息
	XianShiQiangGou_SetKuCunNum();	//开服时设置限时商店库存
	Refresh_CityOwner();//刷新城主信息
	//过一分钟后再执行时间检查
	%Time=60;
	//执行特殊循环
	Cancel($CheckServerTime);
	$CheckServerTime=Schedule(%Time @ "000",0,"CheckServerTime");

}

//■■■【地图双倍－开启公告】■■■
function DiTuShuangBei_Enter_Hour(%H,%M,%S)
{

}
//■■■■■■■■■■■服务器定时刷新各种活动■■■■■■■■■■■■■■■


//■■■■■■■■■■■发送任务特效■■■■■■■■■■■■■■■■■■■■
function MouseHelp(%Player,%Type,%Index,%Num)
{

	switch (%Type)
	{
		case 1:
			//任务接交触发的指引
			//Index = 任务编号
			//Num = 1准备接任务，2接任务，3交任务

		case 2:

	}
}
//■■■■■■■■■■■发送任务特效■■■■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■系统邮件事件处理脚本■■■■■■■■■■■■■■■■
function SystemSendMailToPlayer(%Player,%Type)
{
	%Item=0;
	%ItemNum=0;
	%Title="";

	%Tab3="<b/>" @ $Get_Dialog_GeShi[31206] @ "友情提示：</t><b/>";
	%Tab4=$Get_Dialog_GeShi[12201];//淡黄色大字
	%Tab5=$Get_Dialog_GeShi[31206];//红色字体

	switch (%Type)
	{
		case 6: %Title="上线送礼（打卡奖励）";
			%Item=105100031;
			%ItemNum=1;
			%Txt="<t>为了感谢您支持《昆仑决》，我们特地为您送上【</t>" @ $Get_Dialog_GeShi[31203] @ GetItemData(%Item,%ItemNum) @ "</t><t>】，请注意查收。</t><b/><b/><t>点击下方【</t>" @ $Get_Dialog_GeShi[31206] @ "全部收取</t><t>】按钮即可收取邮件内的道具</t>";

		case 7: %Title="上线送礼（周奖励）";
			%Item=105100032;
			%ItemNum=1;
			%Txt="<t>为了感谢您支持《昆仑决》，我们特地为您送上【</t>" @ $Get_Dialog_GeShi[31203] @ GetItemData(%Item,%ItemNum) @ "</t><t>】，请注意查收。</t><b/><b/><t>点击下方【</t>" @ $Get_Dialog_GeShi[31206] @ "全部收取</t><t>】按钮即可收取邮件内的道具</t>";

		case 8: %Title="上线送礼（月奖励）";
			%Item=105100033;
			%ItemNum=1;
			%Txt="<t>为了感谢您支持《昆仑决》，我们特地为您送上【</t>" @ $Get_Dialog_GeShi[31203] @ GetItemData(%Item,%ItemNum) @ "</t><t>】，请注意查收。</t><b/><b/><t>点击下方【</t>" @ $Get_Dialog_GeShi[31206] @ "全部收取</t><t>】按钮即可收取邮件内的道具</t>";
		case 24: //徒弟出师礼包
			%Title="徒弟出师礼包";
			%Item=105101601;
			%ItemNum=1;

			%Iten_ID="<l i='105101601' t='itemid'/>";
			%Txt="<t>您已成功出师，获得了</t>"@%Iten_ID@"<t>奖励，请在邮件附件中查收。</t>";
	}

	%Txt=$Get_Dialog_GeShi[31210] @ %Txt @ "</t>";

	if (%Title !$="")
		SptMail_Send(%Player.GetPlayerID(),%Item,%ItemNum,0,0,%Title,%Txt);
}
//征友平台邮件
function sendMailToPlayerEx(%RecverId,%typeNum,%paraMsg)
{
	%paraMsg_MZ=GetWord(%paraMsg,0);
	%paraMsg_ID=GetWord(%paraMsg,1);

	switch (%typeNum)
	{
		case 1:
			%title="申请离婚通知";
			%szMsg="<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t><t>向您提出离婚请求，请在</t>"@ %paraMsg_ID @ "<t>之前到月老处确认，逾期作为接受离婚请求处理。</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 2:
			%title="离婚通知";
			%szMsg="<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>与您解除姻缘关系</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 3:
			%title="强制离婚通知";
			%szMsg="<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>与您强制解除婚姻关系</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 4:
			%title="撤消离婚通知";
			%szMsg="<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>拒绝与您解除姻缘关系</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 5:
			%title="神兽繁殖完成通知";
			%szMsg="恭喜，您的神兽已经完成繁殖，请前来领取";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 6://征友界面拜师提醒邮件（徒弟方）
			%title="拜师提醒";
			%szMsg="<t>您向</t>"@"<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>拜师请求已经发送</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 7://征友界面拜师提醒邮件（师傅方）
			%title="拜师提醒";
			%szMsg="<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>想要拜您为师，您可以点击姓名与其联系。</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 8://征友界面求婚提醒邮件（求婚方）
			%title="求婚提醒";
			%szMsg="<t>您向</t>"@"<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>求婚请求已经发送</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 9://征友界面求婚提醒邮件（响应方）
			%title="求婚提醒";
			%szMsg="<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>向你进行了求婚，您可以点击姓名与其联系。</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 10://征友界面求贤提醒邮件（请求方）
			%title="求贤提醒";
			%szMsg="<t>您向</t>"@"<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>求贤请求已经发送</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 11://征友界面求贤提醒邮件（受理方）
			%title="求贤提醒";
			%szMsg="<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>想要加入您的帮派，您可以点击姓名与其联系。</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 12:
			%FFF_A="<l i='810010100 124.213 2.14262 100.059' t='path'/>";
			%FFF_B="<l i='105101600' t='itemid'/>";

			//【出师贺礼】判断
			if ((SptGetFirendValue(%paraMsg_ID,%RecverId)>=500)&&(SptGetPlayer(%paraMsg_ID).GetFlagsByte(37)>=2))
			{
				%Item=105101600;
				%ItemNum=1;
				%title="出师通知";
				%szMsg="<t>您的徒弟</t>"@"<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>已经出师。</t><b/><t>获得经验奖励。</t>"@%FFF_A@"<t>宁道奇处使用师德兑换。</t><b/><t>您获得了</t>"@%FFF_B@"<t>奖励，请在邮件附件中查收。</t>";
			}
			else
			{
				%Item=0;
				%ItemNum=0;
				%title="出师通知";
				%szMsg="<t>您的徒弟</t>"@"<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>已经出师了。</t><b/><t>获得经验奖励。</t>"@%FFF_A@"<t>宁道奇处使用师德兑换。</t><b/><t>很遗憾，未达到获得</t>"@%FFF_B@"<t>的要求，请下次继续努力！</t>";
			}

			//发送邮件
			SptMail_Send(%RecverId,%Item,%ItemNum,0,0,%title,%szMsg);

		case 13:
			%title="开除通知";
			%szMsg="<t>你的师傅</t>"@"<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>将你开除了</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 14:
			%title="背叛通知";
			%szMsg="<t>你的徒弟</t>"@"<l i='"@ %paraMsg_MZ @ " "@ %paraMsg_ID @ "' t='name' /></t>"@"<t>脱离了师门</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,%szMsg);

		case 15:
			%title="安全锁强行解除确认";
			if (%paraMsg < 60)
				%Time="[" @ %paraMsg_MZ @ "]秒";
			else if (%paraMsg < 3600)
				%Time="[" @ mCeil(%paraMsg_MZ/60) @ "]分钟";
			else if (%paraMsg < 86400)
				%Time="[" @ mCeil(%paraMsg_MZ/3600) @ "]小时";
			else
				%Time="[" @ mCeil(%paraMsg_MZ/86400) @ "]天";

			%A="<c cid='toPetIdentify' cmd='\"OpenAnQuanMaHtml();\",\"<t n='12' u='0xbfff00ff' c='0x00b0f0ff' o='0x010101ff'>修改密码</t>\",\"GuiMissionTraceButtonProfile6\"' cf='createButton' />";
			%B="<c cid='toPetIdentify' cmd='\"OpenSecondPwdCheckWnd();\",\"<t n='12' u='0xbfff00ff' c='0x00b0f0ff' o='0x010101ff'>输入安全锁密码</t>\",\"GuiMissionTraceButtonProfile6\"' cf='createButton' />";
			%szMsg="<t>您的安全锁系统启用了【</t>" @ $Get_Dialog_GeShi[31204] @ "强行解除密码</t><t>】的功能，强制解锁确认时间剩余</t>" @ $Get_Dialog_GeShi[31203] @ %Time @ "</t><t>，时间到后，再次点击【</t>" @ $Get_Dialog_GeShi[31204] @ "强行解除</t><t>】按钮，即可清除安全锁密码</t><b/><b/>" @
				"<t>如果这不是您本人的操作，那么您的游戏密码很有可能已经泄漏，建议您进行</t>" @ %A @ "<t>，同时</t>" @ %B @ "<t>，即可取消强行解除密码功能</t>";
			SptMail_Send(%RecverId,0,0,0,0,%title,$Get_Dialog_GeShi[31201] @ %szMsg @ "</t>");

		default: return;
	}
}

//强制离婚扣除道具脚本
function ServerForceDivorce(%Player)
{
	return "105102572";
}
//■■■■■■■■■■■系统邮件事件处理脚本■■■■■■■■■■■■■■■■


//■■■■■■■■■■■验证码脚本接口■■■■■■■■■■■■■■■■■■■
function SvrIdCodeOk(%Player)
{
	%YZM=%Player.GetActivity(2200); 	//读取验证码值
	%BS=GetWord(%YZM,0);  						//读取验证码怪物倍数
	%SL=GetWord(%YZM,1);  		  			//读取验证码怪物数量

	SendOneChatMessage($chatMsg_System,$Get_Dialog_GeShi[31204] @ "验证成功，您获得了一些系统奖励</t>",%Player);
	//%Player.AddMoney( 150 + %Player.GetLevel( ) * 3, 2, 5, 1001 );
}

//SvrIdCodeError( %Player, %errCount )	验证失败，参数2为失败次数
function SvrIdCodeError(%Player,%ErrorCount)
{
	switch (%ErrorCount)
	{
		case 1:
			SendOneChatMessage($chatMsg_System,"验证错误，请重新选择，您还有2次机会",%Player);
		case 2:
			SendOneChatMessage($chatMsg_System,"验证错误，请重新选择，您还有1次机会",%Player);
		case 3:
			SendOneChatMessage($chatMsg_System,"验证错误，您将会被关押至【恶人牢狱】",%Player);
			SptIdCodeClose(%Player.GetPlayerID());	//关闭验证码界面
			%Player.SetSchBuff(20023017);//服刑Buff
			%Player.AddSchBuff(20023017,7200-1800);//半小时服刑Buff
			%Player.SetSchBuff(40001017);//入狱原因：验证3次失败，入狱
			SptCopymap_RemovePlayer(%Player.GetPlayerID(),"216.557 203.926 101.452",1119);//传送至监狱
	}
}

//SvrIdCodeTimeout( %Player );	验证超时
function SvrIdCodeTimeout(%Player)
{
	SendOneChatMessage($chatMsg_System,$Get_Dialog_GeShi[31206] @ "验证超时，您将会被关押至【恶人牢狱】",%Player);
	SptIdCodeClose(%Player.GetPlayerID());	//关闭验证码界面
	%Player.SetSchBuff(20023017);//服刑Buff
	%Player.AddSchBuff(20023017,7200-1800);//半小时服刑Buff
	%Player.SetSchBuff(40001018);//入狱原因：验证码超时，入狱
	SptCopymap_RemovePlayer(%Player.GetPlayerID(),"216.557 203.926 101.452",1119);//传送至监狱
}
//■■■■■■■■■■■验证码脚本接口■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■上缴道具神兽成功后回调函数■■■■■■■■■■■■■
function inspectMissionSubmitItem(%Player,%MissionID,%ItemID)
{
	//对话内容
	%FuncName="inspectMissionSubmitItem_"@ %MissionID;

	//发送isFunction
	if (isFunction(%FuncName))
		%FuncName=eval(" return " @ %FuncName @ "(" @ %Player @ "," @ %MissionID @ "," @ %ItemID @ ");");
	return %FuncName;
}

function OnMissionSubmitItem(%Player,%MissionID,%ItemID)
{
	//对话内容
	%FuncName="OnMissionSubmitItem_"@ %MissionID;

	//发送isFunction
	if (isFunction(%FuncName))
		eval(%FuncName @ "(" @ %Player @ "," @ %MissionID @ "," @ %ItemID @ ");");
}

//十二生肖活动上缴界面触发
function inspectMissionSubmitItem_10000(%Player,%MissionID,%ItemID){ return 1; }
function inspectMissionSubmitItem_32555(%Player,%MissionID,%ItemID){ return 1; }
function inspectMissionSubmitItem_32556(%Player,%MissionID,%ItemID){ return 1; }
function inspectMissionSubmitItem_32557(%Player,%MissionID,%ItemID){ return 1; }
function inspectMissionSubmitItem_32558(%Player,%MissionID,%ItemID){ return 1; }

//七夕活动上缴
function inspectMissionSubmitItem_32600(%Player,%MissionID,%ItemID){ return 1; }
function inspectMissionSubmitItem_32601(%Player,%MissionID,%ItemID){ return 1; }//跑环上缴

function OnMissionSubmitItem_32601(%Player,%MissionID,%ItemID)
{
	%player.SetMissionFlag( 24108, 1300, 1 );
	%player.UpdateMission( 24108 );
}
function OnMissionSubmitItem_32600(%Player, %MissionID, %ItemID)
{
	%bianqian_right="";
	for(%s=1; %s<=56; %s++)
	{
		if(%player.getitemcount($dtcq_Love_itemid[$dtcq_Love_note_num[%s]])>0)
		{
			%player.putitem($dtcq_Love_itemid[$dtcq_Love_note_num[%s]], -1);
			if(%player.additem())
			{
				%bianqian_right = $dtcq_Love_note[$dtcq_Love_note_num[%s]];
				break;
			}
		}
	}
	for(%i=1; %i<=3; %i++)
	{
		for(%j=1; %j<=2; %j++)
		{
			if(%itemid==$qixi_Destiny_store[%i, %j])
			{
				%player.SetPutItemProduceName(%player.PutItem($qixi_Destiny_item[%i, %j], 1), %bianqian_right @ " -- " @ %player.GetPlayerName());
				%player.additem();
				%Txt="<l i='" @ %player.GetPlayerName() @ " " @ %player.GetPlayerID() @ "' t='name' />" @"<t>参加七夕活动,在月老处兑换了一个</t>" @ "<l i='" @ $qixi_Destiny_item[%i, %j] @ "' t='itemid'/>" @ "<t>，真是要逆天了!</t>";
				SendOneLineMessage($Get_Dialog_GeShi[31219] @  %Txt @ "</t>");
				if(%i>=2)
				{
					%Txt=$Get_Dialog_GeShi[60001] @ "『" @ %player.GetPlayerName() @ "』</t>" @ $Get_Dialog_GeShi[60000] @ "在月老处兑换获得了</t>" @ "<l i='" @ $qixi_Destiny_item[%i, %j] @ "' t='itemid'/>" @ $Get_Dialog_GeShi[60000] @ "，真是羡煞旁人！</t>";
					SendOneLineMessage(%Txt, $chatMsg_Type_Normal2);
				}
			}
		}
	}
}
//神兵任务
function OnMissionSubmitItem_32530(%Player,%MissionID,%ItemID){ AddMissionFlag(%Player,%MissionID,1300,0); }
function OnMissionSubmitItem_32531(%Player,%MissionID,%ItemID){ AddMissionFlag(%Player,%MissionID,1300,0); }
//神石升级
function inspectMissionSubmitItem_32602(%Player,%MissionID,%ItemID){ return 1; }
function inspectMissionSubmitItem_32603(%Player,%MissionID,%ItemID){ return 1; }
function OnMissionSubmitItem_32602(%Player,%MissionID,%ItemID) { Gem_turned_over_upgrade(%Npc,%itemid,%Player,0); }
function OnMissionSubmitItem_32603(%Player,%MissionID,%ItemID) { Gem_turned_over_upgrade(%Npc,%itemid,%Player,1); }
//■■■■■■■■■■■上缴道具神兽成功后回调函数■■■■■■■■■■■■■

//■■■■■■■装备鉴定、进阶、刻铭、打孔、镶嵌操作完成后回调■■■■■■■
function EquipUpdateMission(%Player,%type,%itemid,%index,%issucceed)
{
	%Succeed=false;
	if (%type==0)  //装备鉴定
	{
	}
	else if (%type==1)//装备进阶
	{
		%Player.AttachItemObject( ItemObj, 1, %index );
		%Strengthens=ItemObj.EquipStrengthens;

	}
	else if (%type==2) //装备刻铭
	{
		%FamilyID=%Player.GetFamily( );
		if (%FamilyID==0)
			return false;
		else
		{

		}
	}
	else if (%type==3) //装备打孔
	{
	}
	else if (%type==4)//装备镶嵌
	{
	}
	return %Succeed;
}

//■■■■■■■装备鉴定、进阶、刻铭、打孔、镶嵌操作完成后回调■■■■■■■

//■■■■■■■■■■■神兽进阶品阶触发■■■■■■■■■■■■■■■■■■
function PetIncreaseInsightSucceed(%Player,%Psyche)
{
}
//■■■■■■■■■■■神兽进阶品阶触发■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■队伍操作■■■■■■■■■■■■■■■■■■■■■■
//队伍发屏幕消息
function SendScreenMessageForTeam(%Type,%Msg,%Player)
{
	%PlayerID=%Player.GetPlayerID();

	if (!SvrIsMyselfHasTeam(%PlayerID))//没队伍
		SendOneScreenMessage(%Type,%Msg,%Player);
	else
	{
		%TeamList=SvrGetTeammate(%PlayerID,256);//队伍列表

		for (%i=0; %i<GetWordCount(%TeamList); %i++)
		{
			%Teammate=GetWord(%TeamList,%i);

			if (!isobject(%Teammate))//不在附近的话就再见了
				continue;

			SendOneScreenMessage(%Type,%Msg,%Teammate);
		}
	}
}

//队伍发聊天框消息
function SendChatMessageForTeam(%Type,%Msg,%Player)
{
	%PlayerID=%Player.GetPlayerID();

	if (!SvrIsMyselfHasTeam(%PlayerID))//没队伍
		SendOneChatMessage(%Type,%Msg,%Player);
	else
	{
		%TeamList=SvrGetTeammate(%PlayerID,256);//队伍列表

		for (%i=0; %i<GetWordCount(%TeamList); %i++)
		{
			%Teammate=GetWord(%TeamList,%i);

			if (!isobject(%Teammate))//不在附近的话就再见了
				continue;

			SendOneChatMessage(%Type,%Msg,%Teammate);
		}
	}
}

//队伍设置Missionflag
function SetMissionFlagForTeam(%Player,%Mid,%FlagIndex,%Val,%bUpdate)
{
	%PlayerID=%Player.GetPlayerID();

	if (!SvrIsMyselfHasTeam(%PlayerID))//没队伍
	{
		if (%Player.IsAcceptedMission(%Mid)&&%Player.GetMissionFlag(%Mid,%FlagIndex)!=%Val)
			%Player.SetMissionFlag(%Mid,%FlagIndex,%Val,%bUpdate);
	}

	else
	{
		%TeamList=SvrGetTeammate(%PlayerID,256);//队伍列表

		for (%i=0; %i<GetWordCount(%TeamList); %i++)
		{
			%Teammate=GetWord(%TeamList,%i);

			if (!isobject(%Teammate))//不在附近的话就再见了
				continue;

			if (%Teammate.IsAcceptedMission(%Mid)&&%Teammate.GetMissionFlag(%Mid,%FlagIndex)!=%Val)
			{
				//每个接受了任务并且需要设置旗标的队友
				%Teammate.SetMissionFlag(%Mid,%FlagIndex,%Val,%bUpdate);
			}
		}
	}
}

//队伍传送
function GoToNextMapForTeam(%Player,%MapInfo,%Back) //参数请参考gotonextmap
{
	%PlayerID=%Player.GetPlayerID();

	if (!SvrIsMyselfHasTeam(%PlayerID))//没队伍
	{
		//GoToNextMap(%Player,%MapInfo,%Back);
	}
	else
	{
		%TeamList=SvrGetTeammate(%PlayerID,256);//队伍列表

		for (%i=0; %i<GetWordCount(%TeamList); %i++)
		{
			%Teammate=GetWord(%TeamList,%i);

			if (!isobject(%Teammate))//不在附近的话就再见了
				continue;

			//GoToNextMap(%Teammate,%MapInfo,%Back);
		}
	}
}

//队伍加buff
function AddBuffForTeam(%Player,%BuffID,%From) //参数请参考gotonextmap
{
	%PlayerID=%Player.GetPlayerID();

	if (!SvrIsMyselfHasTeam(%PlayerID))//没队伍
		%Player.AddBuff(%BuffID,%From);
	else
	{
		%TeamList=SvrGetTeammate(%PlayerID,256);//队伍列表

		for (%i=0; %i<GetWordCount(%TeamList); %i++)
		{
			%Teammate=GetWord(%TeamList,%i);

			if (!isobject(%Teammate))//不在附近的话就再见了
				continue;

			%Teammate.AddBuff(%BuffID,%From);
		}
	}
}

//队伍加特效
function AddPacketForTeam(%Player,%PacketID) //参数请参考gotonextmap
{
	%PlayerID=%Player.GetPlayerID();

	if (!SvrIsMyselfHasTeam(%PlayerID))//没队伍
		%Player.AddPacket(%PacketID);
	else
	{
		%TeamList=SvrGetTeammate(%PlayerID,256);//队伍列表

		for (%i=0; %i<GetWordCount(%TeamList); %i++)
		{
			%Teammate=GetWord(%TeamList,%i);

			if (!isobject(%Teammate))//不在附近的话就再见了
				continue;

			%Teammate.AddPacket(%PacketID);
		}
	}
}

//得队伍平均等级
function GetLevelForTeam(%Player)
{
	%PlayerID=%Player.GetPlayerID();
	%Team=SvrGetTeammate(%PlayerID,256);
	%TeammateNum=GetWordCount(%Team);
	%TotalLv=0;
	for (%TeamIndex=0; %TeamIndex<GetWordCount(%Team); %TeamIndex++)
	{
		%Teammate=GetWord(%Team,%TeamIndex);
		if (isobject(%Teammate))//队友不在身边 不予计算
			%TotalLv+=%Teammate.GetLevel();
		else
			%TeammateNum--;
	}

	if (%TeammateNum > 0)
		return mFloor(%TotalLv/%TeammateNum);
	else
		return 0;
}
//■■■■■■■■■■■队伍操作■■■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■获取目标朝向的反面■■■■■■■■■■■■■■■■■
function GetPosition_Reverse(%Player)
{
	//说明：想要刷出的怪物永远面对着玩家，即用该函数计算怪物的朝向
	//%CX_2 = GetPosition_Reverse(%Player);
	%CX=%Player.Rotation;
	%CX_1=GetWord(%CX,2); 	//玩家坐标第一位
	%CX_2=GetWord(%CX,3); 	//玩家坐标第二位
	if (%CX_1!=1){ %CX_2=(360-%CX_2)-180; }
	else
	{
		%CX_2=%CX_2-180;
		if (%CX_2 < 0){ %CX_2=360+%CX_2; }
	}

	return %CX_2; //返回怪物朝向
}
//■■■■■■■■■■■获取目标朝向的反面■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■变大变大变大■■■■■■■
function BBBBBB_0(%Player)
{
	%X=1;
	%Y=1;
	%Z=1;
	Schedule(100,0,"BBBBBB_2",%X,%Y,%Z,%Player,%i);
}


function BBBBBB_2(%X,%Y,%Z,%Player,%i)
{
	if (%i < 50)
	{
		%Player.SetScale(%X @ " " @ %Y @ " " @ %Z);
		Schedule(100,0,"BBBBBB_2",%X+0.02,%Y+0.02,%Z+0.02,%Player,%i+1);
	}
	else{ %Player.SetScale("1 1 1"); }
}

//■■■■■■■■■■■善恶值触发事件■■■■■■■■■■■■■■■■■■■
function TriggerIncreasePKValue(%Player,%Pkvalue)
{
	//echo("善恶值触发事件==" @ %player @ " " @ %Pkvalue);
}
function RefreshServerPKColor(%player,%pkcolor)//%pkcolor 0 白名 1 黄名 >=2 红名
{
	//echo("善恶值触发事件==" @ %player @ " " @ %pkcolor);
	InfluenceDispose(%Player);
}
//■■■■■■■■■■■善恶值触发事件■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■玩家死亡善恶值符合触发脚本■■■■■■■■■■■■■
function SongJianYu(%Player)
{
	Schedule(2000,0,"JianYu",%Player);
}

function JianYu(%Player)
{
	%Player.SetDamageState(Enabled);	//复活玩家
	%Player.SetFlagsByte(8,1);				//设置标示
	%Player.SetSchBuff(40001019);			//入狱原因：善恶值过高，入狱
	SptCopymap_RemovePlayer(%Player.GetPlayerID(),"216.557 203.926 101.452",1119);//传送至监狱
}
//■■■■■■■■■■■玩家死亡善恶值符合触发脚本■■■■■■■■■■■■■

//■■■■■■■■■■■跨地图执行脚本■■■■■■■■■■■■■■■■■■■
function OpenFamilyBattle()
{

}
//■■■■■■■■■■■跨地图执行脚本■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■加油上BUFF设置■■■■■■■■■■■■■■■■■■■
function serverCheerAddBuff(%Player,%buffId)
{

}

//■■■■■■■■■■■加油上BUFF设置■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■服务器开启时自动执行■■■■■■■■■■■■■■■■
function OnServerOpen()
{
	if ($bServerOpen==1)
		return;
	$bServerOpen=1;
	//echo("=========服务器开启时自动执行==========");
	%MapID=GetSubStr(GetZoneID(),0,4);
	$CurrentLineId=%LineID=GetCurrentLineId();//线程ID
	%LeiXin=%LineID @ %MapID;//全服事件 BOSS
	if ($SL_ShiJieBoss_bActive[%ZoneID] !$="")
		SetServerSystemEvent(%LeiXin,0,0);//全服事件 BOSS重置

	//服务器定时检查活动刷新
	CheckServerTime();	//0秒执行，统一触发类型

	XuanShangJiXiongMissionIfonRecord();//刷新悬赏任务统计信息
	GetShiJieZuiGaoLevel();//获取全服最高等级
	XinShouRenWu_spnewnpc(); //新手任务NPC刷新
	// XinShouRenWu_spnewcj( );//新手任务采集物刷新
	SetStrategyBtnText();//加载攻略界面的内容
	//WangXianGuRenWu_spnewcj( );//望仙谷任务采集物刷新
	SptOrg_RequestAttackCityOrgIdinfo();//获取攻城信息
	switch (%MapID)
	{
		case 1119:
			$YaBiaoHuoDong_TimeRecord[1] = "00:00";//充值橙色镖车的刷新CD
			AttackCityWarStates(2);//刷新常置NPC
	}
}

//10秒后执行
Schedule(10*1000,0,"OnServerOpen");

//■■■■■■■■■■■服务器开启时自动执行■■■■■■■■■■■■■■■■


//■■■■■■■■■■■■离线经验奖励领取■■■■■■■■■■■■■■■■■
function SptDrawEncourageExp(%Player)
{
	if ((%Player.GetLevel() < 40)&&(%Player.GetMetempsychosis()==0))
	{
		SendOneScreenMessage(2,"您不足40级，无法领取离线经验",%Player);
		return;
	}

	//内丹经验
	%Exp=%EncourageExp=%Player.GetEncourageExp();
	//剩余经验
	%Exp_Surplus=(%Player.GetLevelExp()*3)-%Player.GetExp();

	//若添加经验超过剩余经验，则只添加剩余。
	if (%Exp > %Exp_Surplus)
	{
		%Exp=%Exp_Surplus;
		SendOneScreenMessage(2,"您的经验值已满，请升级后在领取",%Player);
	}
	else
		SendOneScreenMessage(1,"您已成功领取离线经验",%Player);

	//添加玩家经验
	%Player.AddExp(%Exp);

	//修改经验池经验
	%Player.SetEncourageExp(%EncourageExp-%Exp);

}
//■■■■■■■■■■■■离线经验奖励领取■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■玩家被玩家击败触发■■■■■■■■■■■■■■■■■
function Player::onDeathCast(%Player,%Killer,%DeathType)//%DeathType 1 切磋 0 击败
{
	//echo("%DeathType===" @ %DeathType);
	if (%DeathType==1)
		return;
	%Map=GetZoneID();
	%MapID=GetSubStr(%Map,0,4);
	%CopyMapID=%Player.GetLayerID();
	%CopymapDataID=SptGetCopymapDataId(%CopyMapID);

	if (%Killer.GetClassName() $="PetObject")
		%KillerMaster=%Killer.GetMaster();
	else if (%Killer.GetClassName() $="Player")
		%KillerMaster=%Killer;
	else
		return;

	//%Player = 被击败
	if (%Player.GetBuffCount(30741,1)>=1)//自爆技能
	{
		%SkillLevel=%Player.GetSkillLevel(21021);
		if (%SkillLevel > 0)
			%Killer.AddBuff(307430000+%SkillLevel,%Killer,1);
		%Player.AddPacket(112105);
		%Player.AddBuff(307410001,%Player,-1);
	}

	if (%Player.GetDamageState() $="Disabled")//死亡状态
		if (!%Player.IsSchBuff(40001020))
		{
			%PlayerID=%Player.GetPlayerID();//死者ID
			%KillerID=%Killer.GetPlayerID();//杀手ID

			%Kill_XYZ=%Player.GetPosition();	//玩家死亡坐标
			%AreaID=%Player.GetTriggerId();		//玩家死亡区域
			%Path="<l i='" @ %AreaID @ " " @ %Kill_XYZ @ "' t='path'/>";//组合成寻径

			%Player_Name="<l i='"@ %Player.GetPlayerName() @ " "@ %PlayerID @ "' t='name' />";	//死者玩家名称
			%Killer_Name="<l i='"@ %Killer.GetPlayerName() @ " "@ %KillerID @ "' t='name' />";	//杀手玩家名称

			%Kill_Org=SptOrg_GetName(SptOrg_GetOrgID(%KillerID));//杀手帮派名称
			switch (%Player.GetOrgMemberLevel(1))
			{
				case 0:%Org_Lv="【新进帮众】";
				case 1:%Org_Lv="【普通成员】";
				case 2:%Org_Lv="【高级成员】";
				case 3:%Org_Lv="【精英成员】";
				case 4:%Org_Lv="【元老成员】";
				case 5:%Org_Lv="【副帮主】";
				case 6:%Org_Lv="【帮主】";
			}

			SptOrg_Kill(%KillerID,%PlayerID,"<t>【战报】您帮派的" @ %Org_Lv @ "</t>" @ %Player_Name @ "<t>在</t>" @ %Path @ "<t>被宣战帮派【" @ %Kill_Org @ "】的</t>" @ %Killer_Name @ "<t>击败</t>");//宣战的杀敌数记录
		}

	//以免重复击败的buff
	%Player.SetSchBuff(40001020);

	//PlayerDeath_Lostitem( %Player, %Killer );//死亡后爆装备脚本
	switch (%MapID)
	{
		case 1119:
			PlayeronDeathCast_1119A(%Player, %Killer);//押镖的处理
		case 1120:IceFire_PvP_BeKill(%Player,%Killer);					//【    冰火试练    】
		case 1121:IceFire_PvP_BeKill(%Player,%Killer);					//【    冰火试练    】
		case 1122:IceFire_PvP_BeKill(%Player,%Killer);					//【    冰火试练    】
	}
	switch (%CopymapDataID)
	{
		case 1304:PlayeronDeathCast_1304(%Player,%Killer);
		case 1307:PlayeronDeathCast_1307(%Player,%Killer);
		case 1308:PlayeronDeathCast_1307(%Player,%Killer);
		case 1309:PlayeronDeathCast_1307(%Player,%Killer);
		case 1313:PlayeronDeathCast_1313_1315(%Player,%Killer);//刀剑神域
		case 1314:PlayeronDeathCast_1313_1315(%Player,%Killer);//刀剑神域
		case 1315:PlayeronDeathCast_1313_1315(%Player,%Killer);//刀剑神域
	}
	if (%MapID < 1300)//击败公告
	{
		PlayeronDeathCastForMsg(%Player,%Killer);
		PlayeronDeathForMianZhanPai(%Player,%Killer);
	}
}

function OnPlayerDeathByAmulet(%Player,%Killer)//死亡保护符触发
{
	if (!isplayer(%Killer))
		return;
	%MailText="『" @ %Player.Getobjectname() @ "』在被你击败的时候使用了护身符，您获得100元宝的收益。";
	SptMail_Send(%Killer.GetPlayerID(),0,0,100,0,"击败收益",%MailText);
}
//■■■■■■■■■■■玩家被玩家击败触发■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■各大地图击败公告■■■■■■■■■■■■■■■■■■
function PlayeronDeathCastForMsg(%DeathPlayer,%Player)
{
	CanCel(%Player.ScheduleKillRecord);

	%Player.killrecord=%Player.killrecord+1; //累计杀人数
	//%DeathPlayer.killrecord = 0;//累计杀人数

	%Player.timerecord=%Player.timerecord+1;//10S内刷新的杀人数
	//%DeathPlayer.timerecord = 0;//10S内刷新的杀人数

	%MapID=GetZoneID();
	%TriggerID=%Player.GetTriggerId();
	%MapName=GetTriggerData(GetSubStr(%TriggerID,0,7) @ "00",3);
	%TriggerName=GetTriggerData(%TriggerID,3);

	//echo( "%TriggerID ===" @ %TriggerID );
	//echo( "%MapName ===" @ %MapName );
	//echo( "%TriggerName ===" @ %TriggerName );
	//%TriggerName = "啊打地图";

	%PlayerName=GetPlayerZiTiName(%Player,2);
	%DeathPlayerName=GetPlayerZiTiName(%DeathPlayer,2);

	if (%MapName $=%TriggerName)
	{
		if (%MapID!=1119)
		{
			%AddRessName=$Get_Dialog_GeShi[60003] @ %MapName @ "</t>";
			%UseMapName=$Get_Dialog_GeShi[60003] @ %MapName @ "</t>";
		}
		else
		{
			%AddRessName=$Get_Dialog_GeShi[60007] @ %MapName @ "</t>";
			%UseMapName=$Get_Dialog_GeShi[60007] @ %MapName @ "</t>";
		}
	}
	else
	{
		if (%MapID!=1119)
		{
			%AddRessName=$Get_Dialog_GeShi[60003] @ %MapName @ "</t>" @ $Get_Dialog_GeShi[60002] @ %TriggerName @ "</t>";
			%UseMapName=$Get_Dialog_GeShi[60003] @ %MapName @ "</t>";
		}
		else
		{
			%AddRessName=$Get_Dialog_GeShi[60007] @ %MapName @ "</t>" @ $Get_Dialog_GeShi[60002] @ %TriggerName @ "</t>";
			%UseMapName=$Get_Dialog_GeShi[60007] @ %MapName @ "</t>";
		}
	}
	//echo( " %Text1===" @ %Text1 );
	//echo( " %Text2===" @ %Text2 );
	if (%DeathPlayer==%Player)
	{
		%Text1=%PlayerName @ "<t>在</t>" @ %AddRessName @ "<t>英勇就义，自杀了！</t>";
		%Text2="";
	}
	else
	{
		switch (%Player.timerecord)
		{
			case 1: %Text1=%PlayerName @ "<t>在</t>" @ %AddRessName @ "<t>击败了</t>" @ %DeathPlayerName;
			case 2:	%Text1=%PlayerName @ "<t>在</t>" @ %AddRessName @ "<t>击败了</t>" @ %DeathPlayerName @ "<t>，双杀！</t>";
			case 3:	%Text1=%PlayerName @ "<t>在</t>" @ %AddRessName @ "<t>击败了</t>" @ %DeathPlayerName @ "<t>，三杀！</t>";
			case 4:	%Text1=%PlayerName @ "<t>在</t>" @ %AddRessName @ "<t>击败了</t>" @ %DeathPlayerName @ "<t>，四杀！</t>";
			case 5:	%Text1=%PlayerName @ "<t>在</t>" @ %AddRessName @ "<t>击败了</t>" @ %DeathPlayerName @ "<t>，五杀！</t>";
			default:%Text1=%PlayerName @ "<t>在</t>" @ %AddRessName @ "<t>击败了</t>" @ %DeathPlayerName @ "<t>，已经超神了！！</t>";
		}
		if (%Player.killrecord>=5)
		{
			%Ran=GetRanDom(1,4);
			switch (%Ran)
			{
				case 1: %Text2="<t>" @ %MapName @ "</t>" @ "<t>战报：</t>" @ %PlayerName @ "<t>所向披靡，在</t>" @ %UseMapName @ "<t>大杀特杀！敌人闻风丧胆！</t>";
				case 2:	%Text2="<t>" @ %MapName @ "</t>" @ "<t>战报：</t>" @ %PlayerName @ "<t>驰骋沙场，霸气侧漏，在</t>" @ %UseMapName @ "<t>势如破竹，无人能挡！</t>";
				case 3:	%Text2="<t>" @ %MapName @ "</t>" @ "<t>战报：</t>" @ %PlayerName @ "<t>主宰了</t>" @ %UseMapName @ "<t>，犹如神一般的存在！</t>";
				case 4:	%Text2="<t>" @ %MapName @ "</t>" @ "<t>战报：</t>" @ %PlayerName @ "<t>战神临世！在</t>" @ %UseMapName @ "<t>横扫八方！</t>";
			}
		}
	}
	if (%Text1 !$="")
		SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text1 @ "</t>", $chatMsg_Type_Normal2);
	if (%Text2 !$="")
		SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);

	%Player.ScheduleKillRecord=Schedule(10000,0,"ClearPlayerScheduleKillRecord",%Player);
}
function ClearPlayerScheduleKillRecord(%Player)
{
	%Player.timerecord=0;
}
//■■■■■■■■■■■各大地图击败公告■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■给予经验的统一管理■■■■■■■■■■■■■■■■■
function AllAddExp(%Player,%Exp)
{
	%Now_Exp=%Player.GetExp();
	%LvExp=%Player.GetLevelExp();
	%Max_LvExp=%LvExp*3;
	%Level=%Player.GetLevel();
	%Player.AddExp(%Exp);
	return;
	
}
//■■■■■■■■■■■给予经验的统一管理■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■活跃度增加统一管理■■■■■■■■■■■■■■■■■
//增加活跃度
function AddHappyFlyLv(%Player,%Num)
{
	//%Player.SetEncourageExp( %Player.GetEncourageExp( ) + %Exp );	//经验给到内丹中
}
//■■■■■■■■■■■活跃度增加统一管理■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■姻缘成功调用■■■■■■■■■■■■■■■■■■■■
function sptServerCreateConsort(%Player,%destPlayer)
{
	if ((%Player.GetItemCount(105102573) > 0)&&(%destPlayer.GetItemCount(105102574) > 0))
	{
		%Player.PutItem(105102573,-1); //扣除聘礼
		%Player.AddItem(13,1);

		%destPlayer.PutItem(105102574,-1); //扣除嫁妆
		%destPlayer.AddItem(2,1016);

		%Player.AddPacket(660064);
		%Player.AddPacket(660065);
		%destPlayer.AddPacket(660064);
		%destPlayer.AddPacket(660065);

		//给予新婚大礼包
		%Player.PutItem(105100189,1);
		if (!%Player.AddItem(4,105100189))
			SptMail_Send(%Player.GetPlayerID(),0,0,0,0,"结婚礼包","<t>恭喜你们喜结连理！</t>");

		%destPlayer.PutItem(105100189,1);
		if (!%destPlayer.AddItem(4,105100189))
			SptMail_Send(%destPlayer.GetPlayerID(),0,0,0,0,"结婚礼包","<t>恭喜你们喜结连理！</t>");

		%MalePlayer="<l i='"@ %Player.GetPlayerName() @ " "@ %Player.GetPlayerID() @ "' t='name' />";
		%FemalePlayer="<l i='"@ %destPlayer.GetPlayerName() @ " "@ %destPlayer.GetPlayerID() @ "' t='name' />";

		SendOneLineMessage("<t>恭喜！</t>"@ %MalePlayer @"<t>和</t>"@ %FemalePlayer @"<t>情投意合，结为夫妻，真是一对羡煞旁人的江湖侠侣！</t>",$chatMsg_WordPlus);
		return true;
	}
	else
	{
		return false;
	}

}

function RemoveNpc_WLLT(%TeammSet1,%TeammSet2,%CopyMapID,%Type)
{
	%TeammSet1Player="<l i='"@ %TeammSet1.GetPlayerName() @ " "@ %TeammSet1.GetPlayerID() @ "' t='name' />";
	%TeammSet2Player="<l i='"@ %TeammSet2.GetPlayerName() @ " "@ %TeammSet2.GetPlayerID() @ "' t='name' />";

	switch (%Type)
	{
		case 1:
			addEffectPacket(660063,0,"2.88485 138.078 100.325","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"-2.6318 137.883 100.311","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(3500,0,"RemoveNpc_WLLT",%TeammSet1,%TeammSet2,%CopyMapID,2);

		case 2:
			addEffectPacket(660063,0,"-3.63901 146.299 103.923","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"3.59726 146.61 103.923  ","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(3500,0,"RemoveNpc_WLLT",%TeammSet1,%TeammSet2,%CopyMapID,3);

		case 3:
			addEffectPacket(660063,0,"3.70615 152.795 103.59 9","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"-3.18782 152.775 103.599","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(3500,0,"RemoveNpc_WLLT",%TeammSet1,%TeammSet2,%CopyMapID,4);

		case 4:
			addEffectPacket(660063,0,"-3.74999 159.25 103.599","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"3.25001 158.75 103.599","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(3500,0,"RemoveNpc_WLLT",%TeammSet1,%TeammSet2,%CopyMapID,5);

		case 5:
			addEffectPacket(660063,0,"6.251 163.75 103.599    ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"-6.31709 163.767 103.599","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(3500,0,"RemoveNpc_WLLT",%TeammSet1,%TeammSet2,%CopyMapID,6);

		case 6:
			addEffectPacket(660063,0,"-5.29682 171.391 103.599 ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"6.6176 171.128 103.599   ","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(3500,0,"RemoveNpc_WLLT",%TeammSet1,%TeammSet2,%CopyMapID,7);

		case 7:
			addEffectPacket(660065,0,"-0.152193 168.801 105","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660065,0,"5.24557 164.298 105  ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660065,0,"-4.52115 163.353 105 ","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(5000,0,"RemoveNpc_WLLT",%TeammSet1,%TeammSet2,%CopyMapID,8);

		case 8:
			addEffectPacket(660063,0,"-3.74999 159.25 103.599","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"3.25001 158.75 103.599","1 0 0 0",0,0,10000,%CopyMapID);

			addEffectPacket(660063,0,"6.251 163.75 103.599    ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"-6.31709 163.767 103.599","1 0 0 0",0,0,10000,%CopyMapID);

			addEffectPacket(660063,0,"-5.29682 171.391 103.599 ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"6.6176 171.128 103.599   ","1 0 0 0",0,0,10000,%CopyMapID);

			Schedule(5000,0,"RemoveNpc_WLLT",%TeammSet1,%TeammSet2,%CopyMapID,9);

		case 9:
			SptCopymap_SendMsg(%CopyMapID,0,"<t>恭喜！</t>"@ %TeammSet1Player @"<t>和</t>"@ %TeammSet2Player @"<t>情投意合，结为夫妻，请大家给新人送上祝福</t>");

			//获取玩家ID
			%TeamList=SptCopyMap_GetAllPlayer(%CopyMapID); 	//获得副本内player
			%TeamNum=SptCopyMap_GetPlayerCount(%CopyMapID); //获取副本内人数
			for (%i=0; %i < %TeamNum; %i++)
			{
				//获取Player
				%Player=GetWord(%TeamList,%i);
				addEffectPacket(660065,%Player,"-0.18536 163.909 105","1 0 0 0",0,0,10000,%CopyMapID);
			}

			addEffectPacket(660064,0,"-0.18536 163.909 105","1 0 0 0",0,0,10000,%CopyMapID);
	}
}

function RemoveNpc_YYLT(%TeammSet1,%TeammSet2,%CopyMapID,%Type)
{
	%TeammSet1Player="<l i='"@ %TeammSet1.GetPlayerName() @ " "@ %TeammSet1.GetPlayerID() @ "' t='name' />";
	%TeammSet2Player="<l i='"@ %TeammSet2.GetPlayerName() @ " "@ %TeammSet2.GetPlayerID() @ "' t='name' />";

	switch (%Type)
	{
		case 1:
			addEffectPacket(660063,0,"-3.74999 159.25 103.599","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"3.25001 158.75 103.599","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(3500,0,"RemoveNpc_YYLT",%TeammSet1,%TeammSet2,%CopyMapID,2);

		case 2:
			addEffectPacket(660063,0,"6.251 163.75 103.599    ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"-6.31709 163.767 103.599","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(3500,0,"RemoveNpc_YYLT",%TeammSet1,%TeammSet2,%CopyMapID,3);

		case 3:
			addEffectPacket(660063,0,"-5.29682 171.391 103.599 ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"6.6176 171.128 103.599   ","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(3500,0,"RemoveNpc_YYLT",%TeammSet1,%TeammSet2,%CopyMapID,4);

		case 4:
			addEffectPacket(660065,0,"-0.152193 168.801 105","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660065,0,"5.24557 164.298 105  ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660065,0,"-4.52115 163.353 105 ","1 0 0 0",0,0,10000,%CopyMapID);
			Schedule(5000,0,"RemoveNpc_YYLT",%TeammSet1,%TeammSet2,%CopyMapID,5);

		case 5:
			addEffectPacket(660063,0,"-3.74999 159.25 103.599","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"3.25001 158.75 103.599","1 0 0 0",0,0,10000,%CopyMapID);

			addEffectPacket(660063,0,"6.251 163.75 103.599    ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"-6.31709 163.767 103.599","1 0 0 0",0,0,10000,%CopyMapID);

			addEffectPacket(660063,0,"-5.29682 171.391 103.599 ","1 0 0 0",0,0,10000,%CopyMapID);
			addEffectPacket(660063,0,"6.6176 171.128 103.599   ","1 0 0 0",0,0,10000,%CopyMapID);

			Schedule(5000,0,"RemoveNpc_YYLT",%TeammSet1,%TeammSet2,%CopyMapID,6);

		case 6:
			SptCopymap_SendMsg(%CopyMapID,0,"<t>恭喜！</t>"@ %TeammSet1Player @"<t>和</t>"@ %TeammSet2Player @"<t>情投意合，结为夫妻，请大家给新人送上祝福</t>");

			addEffectPacket(660064,0,"-0.18536 163.909 105","1 0 0 0",0,0,10000,%CopyMapID);
	}
}

//■■■■■■■■■■■姻缘成功调用■■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■统一增加帮派数据■■■■■■■■■■■■■■■■■■
function AddFamily_SW_GX(%Player,%SW,%GX)
{
	//帮派声望奖励
	SptOrg_AddHonor(%Player.GetOrgID(),%SW,%Player.GetPlayerID());
	//帮派贡献奖励
	SptOrg_AddMemberContribute(%Player.GetPlayerID(),%GX);

	//玩家贡献记录
	%Act0 = GetAct(%Player, 4135, 0) * 1;
	%Act1 = GetAct(%Player, 4135, 1) * 1;
	%Act1 = %Act1 + %GX;
	if (%Act1 > 9999)
	{
		%Act0 = %Act0 + mfloor(%Act1/10000);
		%Act1 = %Act1%10000;
	}
	SetAct(%Player, 4135, %Act0, %Act1);

	//echo("%Act0 * 10000 + %Act1===" @ %Act0 * 10000 + %Act1);
	AddAchievementWatch(%Player, 1, 172, %Act0 * 10000 + %Act1);//记录玩家成就
	
	//消息提示
	SendOneChatMessage($chatMsg_Person,"<t>您的帮派声望增加了: " @ %SW @ "，您获得帮派贡献: " @ %GX @ "</t>",%Player);
}
function AddFamily_HuoYue(%Player, %HuoYue)
{
	%FamilyID = %Player.GetOrgID();
	if (%FamilyID > 0)
		SptOrg_AddActivity(%FamilyID, %HuoYue);
	//消息提示
	SendOneChatMessage($chatMsg_Person, "<t>您的帮派活跃增加了: " @ %HuoYue @ "</t>", %Player);
}
function AddFamily_ZiJin(%Player, %ZiJin)
{
	%FamilyID = %Player.GetOrgID();
	%PlayerID = %Player.GetPlayerID();
	if (%FamilyID > 0)
		SptOrg_AddMoney(%FamilyID, %ZiJin, %PlayerID);
	//消息提示
	SendOneChatMessage($chatMsg_Person, "<t>您的帮派资金增加了: " @ %ZiJin @ "</t>", %Player);
}

function AddFamily_HuoBi(%Player, %HuoBi)
{
	%FamilyID = %Player.GetOrgID();
	%PlayerID = %Player.GetPlayerID();
	if (%FamilyID > 0)
		SptOrg_AddMemberMoney(%PlayerID, %HuoBi);
	//消息提示
	SendOneChatMessage($chatMsg_Person, "<t>您获得帮派货币: " @ %HuoBi @ "</t>", %Player);
}

//■■■■■■■■■■■统一增加帮派数据■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■化神升级境界时触发■■■■■■■■■■■■■■■■■
function onSpiritLevelUp(%Player,%Level)
{
	//%Level 是增加/减少的等级，有可能是负值
	%Spirit_Level=%Player.GetSpiritLevel(%Player.GetActiveSpiritSlot());
}
//■■■■■■■■■■■化神升级境界时触发■■■■■■■■■■■■■■■■■



//■■■■■■■■■■■进入副本获得双倍经验调用■■■■■■■■■■■■■■
function CopyMapID_Superfluity_Exp(%CopyMapID)
{
	if (GetSubStr(GetZoneID(),1,1) $="3")
	{
		//初始化
		%Level[2]=60;

		//获取玩家ID
		%T=SptCopyMap_GetAllPlayer(%CopyMapID);
		%T_Num=SptCopyMap_GetPlayerCount(%CopyMapID);

		//判断玩家人数是否 >1
		if (%T_Num > 1)
		{
			//获取玩家最小等级
			for (%i=0; %i < %T_Num; %i++)	//获取玩家等级
			{
				%Player=GetWord(%T,%i);
				%Level[1]=%Player.GetLevel();

				if (%Level[1] < %Level[2])
					%Level[2]=%Level[1];
			}

			//确认buff编号
			if (%Level[2] <  50){ %Buff=12; }
			else if (%Level[2] <  60){ %Buff=13; }
			else if (%Level[2]>=60){ %Buff=20; }

			//增加buff
			if (%Buff > 0)
			{
				for (%i=0; %i < %T_Num; %i++)	//获取玩家等级
				{
					%Player=GetWord(%T,%i);
					%Player.SetSchbuff(%Buff);
				}
			}
			if (%Buff==12)%Text="队伍里存在50级以下新人，击败怪物将获得1倍经验加成。";
			else if (%Buff==13)%Text="队伍里存在60级以下新人，击败怪物将获得0.6倍经验加成。";
			else if (%Buff==20)%Text="<t>队伍里不存在新人无法获得击败怪物加成，若：</t><b/><t>・存在60级以下新人：1倍经验加成</t><b/><t>・存在50级以下新人：0.6倍经验加成</t>";
			SendAllChatMessageLayer($chatMsg_System,$Get_Dialog_GeShi[31219] @ %Text @"</t>",%CopyMapID);
		}
	}
}
//■■■■■■■■■■■进入副本获得双倍经验调用■■■■■■■■■■■■■■

//■■■■■■■■■■■触发验证码调用■■■■■■■■■■■■■■■■■■■
function SptIdCode_Yes_Or_No(%Player,%Num)
{
	if (%Player.CanSendIdCodeRequest()==0)
		return;
}
//■■■■■■■■■■■触发验证码调用■■■■■■■■■■■■■■■■■■■

function MarriedConditions(%Player)
{
	%PlayerID=%Player.GetPlayerID();
	%TeamList=SvrGetTeammate(%PlayerID,20);//队伍列表
	%TeammSet1=GetWord(%TeamList,0);
	%TeammSet2=GetWord(%TeamList,1);
	%TeammSet3=GetWord(%TeamList,2);

	if (SvrIsMyselfHasTeam(%PlayerID)==0){ return Married(%Player,"A"); }//没有队伍
	if (%TeammSet3!=0)	{ return Married(%Player,"B"); }//有第三者
	if ((!isobject(%TeammSet1))||(!isobject(%TeammSet2))){ return Married(%Player,"C"); }//不在附近的话就再见了
	if (%Player.GetSex()!=1){ return Married(%Player,"D"); }//必须男方使用
	if (SvrIsMyselfCaption(%PlayerID)==0){ return Married(%Player,"E"); }//必须由队长使用
	return "";
}

function MarriedConditions_YJ(%Player)
{
	%PlayerID=%Player.GetPlayerID();
	%TeamList=SvrGetTeammate(%PlayerID,20);//队伍列表
	%TeammSet1=GetWord(%TeamList,0);
	%TeammSet2=GetWord(%TeamList,1);
	%TeammSet3=GetWord(%TeamList,2);
	%TeammSet1ID=%TeammSet1.GetPlayerID();
	%TeammSet2ID=%TeammSet2.GetPlayerID();

	if (SvrIsMyselfHasTeam(%PlayerID)==0){ return Married(%Player,"A"); }//没有队伍
	if (%TeammSet3!=0)	{ return Married(%Player,"B"); }//有第三者
	if ((!isobject(%TeammSet1))||(!isobject(%TeammSet2))){ return Married(%Player,"C"); }//不在附近的话就再见了
	if (%Player.GetSex()!=1){ return Married(%Player,"D"); }//必须男方使用
	if (SvrIsMyselfCaption(%PlayerID)==0){ return Married(%Player,"E"); }//必须由队长使用
	if (%TeammSet1.isConsort(%TeammSet2ID)==0){ return Married(%Player,"G"); }//必须是夫妻才可使用
	if (%Player.IsFinishedMission(32580)){ return Married(%Player,"H"); }	//判断该角色是不是本场婚礼的新郎
	return "";
}

function MarriedConditions_SM(%Player)
{
	%PlayerID=%Player.GetPlayerID();
	%TeamList=SvrGetTeammate(%PlayerID,20);//队伍列表
	%TeammSet1=GetWord(%TeamList,0);
	%TeammSet2=GetWord(%TeamList,1);
	%TeammSet3=GetWord(%TeamList,2);

	if (SvrIsMyselfHasTeam(%PlayerID)==0){ return Married(%Player,"A"); }//没有队伍
	if (%TeammSet3!=0)	{ return Married(%Player,"B"); }//有第三者
	if ((!isobject(%TeammSet1))||(!isobject(%TeammSet2))){ return Married(%Player,"C"); }//不在附近的话就再见了
	return "";
}

function MarriedConditions_LT(%Player)
{
	%PlayerID=%Player.GetPlayerID();
	%TeamList=SvrGetTeammate(%PlayerID,20);//队伍列表
	%TeammSet1=GetWord(%TeamList,0);
	%TeammSet2=GetWord(%TeamList,1);
	%TeammSet3=GetWord(%TeamList,2);

	if (SvrIsMyselfHasTeam(%PlayerID)==0){ return Married(%Player,"A"); }//没有队伍
	if (%TeammSet3!=0)	{ return Married(%Player,"B"); }//有第三者
	return "";
}

function Married(%Player,%TiaoJian)
{
	switch$(%TiaoJian)
	{
		case "A": %Txt1="必须在双方组队的状态下才可以使用该功能";
		case "B": %Txt1="必须是在只有男女双方组队状态下使用";
		case "C": %Txt1="必须是在只有男女双方都在附近才能使用";
		case "D": %Txt1="必须由男方点击方可使用";
		case "E": %Txt1="必须由队长点击方可使用";
		case "F": %Txt1="必须男方为队长方可使用";
		case "G": %Txt1="必须队友是夫妻关系才可使用";
	}

	SendOneScreenMessage(2,%Txt1,%Player);
	SendOneChatMessage(0,"<t>" @ %Txt1 @ "</t>",%Player);
	return %TiaoJian;
}

//■■■■■■■■■■■玩家复活点复活坐标返回■■■■■■■■■■■■■■■
function GetSptRisePosition(%Player,%triggerid)
{
	//获取玩家阵营
	%Force=%Player.GetForce();
	if (%Force==0)%Force=1;

	//特殊地图-特殊处理
	%CopyMapID=%Player.GetLayerId();	//获取副本层
	%CopymapDataID=SptGetCopymapDataId(%CopyMapID);	//获取副本DataID

	switch (%CopymapDataID)
	{
		case 1369:return JingJiChang6V6_SptRisePosition(%Player);
	}

	switch (%triggerid)
	{
		//决战中原战场
		case "813420100": return $Transport_objXyz[2,30+(%Force-1)];

		default:
			//帮派攻城战
			if (GetSubStr(%triggerid,1,4)==1343)
				return GongChengZhan_Revivify(%Player,%Force);
	}

	//返回空，则默认区域
	return "";
}
//■■■■■■■■■■■满血满蓝复活■■■■■■■■■■■■■■■■■■■■
function Relive_AddBuff(%Player)
{
	%Player.AddBuff(390210001,%Player);
}
//■■■■■■■■■■■满血满蓝复活■■■■■■■■■■■■■■■■■■■■


//■■■■■■■■■■■检测是否已经隔天■■■■■■■■■■■■■■■■■■
function CheckDayTime(%Day)
{
	if (%Day==0)
		return 1;
	else
	{
		%Time=GetLocalTime();

		%YY=GetWord(%Time,0);	//年
		%MM=GetWord(%Time,1);	//月
		%DD=GetWord(%Time,2);	//日
		%Day_Now=%YY * %MM+%DD;

		if (%Day==%Day_Now)
			return 0;
		else
			return 1;
	}
}
//■■■■■■■■■■■检测是否已经隔天■■■■■■■■■■■■■■■■■■



//■■■■■■■■■■■更新所有地图脚本命令■■■■■■■■■■■■■■■■
function Renovate_upcs(%Renovate,%Map,%MMM)
{
	if (%Renovate $=0)
		%Renovate="upcs";

	if (%MMM $=0)
		%MMM=99;

	if (%Map==0)
	{
		if (GetSubStr(GetZoneID(),1,1) !$="3")
		{
			%Map[1]=1124;	%Map[11]=1007;	%Map[21]=1106;	%Map[31]=1131;
			%Map[2]=1128;	%Map[12]=1008;  %Map[22]=1107;	%Map[32]=1132;
			%Map[3]=1129;	%Map[13]=1009;  %Map[23]=1108;	%Map[33]=1133;
			%Map[4]=1199;	%Map[14]=1010;  %Map[24]=1110;	%Map[34]=1135;
			%Map[5]=1125;	%Map[15]=1011;  %Map[25]=1111;	%Map[35]=1136;
			%Map[6]=1001;	%Map[16]=1101;  %Map[26]=1112;
			%Map[7]=1002;	%Map[17]=1102;  %Map[27]=1116;
			%Map[8]=1004;	%Map[18]=1103;  %Map[28]=1117;
			%Map[9]=1005;	%Map[19]=1104;  %Map[29]=1119;
			%Map[10]=1006;	%Map[20]=1105;  %Map[30]=1130;
		}
		else
		{
			%Map[1]=130201;	%Map[11]=131501;
			%Map[2]=130101;  %Map[12]=133101;
			%Map[3]=131101;  %Map[13]=134201;
			%Map[4]=131201;  %Map[14]=131901;
			%Map[5]=130601;  %Map[15]=133001;
			%Map[6]=130401;  %Map[16]=133601;
			%Map[7]=130701;  %Map[17]=133901;
			%Map[8]=130901;  %Map[18]=133301;
			%Map[9]=131301;  %Map[19]=134101;
			%Map[10]=131401;
		}

		for (%i=1; %i<=50; %i++)
		{
			if (%Map[%i]==0)
				break;

			SptInterMapExecute(%Map[%i],%Renovate @"("@ %MMM @");");
		}
	}
	else
		SptInterMapExecute(%Map,%Renovate @"("@ %MMM @");");
}
//■■■■■■■■■■■更新所有地图脚本命令■■■■■■■■■■■■■■■■


//■■■■■■■■■■■跨线程队友发送消息■■■■■■■■■■■■■■■■■
function AllLineMessage_PlayerID_A(%PlayerID,%MapDataID,%StringID,%MarkID)
{
	//获取队友Player
	%TeammateID=SvrGetAllTeammate(%PlayerID);
	%T_Num=GetWordCount(%TeammateID);

	//循环发送消息
	for (%i=0; %i < %T_Num; %i++)
	{
		%PlayerID=GetWord(%TeammateID,%i);
		SptInterPlayerExecute(%PlayerID,"AllLineMessage_PlayerID_B("@%PlayerID@", "@%MapDataID@", "@%StringID@", "@%MarkID@");");
	}
}

function AllLineMessage_PlayerID_B(%PlayerID,%MapDataIDA,%StringID,%MarkID)
{
	%Player=SptGetPlayer(%PlayerID);
	%CopyMapID=%Player.GetLayerId();
	%MapDataIDB=SptGetCopymapDataId(%CopyMapID);

	if (%MapDataIDA==%MapDataIDB)
		return;

	if (GetSubStr(GetZoneID(),1,1) $="3")
		%Player.ShowDialogOk(%StringID,0,0);
	else
	{
		%Player.ShowDialogOk(%StringID+25,%MarkID,1);
	}
}
//■■■■■■■■■■■跨线程队友发送消息■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■师徒拜师出师成功触发■■■■■■■■■■■■■■■■
function SetRudimentalLevel(%Player)
{
	%Level=%Player.GetLevel();								//玩家当前等级
	%Force=%Player.SetFlagsByte(39,%Level);	//玩家拜师等级

	Schedule(1000,0,"SetRudimentalLevel_Defer",%Player);
}

function SetRudimentalLevel_Defer(%Player)
{
	//获取师徒ID
	%MasterID=%Player.GetMasterPlayerId();

	//徒弟拜师特效
	%Player.AddPacket(670040);

	if (%MasterID > 0)
	{
		//特殊格式解析
		%ItemID="<l i='105101600' t='itemid'/>";
		%PathID="<l i='810010100 124.213 2.14262 100.059' t='path'/>";

		//解析邮件内容
		%Title="收徒通知";
		%Txt="<t f='黑体' m='0' n='16' gct='0xffff00ff' gcb='0xd9680dff'>您已成功收取 ["@%Player.GetPlayerName()@"] 为徒。</t><b/><b/>"@
			$Get_Dialog_GeShi[11400] @ "收徒奖励说明：</t><b/>" @
			"<t>1、您的徒弟在升级至42、50、60、70、80、90级时，您都将获得高额的</t>" @ $Get_Dialog_GeShi[31222] @ "经验、师德奖励</t><t>。</t><b/>"@
			$Get_Dialog_GeShi[31206] @ "注：徒弟好友度低于2000时经验奖励削减，越低则削减的越多。</t><b/><b/>"@

			"<t>2、</t>"@%ItemID@"<t>完成以下即可获得：</t><b/>"@
			$Get_Dialog_GeShi[31206] @ "Ⅰ：您的徒弟到达60级</t><b/>"@
			$Get_Dialog_GeShi[31206] @ "Ⅱ：您与徒弟友好度大于500点</t><b/>"@
			$Get_Dialog_GeShi[31206] @ "Ⅲ：您与徒弟完成2次【侠义师徒】任务</t><b/><b/>"@

			$Get_Dialog_GeShi[31206] @ "注：前往</t>"@%PathID @ $Get_Dialog_GeShi[31206] @ "宁道奇处，选择【师徒功能说明】即可查询详情。</t>";

		//发送邮件
		SptMail_Send(%MasterID,0,0,0,0,%Title,%Txt);
	}
}

function SptCalcMasterAttachPrize(%MasterID,%Player,%oldLevel,%newLevel)
{
	%exp=0;					//经验奖励
	%masterExp=0;		//师德奖励
	%PlayerID=%Player.GetPlayerID(); //获取徒弟PlayerID

	if (%oldLevel < 90&&%newLevel>=90)
	{
		%exp=8000*10000;
		%masterExp=20000;
	}
	else if (%oldLevel < 80&&%newLevel>=80)
	{
		%exp=4000*10000;
		%masterExp=4000;
	}
	else if (%oldLevel < 70&&%newLevel>=70)
	{
		%exp=2000*10000;
		%masterExp=2000;
	}
	else if (%oldLevel < 60&&%newLevel>=60)
	{
		%Force=%Player.GetFlagsByte(39);	//玩家拜师等级
		%exp=(60*10000*(60-%Force));

		if (%exp > 1000*10000)%exp=1000*10000;
		else if (%exp < 500*10000)%exp=500*10000;

		%masterExp=0;
	}
	else if (%oldLevel < 50&&%newLevel>=50)
	{
		%exp=500*10000;
		%masterExp=500;

	}
	else if (%oldLevel < 42&&%newLevel>=42)
	{
		%exp=200*10000;
		%masterExp=0;
	}

	if (%exp > 0)
	{
		//获取友好度
		%AmityValue=SptGetFirendValue(%PlayerID,%MasterID);
		%PathID="<l i='810010100 124.275 2.15867 100.059' t='path'/>";

		//友好度判断
		if (%AmityValue>=2000)
		{
			%TxtA=%exp;
			%TxtE="<t> 【您与徒弟的友好度大于2000，获得了全额的储存经验。】</t><b/>";
		}
		else if (%AmityValue < 1000)
		{
			%TxtA=%exp * 0.5;
			%TxtE="<t> 【您与徒弟的友好度小于1000，未获得全额的储存经验。】</t><b/>";
		}
		else
		{
			%TxtA=%exp * (%AmityValue/2000);
			%TxtE="<t> 【您与徒弟的友好度小于2000，未获得全额的储存经验。】</t><b/>";
		}

		%TxtB=$Get_Dialog_GeShi[11400] @ "您已获得以下奖励：</t><b/>";
		%TxtC="<t> 1、储存经验："@%TxtA@"点</t><b/>";
		if (%masterExp > 0)%TxtD="<t> 2、师德："@%masterExp@"点</t><b/>";
		%TxtF="<b/>" @ $Get_Dialog_GeShi[31206] @ "注：前往</t>"@%PathID @ $Get_Dialog_GeShi[31206] @ "宁道奇处，可进行【储存经验、师德】的查询和兑换。</t>";

		//特殊格式解析
		%PathID="<l i='810010100 124.213 2.14262 100.059' t='path'/>";

		//解析邮件内容
		%Title="徒弟升级通知";
		%Txt="<t f='黑体' m='0' n='16' gct='0xffff00ff' gcb='0xd9680dff'>您的徒弟 ["@%Player.GetPlayerName()@"] 升级至"@%newLevel@"级。</t><b/><b/>"@
			%TxtB @ %TxtC @ %TxtD @ %TxtE @ %TxtF;

		//发送邮件
		SptMail_Send(%MasterID,0,0,0,0,%Title,%Txt);
	}

	return %exp @" "@%masterExp;
}

function StartupLeaveMasterInfo(%Player)
{
	//发送邮件
	SystemSendMailToPlayer(%Player,24);
}
//■■■■■■■■■■■师徒拜师出师成功触发■■■■■■■■■■■■■■■■

//■■■■■■■■■■■因为特殊原因需要获取复活点坐标■■■■■■■■■■■
function GetDefaultRisePosition()
{
	return "1119 216.557 203.926 101.452";
}
//■■■■■■■■■■■因为特殊原因需要获取复活点坐标■■■■■■■■■■■

//■■■■■■■■■■■洗炼成功后调用■■■■■■■■■■■■■■■■■■■
function sptPetHuanTongSucceed(%Player,%PetName,%chengzhanglv)
{
	%Tab1="<t c='0x2cffeeff'o='0x010101ff'>";
	%PlayerName="<l i='"@ %Player.GetPlayerName() @ " "@ %Player.GetPlayerID() @ "' t='name' />";

	if ((%chengzhanglv>=2806)&&(%chengzhanglv < 3300)) { %Pz=$Get_Dialog_GeShi[31295] @"『传说』</t>"; }//传说品质
	else if (%chengzhanglv>=3300) { %Pz=$Get_Dialog_GeShi[31295] @"『逆天』</t>"; }//逆天品质

	if (%Pz !$="")
	{
		%Num=GetRandom(1,2);
		if (%Num==1){ %Txt="<t>太厉害了!</t>"@ %PlayerName @"<t>竟然将他的神兽</t>"@ $Get_Dialog_GeShi[31204] @ "『" @ %PetName @ "』</t><t>洗出了</t>" @ %Pz @ "<t>的资质，简直太棒了，大家一起膜拜他吧！</t>"; }
		else if (%Num==2){ %Txt="<t>太厉害了!</t>"@ %PlayerName @"<t>的</t>"@ $Get_Dialog_GeShi[31204] @ "『" @ %PetName @ "』</t><t>神兽资质竟然达到了</t>" @ %Pz @ "<t>级，三界之内还有比他更厉害的吗？</t>"; }
		SendOneLineMessage(%Tab1 @  %Txt@ "</t>");//发送系统信息

		if (%chengzhanglv>=3300)
		{
			%Txt=$Get_Dialog_GeShi[60001] @ "『" @ %Player.GetPlayerName() @ "』</t>" @ $Get_Dialog_GeShi[60000] @ "竟然将他的神兽</t>" @
				$Get_Dialog_GeShi[60003] @ "『"@ %PetName @"』</t>" @ $Get_Dialog_GeShi[60000] @ "洗出了</t>" @ $Get_Dialog_GeShi[60004] @ "『逆天』</t>" @
				$Get_Dialog_GeShi[60000] @ "的资质！</t>";
			SendOneLineMessage(%Txt, $chatMsg_Type_Normal2);
		}
	}
}
//■■■■■■■■■■■洗炼成功后调用■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■集合符和召唤符■■■■■■■■■■■■■■■■■■■
//召唤全体队员：
function CallBackTeamPlayer(%Player)
{
	%PlayerID=%Player.GetPlayerID();

	if (SvrIsMyselfHasTeam(%PlayerID)==0)
		return SendWhyMsg(%Player,"BF",0,1);//您没有队伍，无法使用

	if (!SvrIsMyselfCaption(%PlayerID))
		return SendWhyMsg(%Player,"AD",0,1);//该功能只能是队长才可执行

	%Player.SptCallAllTeammates();
}

//向队长集合：
function GoToTeamMaster(%Player)
{
	%Index=CanTransportobject(%Player,4);
	if (%Index >  0)
		%Player.SptTransportToCaptain(1);
}

//如果玩家能响应集合操作，则会调用脚本
function SptDoTransportToCaptain(%Player,%line,%zone,%x,%y,%z,%together)
{
	echo("如果玩家能响应集合操作，则会调用脚本" @  %Player);
	%Index=CanTransportobject(%Player,5);
	if (%Index==0)
		return 0;
	//是队员去队长的情况
	if (%together==1)
	{
		if (%Player.GetItemCount(113020002)>=1)
			%Player.PutItem(113020002,-1);
		else if (%Player.GetItemCount(113020001)>=1)
			%Player.PutItem(113020001,-1);
		else
		{
			SendOneScreenMessage(2,"您没有集合符，无法前往队长身边",%Player);
			return 0;//没物品，不能传送
		}

		if (%Player.AddItem(4,113020001))
			return 1;//扣除成功，可以传送
		else
		{
			SendOneScreenMessage(2,"您没有集合符，无法前往队长身边",%Player);
			return 0;//没物品，不能传送
		}
	}

	return 1;
}
//如果队长成功发起召唤，则扣除道具・
function SptOnTeammateCalled(%Player)
{
	//神将特权判断
	//if ( inspectVipTimer_ZhaoHuanDuiYou( %Player ) > 0 )
	//{
	//	SendOneScreenMessage( 1, "成功召唤队友。", %Player );
	//	return 1;//可以召唤
	//}

	if (%Player.GetItemCount(113020012)>=1)
		%Player.PutItem(113020012,-1);
	else if (%Player.GetItemCount(113020011)>=1)
		%Player.PutItem(113020011,-1);
	else
	{
		SendOneScreenMessage(2,"您没有召唤符，无法召唤队友",%Player);
		return 0;//没物品，不能召唤
	}

	if (%Player.AddItem(4,113020011))
	{
		SendOneScreenMessage(1,"成功召唤队友。",%Player);
		return 1;//扣除成功，可以召唤
	}
	else
	{
		SendOneScreenMessage(2,"您没有召唤符，无法召唤队友",%Player);
		return 0;//扣除失败，不可以召唤
	}
}
//■■■■■■■■■■■集合符和召唤符■■■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■千里眼功能扣除物品■■■■■■■■■■■■■■■■■
function SptOnPlayerQueried(%Player)
{
}
//■■■■■■■■■■■千里眼功能扣除物品■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■千里眼查询后能否飞过去的判断■■■■■■■■■■■■
function QianLiYan_Can_Fly(%Player,%Together)
{
	%Index=CanTransportobject(%Player,3);
	return %Index;
}
//■■■■■■■■■■■千里眼查询后能否飞过去的判断■■■■■■■■■■■■

//■■■■■■■■■■■获取副本中过滤最低等级后的平均等级函数■■■■■■■
function SptCopyMap_GetPlayerCorpsLvA(%CopyMapID)
{
	//获取玩家ID
	%T=SptCopyMap_GetAllPlayer(%CopyMapID);
	%T_Num=SptCopyMap_GetPlayerCount(%CopyMapID);

	//设置玩家计数
	for (%i=0; %i < %T_Num; %i++)	//获取玩家等级
	{
		//获取Player
		%Player=GetWord(%T,%i);
		//获取等级
		%Lv=%Player.GetLevel();

		//如果只有一个玩家则直接返回
		if (%T_Num==1) return %Lv;

		//储存最小等级
		%LeastLv=((%Lv < %LeastLv)||(%LeastLv==0)) ? %Lv : %LeastLv;

		//储存总等级
		%FinallyLv=%FinallyLv+%Lv;
	}

	//获取总人数，去除最低等级后的平均等级
	%FinallyLv=(%FinallyLv-%LeastLv)/(%T_Num-1);

	//返回平均等级
	return mCeil(%FinallyLv);
}
//■■■■■■■■■■■获取副本中过滤最低等级后的平均等级函数■■■■■■■

function s()
{
	showallplayer();
}

//■■■■■■■■■■■计时器结束后触发脚本■■■■■■■■■■■■■■■■
function OnTimerControlTriggered(%Player,%Index)
{
	return true;
}
//■■■■■■■■■■■计时器结束后触发脚本■■■■■■■■■■■■■■■■

//■■■■■■■■■■■化神激活境界时触发■■■■■■■■■■■■■■■■■
function avatarSetEnabled(%Player,%slot)
{
	switch (%slot)
	{
		case  0:%Item="105090060"; %Level=0;
		case  1:%Item="105090061"; %Level=0;
		case  2:%Item="105090062"; %Level=0;
		case  3:%Item="105090063"; %Level=0;
		case  4:%Item="105090064"; %Level=0;

		case  5:%Item="105090065"; %Level=0;
		case  6:%Item="105090066"; %Level=0;
		case  7:%Item="105090067"; %Level=0;
		case  8:%Item="105090068"; %Level=0;
		case  9:%Item="105090069"; %Level=0;

		case 10:%Item="105090070"; %Level=81;
		case 11:%Item="105090071"; %Level=81;
		case 12:%Item="105090072"; %Level=81;
		case 13:%Item="105090073"; %Level=81;
		case 14:%Item="105090074"; %Level=81;

		case 15:%Item="105090075"; %Level=81;
		case 16:%Item="105090076"; %Level=81;
		case 17:%Item="105090077"; %Level=81;
		case 18:%Item="105090078"; %Level=81;
		case 19:%Item="105090079"; %Level=81;

		case 20:%Item="105090080"; %Level=161;
		case 21:%Item="105090081"; %Level=161;
		case 22:%Item="105090082"; %Level=161;
		case 23:%Item="105090083"; %Level=161;
		case 24:%Item="105090084"; %Level=161;

		case 25:%Item="105090085"; %Level=161;
		case 26:%Item="105090086"; %Level=161;
		case 27:%Item="105090087"; %Level=161;
		case 28:%Item="105090088"; %Level=161;
		case 29:%Item="105090089"; %Level=161;
	}

	//获取六道轮回次数
	%PLeve=%Player.GetLevel();
	%ZSNum=%Player.GetMetempsychosis();
	%PLeve=%PLeve+(%ZSNum*80);

	if (%PLeve < %Level)
	{
		%Txt="您的等级不够，无法激活该化身。";
		SendOneScreenMessage(2,%Txt,%Player);
		SendOneChatMessage($chatMsg_System,%Txt,%Player);
		return 0;
	}

	if (%Player.GetItemCount(%Item,1) > 0)
	{

		%Player.PutItem(%Item,-1);
		if (%Player.AddItem(4,%Item))
		{
			if (%Item==105090060)
				%Playe.AddObjectToPanel(2, 200400001, 19);

			return 1;
		}
	}
	else
	{
		%Txt="您没有" @ GetItemData(%Item,1) @ "，无法激活该化身。";
		SendOneScreenMessage(2,%Txt,%Player);
		SendOneChatMessage($chatMsg_System,%Txt,%Player);
		return 0;
	}
}
//■■■■■■■■■■■化神激活境界时触发■■■■■■■■■■■■■■■■■

//■■■■■■■■■■■副本内通知设置头顶标示■■■■■■■■■■■■■■■
function SetTitleCopy(%Player,%Num)
{
	//获取副本层
	%CopyMapID=%Player.GetLayerId();

	//获取玩家ID
	%T=SptCopyMap_GetAllPlayer(%CopyMapID);
	%T_Num=SptCopyMap_GetPlayerCount(%CopyMapID);
}
//■■■■■■■■■■■副本内通知设置头顶标示■■■■■■■■■■■■■■■



//■■■■■■■■■■■副本中给所有玩家添加调度状态命令■■■■■■■■■■
function AllSchbuff(%CopyMapID,%Buff)
{
	//获取队伍相关内容
	%TeammateList=SptCopyMap_GetAllPlayer(%CopyMapID);
	%TeammateNum=SptCopyMap_GetPlayerCount(%CopyMapID);

	//获取队伍相关内容
	for (%i=0; %i< %TeammateNum; %i++)
	{
		%Player=GetWord(%TeammateList,%i);	//获取玩家Player
		%PlayerID=%Player.GetPlayerID();		//获取玩家PlayerID

		//添加移除玩家出副本的倒计时BUFF
		%Player.SetSchbuff(%Buff);
	}
}
//■■■■■■■■■■■副本中给所有玩家添加调度状态命令■■■■■■■■■■


//■■■■■■■■■■■设置副本所有玩家头顶标记■■■■■■■■■■■■■■
function SetNpcTopMissionIconByCopyMapID(%CopyMapID,%NpcID,%Tey)
{
	%TeamList=SptCopyMap_GetAllPlayer(%CopyMapID);
	%TeamNum=SptCopyMap_GetPlayerCount(%CopyMapID);

	for (%i=0; %i< %TeamNum; %i++)
	{
		%Player=GetWord(%TeamList,%i);

		if (!isobject(%Player))
			continue;

		ServerOnSptAction(%Player.GetPlayerID(),%NpcID,%Tey);
	}
}
//■■■■■■■■■■■设置副本所有玩家头顶标记■■■■■■■■■■■■■■


//■■■■■■■■■■■兑换活跃积分成功触发■■■■■■■■■■■■■■■■
function Succeed_HuoYueJiFen(%Player,%Num)
{
}
//■■■■■■■■■■■兑换活跃积分成功触发■■■■■■■■■■■■■■■■


//■■■■■■■■■■■玩家提取元宝触发■■■■■■■■■■■■■■■■■■
function sptPlayerDrawGold(%Player,%gold)
{
	//echo("■■■■■玩家提取元宝触发■■■■■" @ %gold);
	//%Player.GetTotalDrawGold( ) 总的提取元宝数量
	%Time=GetLocalTime();
	%YY=GetWord(%Time,0);	//年
	%MM=GetWord(%Time,1);	//月
	%DD=GetWord(%Time,2);	//日
	//-----------积分反馈-----------
	%PveSorce = mfloor(%gold/100);
	if ($SL_ChongZhiFanKui_State_bActive == 1)
		%PveSorce = %PveSorce * 2;
	//echo("PveSorce========" @ PveSorce);
	if (%PveSorce > 0)
		%Player.Addmoney(%Pvesorce,7,1,5501);
	//-----------记录首充-----------
	%Act0=GetAct(%Player,4097,0)*1;
	%Act1=GetAct(%Player,4097,1)*1;
	if (%Act0!=1&&%Act1 < 1000)
	{
		%Act1=%Act1+%gold;
		if (%Act1>=1000)
			%Act1=10000;
		SetAct(%Player,4097,%Act0,%Act1);
	}
	//----------每日提取------------
	%Act0=GetAct(%Player,4095,0);
	%Act1=GetAct(%Player,4095,1);
	%Act1=%Act1+mfloor(%gold/100);
	if (%Act1>=30000)
		%Act1=30000;
	SetAct(%Player,4095,%Act0,%Act1);
	
	//连续5天充值送豪礼：设置奖励是否可领取
	getRecharge7DaysSetState(%Player, %gold);	
	
	

}
//■■■■■■■■■■■全服事件回调脚本■■■■■■■■■■■■■■■■■■
function ServerSystemEventUpdate(%LeiXin)
{
	echo("全服事件回调脚本==[" @ %LeiXin @ "]=====" @ GetServerSystemEvent(%LeiXin));
	//%LineID = GetCurrentLineId();//线程ID
	//GetServerSystemEvent( %LeiXin )
	//SetServerSystemEvent( 1312, 156, 0 );
	//-------------------注释 所有的全服事件都在这里备注----------------------
	//1 -> 99 记录当前线ID的 最高等级
	//100-->199 统计服务器星期0活跃人数，在线满半小时算活跃
	//200-->299 统计服务器星期1活跃人数，在线满半小时算活跃
	//300-->399 统计服务器星期2活跃人数，在线满半小时算活跃
	//400-->499 统计服务器星期3活跃人数，在线满半小时算活跃
	//500-->599 统计服务器星期4活跃人数，在线满半小时算活跃
	//600-->699 统计服务器星期5活跃人数，在线满半小时算活跃
	//700-->799 统计服务器星期6活跃人数，在线满半小时算活跃
	//800-->899 祈愿豪礼
	//%LineID @ %ZoneID  世界BOSS记录 11001-->991199
	//1000-->1100 仙缘解签活动 1000 + serverid
}
function DelServerSystemEvent(%LineID)//清除 %LineID 线需要清除的全服事件数据
{

	SetServerSystemEvent(1000,0,0);

	SetServerSystemEvent(%LineID,0,0);
	SetServerSystemEvent(100 + %LineID,0,0);
	SetServerSystemEvent(200 + %LineID,0,0);
	SetServerSystemEvent(300 + %LineID,0,0);
	SetServerSystemEvent(400 + %LineID,0,0);
	SetServerSystemEvent(500 + %LineID,0,0);
	SetServerSystemEvent(600 + %LineID,0,0);
	SetServerSystemEvent(700 + %LineID,0,0);
	SetServerSystemEvent(800 + %LineID,0,0);
	SetServerSystemEvent(1000 + %LineID,0,0);
}

//■■■■■■■■■■■传送地图时检查网格是否合法，否则传送初始位置■■■■
function GetZoneDefaultPosition(%ZoneID)
{
	switch (%ZoneID)
	{
		case 1101:return "222.281 37.416 104.021";
	}
}

//■■■■■■■■■■■设置特殊地图不显示玩家名称■■■■■■■■■■■■■
function Map_concealname(%Player)
{
	//获取副本DataID
	%CopyMapID=%Player.GetLayerId();
	%CopymapDataID=SptGetCopymapDataId(%CopyMapID);
	return 0;
}

//在线送积分活动：玩家上线时若当天还有领取积分卡的次数时，则添加一个领取积分卡的倒计时
//function OnLine_SendJiFenKa_100(%Player)
//{
//	if(Online_CanDoAddTimerControl(%Player, 1, 1) && Online_CanDoAddTimerControl(%Player, 2, 1))
//		%Player.AddTimerControl(5, 60 * 60 * 1000, 1, 0, 1, 1, "105103066");
//}



//■■■■■■■■■■■统一添加道具，若包裹已满则发送邮件■■■■■■■■■
function AddItem_BaoGuoNo_Mail(%Player,%ItemID,%ItemNum,%Property,%BeiYong)
{
	//获取是否是武魂
	if (GetItemData(%ItemID,2)==20)
	{
		////获取道具名称（邮件标题）
		//%ItemName = GetItemData( %ItemID, 1 );

		////邮件内容
		//%MailText = "恭喜您获得【" @ GetItemData( %ItemID, 1 ) @ "】，请注意查收。";

		////发送邮件
		//SptMail_Send( %Player.GetPlayerID( ), %ItemID, %ItemNum, 0, 0, "道具奖励", %MailText );

		//%Txt = "武魂【" @ GetItemData( %ItemID, 1 ) @ "】已通过邮件发送。";
		//SendOneScreenMessage( 1, %Txt, %Player );

		return;
	}

	//添加道具
	%index=%Player.PutItem(%ItemID,%ItemNum);

	if (%Property > 0)	//设置道具绑定
		%Player.SetPutItemProperty(%index,1,%Player.GetPlayerID());
	%MainType = 1;
	%SubType = 0;
	if (%BeiYong !$= "" && %BeiYong != 0)
	{
		%MainType = GetWord(%BeiYong, 0);
		%SubType = GetWord(%BeiYong, 1);
	}
	if (!%Player.AddItem(%MainType, %SubType))
	{
		//获取道具名称（邮件标题）
		%ItemName=GetItemData(%ItemID,1);

		//邮件内容
		%MailText="由于你的包裹已满，此次奖励由邮件的方式发送。";

		//发送邮件
		if (%Property > 0)	//设置道具绑定
			SptMail_SendBindPlayer(%Player.GetPlayerID(),%ItemID,%ItemNum,0,0,"道具奖励",%MailText,0,1);
		else
			SptMail_Send(%Player.GetPlayerID(),%ItemID,%ItemNum,0,0,"道具奖励",%MailText);

		%Txt="您的包裹已满，【" @ GetItemData(%ItemID,1) @ "】已通过邮件发送。";
		SendOneScreenMessage(1,%Txt,%Player);
	}
}
//■■■■■■■■■■■统一添加道具，若包裹已满则发送邮件■■■■■■■■■


//■■■■■■■■■■■判断获取月、日时间■■■■■■■■■■■■■■■■■
function GetHuoDongTime_Scope(%StartTime,%Endime)
{
	%Time=GetLocalTime();
	%MM=GetWord(%Time,1);	//月
	%DD=GetWord(%Time,2);	//日

	//当前时间
	%NowDD=%MM*31+%DD;

	//计算开始时间
	%StartDD=GetWord(%StartTime,0,".")*31+GetWord(%StartTime,1,".");

	//计算结束时间
	%DelDD=GetWord(GetWord(%Endime,0),0,".")*31+GetWord(GetWord(%Endime,0),1,".");

	if ((%NowDD>=%StartDD)&&(%NowDD<=%DelDD))
		return 1;

	return 0;
}

//■■■■■■■■■■■改名功能■■■■■■■■■■■■■■■■■■■■■■
//检查是否能设置改名标识，此脚本需要策划实现，成功返回1，失败返回0
function inspectSetRename(%Player)
{
	return 1;
}

//设置改名标识扣除相关消耗，此脚本需要策划实现，成功返回1，失败返回0
function processSetRename(%Player)
{
	%Player.PutItem(105109063,-1);
	if (%Player.AddItem(4,105109063))
	{
		%Player.ShowDialogOk(2000000034,0,0);
		return 1;
	}

	return 0;
}
//■■■■■■■■■■■改名功能■■■■■■■■■■■■■■■■■■■■■■


//■■■■■■■■■■【服务器公告】■■■■■■■■【可开启界面链接】■■■
function GetTraceButton(%cmd,%Txt)
{
	return "<c cid='Get_TraceButton()'cmd='\\\"" @ %cmd @ "\\\",\\\"<t u='0xbfff00ff' c='0xbfff00ff' o='0x010101ff'>"@%Txt@"</t>\\\",\\\"GuiMissionTraceButtonProfile6\\\"'cf='createButton' />";
}

function GetChatButton(%cmd,%Txt)
{
	return "<c cid='Get_ChatButton()'cmd='" @ "\"" @ %cmd @ "\",\"<t u='0xbfff00ff' c='0xbfff00ff' o='0x010101ff'>" @ %Txt @ "</t>\",\"GuiMissionTraceButtonProfile6\"'cf='createButton' />";
}
//■■■■■■■■■■【服务器公告】■■■■■■■■【可开启界面链接】■■■
//■■■■■■■■■■【商城相关】■■■■■■■■【商城购买物品触发】■■■
function BuyGoodsConsume(%optype, %Player, %GoldType, %GoldNumber, %ItemID, %ItemNum)//商城类型（0 元宝商城 1随机商城 2 快捷购买） 玩家对象 货币类型 货币数量 购买道具 购买数量
{
	//echo("商城购买物品触发---- 商店类型==" @ %optype @ " player== " @ %Player @ " 货币类型== " @ %GoldType @  " 货币数量== " @ %GoldNumber @ " 购买道具==" @ %ItemID @ "  道具名称==" @ getitemdata(%ItemID,1) @ " 购买数量==" @ %ItemNum);
}
//■■■■■■■■■■【商城相关】■■■■■■■■【商城购买物品触发】■■■

//■■■■■■■■■■【武魂相关】■■■■■■■■【每次搜魂触发】■■■■■
function SouHunChuFa(%Player)
{

}
//■■■■■■■■■■【武魂相关】■■■■■■■■【每次搜魂触发】■■■■■



//■■■■■■■■■■■■■■■【化神提升触发】■■■■■■■■■■■■■■
function Avatar_Addlevel(%player,%index)
{
	if (%index!=0)
		return;
	if (%player.IsAchieveAvatarLevel(0,21))
	{
		if (%Player.IsAcceptedMission(21621))
		{
			if (%Player.GetMissionFlag(21621,1300)==0)
			{
				%Player.SetMissionFlag(21621,1300,1,true);
				SendOneScreenMessage(1,"提升焰魔化神 1 / 1",%Player);
			}
		}
		else if (%Player.IsAcceptedMission(21622))
		{
			if (%Player.GetMissionFlag(21622,1300)==0)
			{
				%Player.SetMissionFlag(21622,1300,1,true);
				SendOneScreenMessage(1,"提升焰魔化神 1 / 1",%Player);
			}
		}
	}

	if (%player.IsAchieveAvatarLevel(0,41))
	{
		if (%Player.IsAcceptedMission(21623))
		{
			if (%Player.GetMissionFlag(21623,1300)==0)
			{
				%Player.SetMissionFlag(21623,1300,1,true);
				SendOneScreenMessage(1,"提升焰魔化神 1 / 1",%Player);
			}
		}
		else if (%Player.IsAcceptedMission(21624))
		{
			if (%Player.GetMissionFlag(21624,1300)==0)
			{
				%Player.SetMissionFlag(21624,1300,1,true);
				SendOneScreenMessage(1,"提升焰魔化神 1 / 1",%Player);
			}
		}
	}

	if (%player.IsAchieveAvatarLevel(0,61))
	{
		if (%Player.IsAcceptedMission(21613))
		{
			if (%Player.GetMissionFlag(21613,1300)==0)
			{
				%Player.SetMissionFlag(21613,1300,1,true);
				SendOneScreenMessage(1,"提升焰魔化神 1 / 1",%Player);
			}
		}
		else if (%Player.IsAcceptedMission(21614))
		{
			if (%Player.GetMissionFlag(21614,1300)==0)
			{
				%Player.SetMissionFlag(21614,1300,1,true);
				SendOneScreenMessage(1,"提升焰魔化神 1 / 1",%Player);
			}
		}
	}
}

//■■■■■■■■■■■■■■■【神兽变异触发】■■■■■■■■■■■■■■
function Pet_SpringEvolve(%player,%index)
{

}

//■■■■■■■■■■■■■■■【经脉冲穴触发】■■■■■■■■■■■■■■
function GodPrint_SpringActive(%player,%index)
{
}

//■■■■■■■■■■■■■■■【搜出橙色武魂触发】■■■■■■■■■■■■
function GuanXing_addItem(%player,%itemid,%level)  //参数1 player 参数2 物品ID 参数3 物品颜色等级
{
	
}


//■■■■■■■■■■■■■■■【野外换线相关】■■■■■■■■■■■■■■
function ChangeMapLineSendMspID(%Player,%MapID)
{
	//获取玩家等级
	%PlayerLeve=%Player.GetLevel();
	%PlayerPos=%Player.GetPosition();

	if (GetDispatchLevel(%Player,%MapID)==1)
		%Player.TransportObject(0,%MapID,GetWord(%PlayerPos,0),GetWord(%PlayerPos,1),GetWord(%PlayerPos,2));
}


//■■■■■■■■■■■■■■■【获取当前队伍的队长】■■■■■■■■■■■
function GetTeamMaster(%Player)
{
	%PlayerID=%Player.GetPlayerID();
	if (!SvrIsMyselfHasTeam(%PlayerID))//判断当前玩家是否有队伍,如果没有 返回自己
		return %Player;
	if (SvrIsMyselfCaption(%PlayerID))//判断当前玩家是否为队长
		return %Player;
	%TeamList=SvrGetTeammate(%PlayerID,255);//获取当前玩家队伍内所有队员的player
	%TeamNum=GetWordCount(%TeamList);
	for (%i=0; %i < %TeamNum; %i++)
	{
		%Target=GetWord(%TeamList,%i);
		if (SvrIsMyselfCaption(%Target.GetPlayerID()))
		{
			%Master=%Target;
			break;
		}
	}
	if (isobject(%Master))
		return %Master;
	else
		return %Player;
}

//■■■■■■■■■■■■■■■【获取当前队伍的队长】■■■■■■■■■■■


//■■■■■■■■■■■■■■■【攻略界面在服务端的记录】■■■■■■■■■
function SetStrategyRecord(%Player,%optype)
{
	//装备鉴定 90
	//装备重铸 92
	//装备精炼 94
	//装备强化 88
	putout("攻略界面在服务端的记录====" @ %optype);
	if (%Player.GetLevel() < 20)
		return;
	if (GetSrc(%Player,%optype)==0)
	{
		if ($Src_ReturnTime[%optype]!=$Src_ClearTime_Never)
			return;
		SetSrc(%Player,%optype);
		HelpDirectByIndex(%Player.GetPlayerID(),11);	//通讯客户端
	}
	else
		return;
}

//■■■■■■■■■■■■■■■【攻略界面在服务端的记录】■■■■■■■■■

//■■■■■■■■■■■■■■■【使用喇叭诅咒和祝福】■■■■■■■■■■■
function DamnationHorn(%CasterID,%PlayerID)//诅咒
{
	%Player=SptGetPlayer(%PlayerID);
	if (%Player.GetBuffCount(39025,1)>=1)
		return;
	//echo("诅咒    %Caster===" @ %Caster @ "    %Player===" @ %Player);
	//诅咒 增加自身buff 390230001一层
	%CountZhuFu=%Player.GetBuffCount(39024,1);
	%CountZuZhou=%Player.GetBuffCount(39023,1);
	if (%CountZhuFu > 0)
	{
		%Player.AddBuff(390240001,%Player,-1);
	}
	else
	{
		switch (%CountZuZhou)
		{
			case 0:%Ran=10000;
			case 1:%Ran=8000;
			case 2:%Ran=7000;
			case 3:%Ran=6000;
			case 4:%Ran=5000;
			case 5:%Ran=4500;
			case 6:%Ran=4000;
			case 7:%Ran=3700;
			case 8:%Ran=3400;
			case 9:%Ran=3100;
			case 10:%Ran=2800;
			case 11:%Ran=2500;
			case 12:%Ran=2000;
			case 13:%Ran=1500;
			case 14:%Ran=1500;
			case 15:%Ran=1500;
			case 16:%Ran=1500;
			case 17:%Ran=1500;
			case 18:%Ran=1500;
			case 19:%Ran=1500;
			case 20:%Ran=1500;
		}
		%Random=GetRandom(1,10000);
		if (%Random<=%Ran)
		{
			%Player.AddBuff(390230001,%Player,1);
			%Text="您被诅咒了，当前诅咒点数：" @ %Player.GetBuffCount(39023,1) @ "，请注意安全。";
			SendOneScreenMessage(2,%Text,%Player);
			SendOneChatMessage($chatMsg_System,%Text,%Player);
		}
	}
}
function BlessingHorn(%CasterID,%PlayerID)//祝福 
{
	%Player=SptGetPlayer(%PlayerID);
	//echo("祝福    %CasterID===" @ %CasterID @ "    %Player===" @ %Player);
	//示爱 增加自身buff 390240001一层 
	%CountZhuFu=%Player.GetBuffCount(39024,1);
	%CountZuZhou=%Player.GetBuffCount(39023,1);

	if (%CountZuZhou > 0)
	{
		%Player.AddBuff(390230001,%Player,-1);
	}
	else
	{
		switch (%CountZhuFu)
		{
			case 0:%Ran=10000;
			case 1:%Ran=8000;
			case 2:%Ran=7000;
			case 3:%Ran=6000;
			case 4:%Ran=5000;
			case 5:%Ran=4500;
			case 6:%Ran=4000;
			case 7:%Ran=3700;
			case 8:%Ran=3400;
			case 9:%Ran=3100;
			case 10:%Ran=2800;
			case 11:%Ran=2500;
			case 12:%Ran=2000;
			case 13:%Ran=1500;
			case 14:%Ran=1500;
			case 15:%Ran=1500;
			case 16:%Ran=1500;
			case 17:%Ran=1500;
			case 18:%Ran=1500;
			case 19:%Ran=1500;
			case 20:%Ran=1500;
		}
		%Random=GetRandom(1,10000);
		if (%Random<=%Ran)
		{
			%Player.AddBuff(390240001,%Player,1);
			%Text="您被祝福了，当前祝福点数：" @ %Player.GetBuffCount(39024,1) @ "。";
			SendOneScreenMessage(2,%Text,%Player);
			SendOneChatMessage($chatMsg_System,%Text,%Player);
		}

	}
}

//■■■■■■■■■■■■■■■【使用喇叭诅咒和祝福】■■■■■■■■■■■



//■■■■■■■■■■■■■■■【成就添加接口】■■■■■■■■■■■■■■
//forAddAchievementWatch(263385);
function forAddAchievementWatch(%player)
{
	for (%i = 0; %i <=200; %i++)
	{
		AddAchievementWatch(%player, 0, 34, 1);
	}
}
function AddAchievementWatch(%Player,%MainType,%Subtype,%Sorce)
{
	// 0 30	首座论经
	// 0 31	冰火试炼
	// 0 32	悬赏缉凶
	// 0 33	紫星传功
	// 0 34	师门尽忠
	// 0 35	黄金宝藏
	// 0 36	云罗镜
	// 0 37	血魔封印阵
	// 0 38	镇魔殿
	// 0 39	炼魔渊
	// 0 40	群英汇聚
	// 0 41	时空裂痕
	// 0 42	蓬莱仙钓
	// 0 43	鸿蒙试炼
	// 0 44	押镖
	// 0 45	刀剑神域
	// 0 47 蓬莱仙钓第一名
	// 0 48 蓬莱仙钓第二名
	// 0 49 押镖-紫色以及以上镖车
	// 0 50 烹饪出4级食物
	// 0 51 制作出4级符咒
	// 0 52 炼丹制作4级丹药
	// 0 53 铸造出70级武器
	// 0 54 制器出70级饰品
	// 0 55 缝纫出70级防具
	// 1 172 帮派贡献
	// 1 173 炼魔渊最高关卡数
	// 1 174 趣味答题排名

	%Player.PlayerAchieveCount(%MainType,%Subtype,%Sorce,0);
}

//■■■■■■■■■■■■■■■【成就添加接口】■■■■■■■■■■■■■■

//■■■■■■■■■■■■■■■【删除包裹道具】■■■■■■■■■■■■■■
function DelBackpack_HavingItem(%Player)
{
	for (%i=1; %i<=120; %i++)
	{
		%List=%Player.Getitemnum(%i);
		%ItemID=GetWord(%List,0,",");
		%NumBer=GetWord(%List,1,",");
		if (%NumBer > 0&&%ItemID!=108020208)
			DelItemFromInventoryByIndex(%Player.GetPlayerID(),%i,0,%NumBer,0,0);
	}
}
function GetBackpack_HavingItem(%Player)
{
	for (%i=0; %i<=320; %i++)
	{
		%List=%Player.Getitemnum(%i);
		%ItemID=GetWord(%List, 0, ",");
		%NumBer=GetWord(%List, 1, ",");
		if (%NumBer > 0)
		{
			echo("包裹栏位===  " @ %i @ "    道具信息 ==  " @ %ItemID @ "    " @ %NumBer);
		}
	}
}
//■■■■■■■■■■■■■■■【删除包裹道具】■■■■■■■■■■■■■■

//■■■■■■■■■■■定位符免费次数记录■■■■■■■■■■■■■■■■■
function setTransmissionFreeCount(%Player,%raffleCount,%afreshCount)
{
	return;
}
//■■■■■■■■■■■定位符免费次数记录■■■■■■■■■■■■■■■■■