//==================================================================================
//注：所有脚本开头，均需注明本脚本的大致说明文字
//
//
//鸿蒙试炼
//==================================================================================
//sptgetplayer( 50000022).transportobject(0,0,-6.36813 ,5.37865, 112.794);

$YunXianJie_TriggerIDPos[813040101] = "1.59172 147.923 158.045"; //准备区
$YunXianJie_TriggerIDPos[813040205] = "-6.36813 5.37865 112.794"; //四象祭台
$YunXianJie_TriggerIDPos[813040405] = "-132.17 137.087 110.887"; //青龙
$YunXianJie_TriggerIDPos[813040505] = "-131.698 -143.284 111.018"; //玄武
$YunXianJie_TriggerIDPos[813040605] = "133.044 -142.468 111.017"; //白虎
$YunXianJie_TriggerIDPos[813040305] = "133.346 137.066 111.017"; //朱雀

$YunXianJie_TriggerIDName[813040101] = "准备区";//
$YunXianJie_TriggerIDName[813040205] = "四象祭台";//
$YunXianJie_TriggerIDName[813040405] = "青龙界域";//
$YunXianJie_TriggerIDName[813040505] = "玄武界域";//
$YunXianJie_TriggerIDName[813040605] = "白虎界域";//
$YunXianJie_TriggerIDName[813040305] = "朱雀界域";//

$YunXianJie_TriggerIDPos[813040205,1] = "-6.84019 4.47108 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,2] = "-5.1547 9.37213 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,3] = "-0.455679 11.2798 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,4] = "-2.88864 14.7005 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,5] = "-2.16425 18.0705 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,6] = "-0.246339 19.5108 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,7] = "4.20319 16.5556 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,8] = "4.26806 9.35064 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,9] = "1.80887 4.11309 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,10] = "-2.01318 1.2536 111.446"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,11] = "-5.36138 -4.13522 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,12] = "-14.0112 -6.18639 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,13] = "-19.4009 -5.2127 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,14] = "-12.5976 -14.9046 112.167"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,15] = "-6.96952 -12.2531 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,16] = "-3.71106 -16.9475 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,17] = "-0.858615 -21.0177 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,18] = "2.16895 -26.0338 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,19] = "5.64952 -23.1966 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,20] = "6.89615 -18.9989 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,21] = "4.4898 -15.8301 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,22] = "2.31645 -17.3335 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,23] = "1.58085 -14.5273 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,24] = "1.77359 -9.24771 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,25] = "8.17321 -9.70487 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,26] = "12.082 -9.13972 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,27] = "16.8416 -8.69498 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,28] = "19.104 -5.56626 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,29] = "17.0407 -2.34631 111.08"; //四象祭台随机坐标
$YunXianJie_TriggerIDPos[813040205,30] = "11.6817 -2.02046 111.08"; //四象祭台随机坐标
//---传送信息保存  目标区域ID 需要刷新的NPC 当前区域坐标 
$YunXianJie_TransPortTriggerIDInfo[813040201] = "813040405;413040002;-32.6007 30.9605 113.7;";//通往青龙
$YunXianJie_TransPortTriggerIDInfo[813040202] = "813040505;413040005;-31.4107 -34.7943 113.7;";//通往玄武
$YunXianJie_TransPortTriggerIDInfo[813040203] = "813040605;413040004;34.3288 -34.5598 113.7;";//通往白虎
$YunXianJie_TransPortTriggerIDInfo[813040204] = "813040305;413040003;34.1328 31.9501 113.7;";//通往朱雀
$YunXianJie_TransPortTriggerIDInfo[813040301] = "813040405;413040002;111.391 181.738 115.977;";//通往青龙
$YunXianJie_TransPortTriggerIDInfo[813040302] = "813040505;413040005;127.108 186.268 115.977;";//通往玄武
$YunXianJie_TransPortTriggerIDInfo[813040303] = "813040605;413040004;182.129 132.412 115.977;";//通往白虎
$YunXianJie_TransPortTriggerIDInfo[813040304] = "813040205;413040001;178.023 116.313 115.977;";//通往四象
$YunXianJie_TransPortTriggerIDInfo[813040401] = "813040205;413040001;-128.921 185.192 115.847;";//通往四象
$YunXianJie_TransPortTriggerIDInfo[813040402] = "813040505;413040005;-111.196 180.839 115.847;";//通往玄武
$YunXianJie_TransPortTriggerIDInfo[813040403] = "813040605;413040004;-175.868 115.678 115.847;";//通往白虎
$YunXianJie_TransPortTriggerIDInfo[813040404] = "813040305;413040003;-180.58 133.085 115.847;";//通往朱雀
$YunXianJie_TransPortTriggerIDInfo[813040501] = "813040405;413040002;-179.804 -141.494 115.977;";//通往青龙
$YunXianJie_TransPortTriggerIDInfo[813040502] = "813040205;413040001;-175.376 -122.555 115.977 ;";//通往四象
$YunXianJie_TransPortTriggerIDInfo[813040503] = "813040605;413040004;-111.258 -186.262 115.977;";//通往白虎
$YunXianJie_TransPortTriggerIDInfo[813040504] = "813040305;413040003;-129.522 -191.77 115.977;";//通往朱雀
$YunXianJie_TransPortTriggerIDInfo[813040601] = "813040405;413040002;131.758 -189.935 115.977;";//通往青龙
$YunXianJie_TransPortTriggerIDInfo[813040602] = "813040505;413040005;113.952 -185.459 115.977;";//通往玄武
$YunXianJie_TransPortTriggerIDInfo[813040603] = "813040205;413040001;177.702 -120.674 115.977;";//通往四象
$YunXianJie_TransPortTriggerIDInfo[813040604] = "813040305;413040003;182.992 -138.215 115.977;";//通往朱雀

//--------彩蛋的BUFF和特效------------
$YunXianJie_Buff[1] ="399110001 900151";//攻击提高30%
$YunXianJie_Buff[2] ="399110002 900151";//攻击提高50%
$YunXianJie_Buff[3] ="399110003 900151";//攻击提高100%
$YunXianJie_Buff[4] ="399120001 900152";//移动速度提高30%
$YunXianJie_Buff[5] ="399120002 900152";//移动速度提高50%
$YunXianJie_Buff[6] ="399120003 900152";//移动速度提高100%
$YunXianJie_Buff[7] ="399130001 900153";//物理防御提高30%
$YunXianJie_Buff[8] ="399130002 900153";//物理防御提高50%
$YunXianJie_Buff[9] ="399130003 900153";//物理防御提高100%
$YunXianJie_Buff[10]="399140001 900154";//法术防御提高30%
$YunXianJie_Buff[11]="399140002 900154";//法术防御提高50%
$YunXianJie_Buff[12]="399140003 900154";//法术防御提高100%
$YunXianJie_Buff[13]="399150001 900155";//持续回复, 每秒5%
$YunXianJie_Buff[14]="399150002 900155";//持续回复, 每秒10%
$YunXianJie_Buff[15]="399150003 900155";//持续回复, 每秒15%
$YunXianJie_Buff[16]="399160001 900156";//隐身，攻击会显形


//■■■■【鸿蒙试炼】■■■■【活动开启公告】■■■■■■■
//■■■■【鸿蒙试炼】■■■■【 NPC对话触发】■■■■■■■
//■■■■【鸿蒙试炼】■■■■【玩家进入副本】■■■■■■■
//■■■■【鸿蒙试炼】■■■■【副本创建触发】■■■■■■■
//■■■■【鸿蒙试炼】■■■■【区域触发】■■■■■■■■■
//■■■■【鸿蒙试炼】■■■■【调度状态触发】■■■■■■■
//■■■■【鸿蒙试炼】■■■■【区域损毁】■■■■■■■■■
//■■■■【鸿蒙试炼】■■■■【创建采集物】■■■■■■■■
//■■■■【鸿蒙试炼】■■■■【开战集体传送】■■■■■■■
//■■■■【鸿蒙试炼】■■■■【副本结束处理】■■■■■■■
//■■■■【鸿蒙试炼】■■■■【采集物触发】■■■■■■■■
//■■■■【鸿蒙试炼】■■■■【数据发送】■■■■■■■■■
//■■■■【鸿蒙试炼】■■■■【死亡触发】■■■■■■■■■

//■■■■【鸿蒙试炼】■■■■【活动开启公告】■■■■■■■
function YunXianJie_Msg(%YY,%MM,%DD,%H,%M,%S)
{
	if ($SL_YunXianJie_bActive != 1)
		return;
	if (getzoneid() != 1001)
		return;

	%LocalWeek = GetLocalWeek();
	%Count = GetWordCount($SL_YunXianJie_Week);
	%Mark = 0;
	for (%i=0; %i < %Count; %i++)
	{
		%OpenWeek = GetWord($SL_YunXianJie_Week,%i) * 1;
		if (%OpenWeek == %LocalWeek)
		{
			%Mark = 1;
			break;
		}
	}
	if (%Mark != 1)
		return;

	%TimeNow = %H * 60 + %M;
	%TimeStart = GetWord($SL_YunXianJie_StartTime,0,":") * 60 + GetWord($SL_YunXianJie_StartTime,1,":");
	%Havetime = %TimeStart - %TimeNow;
	//echo( "%Havetime==" @ %Havetime );
	if (%Havetime == 10 || %Havetime == 5 || %Havetime == 0)
	{
		%HuoDongMingCheng = GetHuoDongName("鸿蒙试炼",1);
		%Path = "<l i=' 810010100 -60.3971 -91.7681 185.627' t='path'/>";

		if (%Havetime > 0)
		{
			%Text = %HuoDongMingCheng @ "<t>将在 </t>" @ $Get_Dialog_GeShi[31420] @ %Havetime @ "</t><t> 分钟后开启，" @ $SL_YunXianJie_Level @ "级以上修士可前往</t>" @ %Path @ "<t>参与挑战。</t>";
			%Text2 = GetHuoDongName("鸿蒙试炼",2) @ "<t>将于</t>" @ $Get_Dialog_GeShi[60002] @ %Havetime @ "</t><t>分钟后开启。</t>";
		}
		else
		{
			%Text = %HuoDongMingCheng @ "<t>已经开启，" @ $SL_YunXianJie_Level @ "级以上修士可前往</t>" @ %Path @ "<t>参与挑战。</t>";
			%Text2 = GetHuoDongName("鸿蒙试炼",2) @ "<t>已经开启。</t>";
		}

		SendOneLineMessage($Get_Dialog_GeShi[31419] @ %Text @ "</t>");
		SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
	}
}
//■■■■【鸿蒙试炼】■■■■【活动开启公告】■■■■■■■

//■■■■【鸿蒙试炼】■■■■【 NPC对话触发】■■■■■■■
function NpcOnTrigger_Dialog_410010212(%Npc,%Player,%State,%Conv,%Param)
{
	if ($SL_HuanJingZhengBa_bActive != 1)
		return;
	%MapID =GetSubStr(getzoneid(),0,4);
	%Src5 = getsrc(%player,5);
	%Src6 = getsrc(%player,6);

	%Time = GetLocalTime();
	%YY = GetWord(%Time,0);	//年
	%MM = GetWord(%Time,1);	//月
	%DD = GetWord(%Time,2);	//日
	%H = GetWord(%Time,3);	//小时
	%M = GetWord(%Time,4);	//分钟
	%PlayerID = %Player.GetPlayerID();
	switch (%state)
	{
		case 0:
			%Conv.SetText(600000029);
			if (%MapID == 1001 && %Src5 == 0)
			{
				//echo( " %MapID ==" @  %MapID );
				//echo( " %Src5 ==" @  %Src5 );
				%Conv.AddOption(600000030,600000030);
			}
			//if ( %Src6 == 0 && %Src5 == 1 )
			//	%Conv.AddOption( 600000031, 600000031 );
		case 600000030:
			%Conv.Settype(4);
			if (%H == 20 && %M <= 5)
			{
				%Level = %Player.getlevel();
				if (%Level >= $SL_YunXianJie_Level)
				{
					if (SvrIsMyselfHasTeam(%PlayerID) == 0)
					{
						%Level[1,1] = getword($SL_YunXianJie_Level[1307],0);
						%Level[1,2] = getword($SL_YunXianJie_Level[1307],1);
						%Level[2,1] = getword($SL_YunXianJie_Level[1308],0);
						%Level[2,2] = getword($SL_YunXianJie_Level[1308],1);
						%Level[3,1] = getword($SL_YunXianJie_Level[1309],0);
						%Level[3,2] = getword($SL_YunXianJie_Level[1309],1);
						if (%Level >= %Level[3,1] && %Level <= %Level[3,2])
							%Targetcopymap = 1309;
						else if (%Level >= %Level[2,1] && %Level <= %Level[2,2])
							%Targetcopymap = 1308;
						else if (%Level >= %Level[1,1] && %Level <= %Level[1,2])
							%Targetcopymap = 1307;

						if (%Targetcopymap > 0)
							GoToNextMap(%Player,%Targetcopymap,"");// "<t>传送【鸿蒙试炼】</t>";
					}
					else
					{
						SendOneScreenMessage(2,"只允许单人进入，请先离开队伍",%player);
						SendOneChatMessage($chatMsg_System,"<t>只允许单人进入，请先离开队伍</t>",%player);
						return;
					}
				}
				else
				{
					SendOneScreenMessage(2,$SL_YunXianJie_Level @ "级以上修士才可参加鸿蒙试炼",%player);
					SendOneChatMessage($chatMsg_System,"<t>" @ $SL_YunXianJie_Level @ "级以上修士才可参加鸿蒙试炼</t>",%player);
					return;
				}
			}
			else
			{
				SendOneScreenMessage(2,"不在报名时间内，无法进入",%player);
				SendOneChatMessage($chatMsg_System,"<t>不在报名时间内，无法进入！</t>",%player);
				return;
			}
			//case 600000031://发放奖励
			//	%Conv.Settype( 4 );
			//	SetSrc( %player, 6 );
			//	SendOneScreenMessage( 2, "领取成功", %player );
			//	SendOneChatMessage( $chatMsg_System, "<t>领取成功</t>", %player );
	}
}
//■■■■【鸿蒙试炼】■■■■【 NPC对话触发】■■■■■■■

//■■■■【鸿蒙试炼】■■■■【玩家进入副本】■■■■■■■
function SptCopymap_OnEnter_1307_Trigger(%CopyMapID,%Player){ Cancel(%Player.Copymap1307); %Player.Copymap1307 = Schedule(5000,0,"SptCopymap_OnEnter_1307_Trigger_A",%CopyMapID,%Player); }
function SptCopymap_OnEnter_1308_Trigger(%CopyMapID,%Player){ Cancel(%Player.Copymap1307); %Player.Copymap1307 = Schedule(5000,0,"SptCopymap_OnEnter_1307_Trigger_A",%CopyMapID,%Player); }
function SptCopymap_OnEnter_1309_Trigger(%CopyMapID,%Player){ Cancel(%Player.Copymap1307); %Player.Copymap1307 = Schedule(5000,0,"SptCopymap_OnEnter_1307_Trigger_A",%CopyMapID,%Player); }

function SptCopymap_OnEnter_1307_Trigger_A(%CopyMapID,%Player)
{
	%Player.SetShapename("神秘修士");
	SetSrc(%player,5);
	%Player.setschbuff(2004);	//添加调度状态
	CopyMap1304SendStringToOnePlayer(%Player,"0 0 0 0 0 7200");
}

//■■■■【鸿蒙试炼】■■■■【玩家进入副本】■■■■■■■

//■■■■【鸿蒙试炼】■■■■【副本创建触发】■■■■■■■
function SvrCopymapOpen_1307_Trigger(%CopyMapID,%CopymapDataID){ SvrCopymapOpen_1307_Trigger_A(%CopyMapID,%CopymapDataID); }
function SvrCopymapOpen_1308_Trigger(%CopyMapID,%CopymapDataID){ SvrCopymapOpen_1307_Trigger_A(%CopyMapID,%CopymapDataID); }
function SvrCopymapOpen_1309_Trigger(%CopyMapID,%CopymapDataID){ SvrCopymapOpen_1307_Trigger_A(%CopyMapID,%CopymapDataID); }
function SvrCopymapOpen_1307_Trigger_A(%CopyMapID,%CopymapDataID)
{
	for (%i = 2; %i <= 6; %i++)
	{
		for (%j = 1; %j <=4; %j++)
		{
			%TriggerID = 813040000 + %i * 100 + %j;
			if ($YunXianJie_TransPortTriggerIDInfo[%TriggerID] !$= "")
			{
				%NpcID = GetWord($YunXianJie_TransPortTriggerIDInfo[%TriggerID],1,";");
				%Pos = GetWord($YunXianJie_TransPortTriggerIDInfo[%TriggerID],2,";");
				$YunXianJieNpcRecord[%CopyMapID,%i,%j] = SpNewNpc3(0,%NpcID,%Pos,%CopyMapID,0,"1 1 1");
			}
		}
	}
	//%Time = GetLocalTime();
	//%H = getword(%Time, 3);
	//%M = getword(%Time, 4);
	//%Times = (%H * 60 +%M) * 60;
	//%TimeEnd = (20 * 60 + 30) * 60;
	//%Havetime = %TimeEnd - %Times;
	//if (%Havetime > 1800)
	//	%Havetime = 1800;

	%Havetime = 1800;
	Cancel($ScheduleCopymap1307[%CopyMapID]);//先清除倒计时
	$ScheduleCopymap1307[%CopyMapID] = Schedule(10 * 1000,0,"ScheduleCopymap1307",%CopyMapID,%Havetime,0);
}
function ScheduleCopymap1307(%CopyMapID,%Havetime,%Step)//战斗流程函数
{
	putout("%Havetime ===" @ %Havetime @ "    %Step===" @ %Step @ "    人数====" @ $TeammateNum[%CopyMapID]);
	Cancel($ScheduleCopymap1307[%CopyMapID]);//先清除倒计时
	$BattleTimeRecord[%CopyMapID] = %Step;//副本战斗时间
	%CdTime = 10;//10秒自循环
	if (%Step == 0)//初始化各种数据
	{
		$Tirggerlist[%CopyMapID,813040205] = 0;//四象祭台 完好无损并且没有人
		$Tirggerlist[%CopyMapID,813040405] = 0;//青龙区域 完好无损并且没有人
		$Tirggerlist[%CopyMapID,813040605] = 0;//白虎区域 完好无损并且没有人
		$Tirggerlist[%CopyMapID,813040305] = 0;//朱雀区域 完好无损并且没有人
		$Tirggerlist[%CopyMapID,813040505] = 0;//玄武区域 完好无损并且没有人
		$TeammateList[%CopyMapID] = SptCopyMap_GetAllPlayer(%CopyMapID);//获取副本玩家信息
		$TeammateNum[%CopyMapID] = SptCopyMap_GetPlayerCount(%CopyMapID);//获取副本玩家数量
	}
	else if (%Step < 300)
	{
		$TeammateList[%CopyMapID] = SptCopyMap_GetAllPlayer(%CopyMapID);//获取副本玩家信息
		$TeammateNum[%CopyMapID] = SptCopyMap_GetPlayerCount(%CopyMapID);//获取副本玩家数量
		if ($TeammateNum[%CopyMapID] >= 20)//可以开始战斗了
			%Step = 290;
		else
		{
			if (%Step%30 == 0)
			{
				%text = "副本人数不足，请耐心等待，当前人数：" @ $TeammateNum[%CopyMapID];
				SendAllChatMessageLayer(0,$Get_Dialog_GeShi[31406]  @ %text @ "</t>",%CopyMapID);	//发送副本层消息( 屏幕左下 )
				SendAllScreenMessageLayer(1,%text,%CopyMapID);	//发送副本层消息( 屏幕中间 )
			}
		}
	}
	else if (%Step == 300)
	{
		$TeammateList[%CopyMapID] = SptCopyMap_GetAllPlayer(%CopyMapID);//获取副本玩家信息
		$TeammateNum[%CopyMapID] = SptCopyMap_GetPlayerCount(%CopyMapID);//获取副本玩家数量
		if ($TeammateNum[%CopyMapID] >= 2)//可以开始战斗了
		{
			%text = "还有30秒开战，请做好准备";
			SendAllChatMessageLayer(0,$Get_Dialog_GeShi[31406]  @ %text @ "</t>",%CopyMapID);	//发送副本层消息( 屏幕左下 )
			SendAllScreenMessageLayer(0,%text,%CopyMapID);	//发送副本层消息( 屏幕中间 )
		}
		else
		{
			%text = "因副本人数不足，无法开启陨仙界副本，请领取奖励后有序离开战场";
			SendAllChatMessageLayer(0,$Get_Dialog_GeShi[31406]  @ %text @ "</t>",%CopyMapID);	//发送副本层消息( 屏幕左下 )
			SendAllScreenMessageLayer(0,%text,%CopyMapID);	//发送副本层消息( 屏幕中间 )
			closecopymap1307(%CopyMapID);
			return;
		}
	}
	if (%Step >= 320 && %Step < 330)
	{
		%text = "还有" @ 330 - %Step @ "秒开战，请做好准备";
		SendAllChatMessageLayer(0,$Get_Dialog_GeShi[31406]  @ %text @ "</t>",%CopyMapID);	//发送副本层消息( 屏幕左下 )
		SendAllScreenMessageLayer(0,%text,%CopyMapID);	//发送副本层消息( 屏幕中间 )
		%CdTime = 1;
	}
	if (%Step == 330)
		SvrCopymapOpen_1307_TriggerB(%CopyMapID,%CopymapDataID);//开战传送


	//-----------------------区域毁坏-----------------------------
	if (%Step > 400 && %Step%300 == 0)
	{
		echo("-----------------------区域毁坏-----------------------");
		HuiDiaoYiGeQuYu(%CopyMapID,0,0);
		createcj1307(%CopyMapID,1);//刷一波BUFF
	}
	//-----------------------统计人数-----------------------------
	if (%Step%30 == 0 && %Step >= 300)
	{
		$LiveJieYu[%CopyMapID] = 0;//存活的界域数量
		$LivePeople[%CopyMapID] = 0;//战斗区域内的玩家数量
		if ($Tirggerlist[%CopyMapID,813040205] != -1){ $Tirggerlist[%CopyMapID,813040205] = 0;$LiveJieYu[%CopyMapID]++; }//四象祭台
		if ($Tirggerlist[%CopyMapID,813040405] != -1){ $Tirggerlist[%CopyMapID,813040405] = 0;$LiveJieYu[%CopyMapID]++; }//青龙区域
		if ($Tirggerlist[%CopyMapID,813040605] != -1){ $Tirggerlist[%CopyMapID,813040605] = 0;$LiveJieYu[%CopyMapID]++; }//白虎区域
		if ($Tirggerlist[%CopyMapID,813040305] != -1){ $Tirggerlist[%CopyMapID,813040305] = 0;$LiveJieYu[%CopyMapID]++; }//朱雀区域
		if ($Tirggerlist[%CopyMapID,813040505] != -1){ $Tirggerlist[%CopyMapID,813040505] = 0;$LiveJieYu[%CopyMapID]++; }//玄武区域

		$TeammateList[%CopyMapID] = SptCopyMap_GetAllPlayer(%CopyMapID);//获取副本玩家信息
		$TeammateNum[%CopyMapID] = SptCopyMap_GetPlayerCount(%CopyMapID);//获取副本玩家数量
		for (%i=0; %i< $TeammateNum[%CopyMapID]; %i++)
		{
			%Player = getword($TeammateList[%CopyMapID],%i);
			%TriggerID = %Player.GetTriggerID();
			if ($Tirggerlist[%CopyMapID,%TriggerID] != -1)
				$Tirggerlist[%CopyMapID,%TriggerID]++;
		}
		for (%i=0; %i< $TeammateNum[%CopyMapID]; %i++)
		{
			%Player = getword($TeammateList[%CopyMapID],%i);
			$CopyMapMsgRecord[%CopyMapID] = $Tirggerlist[%CopyMapID,813040205] @ " " @ $Tirggerlist[%CopyMapID,813040405] @ " " @ $Tirggerlist[%CopyMapID,813040605] @ " " @ $Tirggerlist[%CopyMapID,813040305] @ " " @ $Tirggerlist[%CopyMapID,813040505] @ " " @ %Havetime;
			//echo( "$CopyMapMsgRecord[ %CopyMapID ] ==" @ $CopyMapMsgRecord[ %CopyMapID ] );
			CopyMap1304SendStringToOnePlayer(%Player,$CopyMapMsgRecord[%CopyMapID]);
		}
		for (%i = 2; %i<=6; %i++)
		{
			%Tri = 813040005 + %i * 100;
			if ($Tirggerlist[%CopyMapID,%Tri] > 0)
				$LivePeople[%CopyMapID] = $LivePeople[%CopyMapID] + $Tirggerlist[%CopyMapID,%Tri];
		}
	}
	//-----------------------刷新宝箱-----------------------
	if ($LiveJieYu[%CopyMapID] == 1 &&  %Step%60 == 0)
	{
		echo("-----------------------刷新宝箱-----------------------");
		if (%Step > 1700)
			createcj1307(%CopyMapID,3);
		else
			createcj1307(%CopyMapID,2);
	}

	//------------------------倒计时-----------------

	%Havetime = %Havetime - %CdTime;
	%Step = %Step + %CdTime ;

	if (%Havetime > 0 && $TeammateNum[%CopyMapID] > 0)
		$ScheduleCopymap1307[%CopyMapID] = Schedule(%CdTime * 1000,0,"ScheduleCopymap1307",%CopyMapID,%Havetime,%Step);
	else
		closecopymap1307(%CopyMapID);
}

//■■■■【鸿蒙试炼】■■■■【副本创建触发】■■■■■■■


//■■■■【鸿蒙试炼】■■■■【区域触发】■■■■■■■■■
function PlayerEnterTrigger_813040101(%Player,%TriggerId){ YunXianJie_EndterTrigger(%Player,%TriggerId); }
function PlayerEnterTrigger_813040205(%Player,%TriggerId){ YunXianJie_EndterTrigger(%Player,%TriggerId); }
function PlayerEnterTrigger_813040405(%Player,%TriggerId){ YunXianJie_EndterTrigger(%Player,%TriggerId); }
function PlayerEnterTrigger_813040505(%Player,%TriggerId){ YunXianJie_EndterTrigger(%Player,%TriggerId); }
function PlayerEnterTrigger_813040605(%Player,%TriggerId){ YunXianJie_EndterTrigger(%Player,%TriggerId); }
function PlayerEnterTrigger_813040305(%Player,%TriggerId){ YunXianJie_EndterTrigger(%Player,%TriggerId); }
function YunXianJie_EndterTrigger(%Player,%TriggerId)
{
	%CopyMapID = %Player.GetLayerid();
	if ($Tirggerlist[%CopyMapID,%TriggerId] != -1)
		$Tirggerlist[%CopyMapID,%TriggerId] ++;
	%Player.TriggerIDRecord = %TriggerId;
	//echo( "==================================="  @ %Player.TriggerIDRecord );
}
function PlayerOnExitTrigger_813040101(%Player){ YunXianJie_ExitTrigger(%Player,813040101); }
function PlayerOnExitTrigger_813040205(%Player){ YunXianJie_ExitTrigger(%Player,813040205); }
function PlayerOnExitTrigger_813040405(%Player){ YunXianJie_ExitTrigger(%Player,813040405); }
function PlayerOnExitTrigger_813040505(%Player){ YunXianJie_ExitTrigger(%Player,813040505); }
function PlayerOnExitTrigger_813040605(%Player){ YunXianJie_ExitTrigger(%Player,813040605); }
function PlayerOnExitTrigger_813040305(%Player){ YunXianJie_ExitTrigger(%Player,813040305); }
function YunXianJie_ExitTrigger(%Player,%TriggerId)
{
	%CopyMapID = %Player.GetLayerid();
	if ($Tirggerlist[%CopyMapID,%TriggerId] != -1)
		$Tirggerlist[%CopyMapID,%TriggerId] --;
}

function PlayerEnterTrigger_813040201(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040405); }
function PlayerEnterTrigger_813040202(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040505); }
function PlayerEnterTrigger_813040203(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040605); }
function PlayerEnterTrigger_813040204(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040305); }
function PlayerEnterTrigger_813040301(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040405); }
function PlayerEnterTrigger_813040302(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040505); }
function PlayerEnterTrigger_813040303(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040605); }
function PlayerEnterTrigger_813040304(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040205); }
function PlayerEnterTrigger_813040401(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040205); }
function PlayerEnterTrigger_813040402(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040505); }
function PlayerEnterTrigger_813040403(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040605); }
function PlayerEnterTrigger_813040404(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040305); }
function PlayerEnterTrigger_813040501(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040405); }
function PlayerEnterTrigger_813040502(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040205); }
function PlayerEnterTrigger_813040503(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040605); }
function PlayerEnterTrigger_813040504(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040305); }
function PlayerEnterTrigger_813040601(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040405); }
function PlayerEnterTrigger_813040602(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040505); }
function PlayerEnterTrigger_813040603(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040205); }
function PlayerEnterTrigger_813040604(%Player,%TriggerId){ YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,813040305); }
function YunXianJie_EndterTrigger_TransPortobject(%Player,%TriggerId,%TargetTri)
{
	if (%player.isschbuff(1003))
	{
		SendOneScreenMessage(2,"处于虚无状态，暂时无法传送",%player);
		SendOneChatMessage($chatMsg_System,"<t>处于虚无状态，暂时无法传送</t>",%player);
		return;
	}

	if (%TargetTri == 813040205)
	{
		%Ran = GetRandom(1,30);
		%Pos = $YunXianJie_TriggerIDPos[%TargetTri,%Ran];
		%Pos_X = getword(%Pos,0);
		%Pos_Y = getword(%Pos,1);
		%Pos_Z = getword(%Pos,2);
	}
	else
	{
		%Pos = $YunXianJie_TriggerIDPos[%TargetTri];
		%Pos_X = getword(%Pos,0);
		%Pos_Y = getword(%Pos,1);
		%Pos_Z = getword(%Pos,2);
		%Pos_X = GetRanDom(%Pos_X - 10,%Pos_X + 10);
		%Pos_Y = GetRanDom(%Pos_Y - 10,%Pos_Y + 10);
	}
	%Player.SetSchbuff(1003);//虚无BUFF
	%Player.TransportObject(0,0,%Pos_X,%Pos_Y,%Pos_Z);
}
//■■■■【鸿蒙试炼】■■■■【区域触发】■■■■■■■■■


//■■■■【鸿蒙试炼】■■■■【调度状态触发】■■■■■■■
function ScheduleBuff_2004(%Player,%BuffID,%IsAuto)
{
	%MapID = getsubstr(getzoneid(),0,4);
	%CopyMapID = %Player.GetLayerId();
	%triggerid = %Player.TriggerIDRecord;
	if (%Player.TriggerIDRecord $= "")
		%triggerid = %Player.GetTriggerID();
	//echo( "%triggerid===" @ %triggerid );
	//%counttri = $Tirggerlist[ %CopyMapID, 813040205 ] + $Tirggerlist[ %CopyMapID, 813040405 ] + $Tirggerlist[ %CopyMapID, 813040605 ] + $Tirggerlist[ %CopyMapID, 813040305 ] + $Tirggerlist[ %CopyMapID, 813040505 ];
	//%countplayer = $TeammateNum[ %CopyMapID, 813040102 ] + $TeammateNum[ %CopyMapID, 813040103 ] + $TeammateNum[ %CopyMapID, 813040104 ]+ $TeammateNum[ %CopyMapID, 813040105 ] + $TeammateNum[ %CopyMapID, 813040106 ];
	if (%MapID == 1304)
	{
		if (%triggerid == 813040205 || %triggerid == 813040405 || %triggerid == 813040605 || %triggerid == 813040305 || %triggerid == 813040505)
		{
			//echo( "$Tirggerlist[ %CopyMapID, " @ %triggerid @ "]===" @ $Tirggerlist[ %CopyMapID, %triggerid ] );
			if ($Tirggerlist[%CopyMapID,%triggerid] == -1)
			{
				//添加掉血的BUFF，持续3秒，不可见
				%Player.addbuff(399100001,%Player,1);
			}
			else if ($LivePeople[%CopyMapID] > $LiveJieYu[%CopyMapID] * 10)
			{

				%text = "当前战场内人数超过" @ $LiveJieYu[%CopyMapID] * 10 @ "，无法获得经验奖励";
				//SendAllChatMessageLayer( 0, $Get_Dialog_GeShi[ 31406 ]  @ %text @ "</t>", %CopyMapID );	//发送副本层消息( 屏幕左下 )
				//SendAllScreenMessageLayer( 0, %text, %CopyMapID );	//发送副本层消息( 屏幕中间 )
				SendOneScreenMessage(2,%text,%player);
				SendOneChatMessage($chatMsg_System,"<t>" @ %text @ "</t>",%player);
			}
			else
			{
				%Level = %Player.getlevel();
				if (%Level < 30) %levelxishu = 0.3;
				else if (%Level < 40) %levelxishu = 1;
				else if (%Level < 50) %levelxishu = 1.2;
				else if (%Level < 60) %levelxishu = 1.6;
				else if (%Level < 70) %levelxishu = 2;
				else %levelxishu = 2.2;

				switch ($LiveJieYu[%CopyMapID])
				{
					case 1:%quyuxishu = 2.0;
					case 2:%quyuxishu = 1.75;
					case 3:%quyuxishu = 1.5;
					case 4:%quyuxishu = 1.2;
					case 5:%quyuxishu = 1.0;
				}

				%Exp_LeiJiaBeiShu = 0;
				if (%Player.ISschbuff(1997)) %Exp_LeiJiaBeiShu = 1;	  //经验丹的加成
				else if (%Player.ISschbuff(1998)) %Exp_LeiJiaBeiShu = 1.5; //经验丹的加成
				else if (%Player.ISschbuff(1999)) %Exp_LeiJiaBeiShu = 2;	  //经验丹的加成

				//每3秒一跳：	EXP = 等级对应怪物经验 * 区域系数 *玩家等级阶段系数 * 双倍
				%exp = $Monster_Exp[%Level,1] * %quyuxishu * %levelxishu * (1 + %Exp_LeiJiaBeiShu);
				AllAddExp(%Player,%exp);
			}
		}
		%Player.SetSchbuff(2004);
		return 0;
	}
	else
	{
		%Player.RemoveSchBuff(2004);
		return 1;
	}
}
//■■■■【鸿蒙试炼】■■■■【调度状态触发】■■■■■■■


//■■■■【鸿蒙试炼】■■■■【区域损毁】■■■■■■■■■
function HuiDiaoYiGeQuYu(%CopyMapID,%step,%id)//区域损毁
{
	//echo("%id===" @ %id);
	Cancel($HuiDiaoYiGeQuYu[%CopyMapID]);
	switch (%step)
	{
		case 0:
			%NoIn = "";
			for (%i = 2; %i <=6; %i++)
			{
				%TriggerID = 813040005 + %i *100;
				if ($Tirggerlist[%CopyMapID,%TriggerID] == -1)
					%NoIn = %i @ " " @ %NoIn;
			}
			//echo( "%NoIn===" @ %NoIn );
			%id = GetRandomNum2(1,2,6,%NoIn);
			//echo( "%id===" @ %id );
			//echo( "813040005 + %id *100===" @ 813040005 + %id *100 );
			%QuYuName = $YunXianJie_TriggerIDName[813040005 + %id *100];
			%text = %QuYuName @ "将在30秒后损毁，请远离此区域";
			SendAllChatMessageLayer(0,$Get_Dialog_GeShi[31406]  @ %text @ "</t>",%CopyMapID);	//发送副本层消息( 屏幕左下 )
			SendAllScreenMessageLayer(0,%text,%CopyMapID);	//发送副本层消息( 屏幕中间 )

			$HuiDiaoYiGeQuYu[%CopyMapID]  = Schedule(20 * 1000,0,"HuiDiaoYiGeQuYu",%CopyMapID,1,%id);
		case 1:

			%QuYuName = $YunXianJie_TriggerIDName[813040005 + %id *100];
			%text = %QuYuName @ "将在10秒后损毁，请远离此区域";
			SendAllChatMessageLayer(0,$Get_Dialog_GeShi[31406]  @ %text @ "</t>",%CopyMapID);	//发送副本层消息( 屏幕左下 )
			SendAllScreenMessageLayer(0,%text,%CopyMapID);	//发送副本层消息( 屏幕中间 )

			$HuiDiaoYiGeQuYu[%CopyMapID]  = Schedule(10 * 1000,0,"HuiDiaoYiGeQuYu",%CopyMapID,2,%id);
		case 2:
			$Tirggerlist[%CopyMapID,813040005 + %id *100] = -1;
			%QuYuName = $YunXianJie_TriggerIDName[813040005 + %id *100];
			%text = %QuYuName @ "被损毁，请远离此区域";
			SendAllChatMessageLayer(0,$Get_Dialog_GeShi[31406]  @ %text @ "</t>",%CopyMapID);	//发送副本层消息( 屏幕左下 )
			SendAllScreenMessageLayer(0,%text,%CopyMapID);	//发送副本层消息( 屏幕中间 )

			createtripacket(%copymapid,813040005 + %id *100);
	}
}
function createtripacket(%CopyMapID,%triggerid)//区域损毁特效
{
	Cancel($createtripacket[%CopyMapID,%triggerid]);
	%PosX = getword($YunXianJie_TriggerIDPos[%triggerid],0);
	%PosY = getword($YunXianJie_TriggerIDPos[%triggerid],1);
	%PosZ = getword($YunXianJie_TriggerIDPos[%triggerid],2);
	%Packet = GetRandom(900143,900146);
	//echo( "区域损毁特效%triggerid==" @ %triggerid  @ "      " @ %Packet );
	switch (%Packet)
	{
		case 900143://风
			%PosXA = GetRanDom(%PosX - 10,%PosX + 10);
			%PosYA = GetRanDom(%PosY - 10,%PosY + 10);
			removepacket($Copymap1307Packet[%CopyMapID,%triggerid,1]);
			$Copymap1307Packet[%CopyMapID,%triggerid,1] = addEffectPacket(%Packet,0,%PosXA @ " " @ %PosYA @ " " @ %PosZ,"1 0 0 0",0,0,-1,%CopyMapID);
			%Time = 30;
		case 900144://雷
			for (%i = 1; %i <= 20; %i++)
			{
				%PosXA = GetRanDom(%PosX - 30,%PosX + 30);
				%PosYA = GetRanDom(%PosY - 30,%PosY + 30);
				removepacket($Copymap1307Packet[%CopyMapID,%triggerid,%i]);
				$Copymap1307Packet[%CopyMapID,%triggerid,%i] = addEffectPacket(%Packet,0,%PosXA @ " " @ %PosYA @ " " @ %PosZ,"1 0 0 0",0,0,-1,%CopyMapID);
			}
			%Time = 5;
		case 900145://火
			for (%i = 1; %i <= 20; %i++)
			{
				%PosXA = GetRanDom(%PosX - 30,%PosX + 30);
				%PosYA = GetRanDom(%PosY - 30,%PosY + 30);
				removepacket($Copymap1307Packet[%CopyMapID,%triggerid,%i]);
				$Copymap1307Packet[%CopyMapID,%triggerid,%i] = addEffectPacket(%Packet,0,%PosXA @ " " @ %PosYA @ " " @ %PosZ,"1 0 0 0",0,0,-1,%CopyMapID);
			}
			%Time = 10;
		case 900146://冰
			for (%i = 1; %i <= 20; %i++)
			{
				%PosXA = GetRanDom(%PosX - 30,%PosX + 30);
				%PosYA = GetRanDom(%PosY - 30,%PosY + 30);
				removepacket($Copymap1307Packet[%CopyMapID,%triggerid,%i]);
				$Copymap1307Packet[%CopyMapID,%triggerid,%i] = addEffectPacket(%Packet,0,%PosXA @ " " @ %PosYA @ " " @ %PosZ,"1 0 0 0",0,0,-1,%CopyMapID);
				//echo( %PosXA @ " " @ %PosYA @ " " @ %PosZ @  "$Copymap1307Packet[ %CopyMapID, %triggerid, %i ]" );
			}
			%Time = 10;
	}
	if (%Time > 0)
		$createtripacket[%CopyMapID,%triggerid] = Schedule(%Time * 1000,0,"createtripacket",%CopyMapID,%triggerid);
}


//■■■■【鸿蒙试炼】■■■■【区域损毁】■■■■■■■■■

//■■■■【鸿蒙试炼】■■■■【创建采集物】■■■■■■■■

function createcj1307(%CopyMapID,%optype)
{
	switch (%optype)
	{
		case 1:
			for (%t = 2; %t <= 6; %t++)
			{
				%triggerid = 813040005 + %t * 100;
				if ($Tirggerlist[%CopyMapID,%triggerid] == -1)
					continue;
				for (%i = 0; %i < 5; %i++)
				{
					%ran = GetRandom(1,16);
					%BuffID = getword($YunXianJie_Buff[%ran],0);
					%packet = getword($YunXianJie_Buff[%ran],1);
					switch (%triggerid)
					{
						case 813040205:
							%random = getrandom(1,30);
							%pos = $YunXianJie_TriggerIDPos[%triggerid,%random];
						default:
							%Pos = $YunXianJie_TriggerIDPos[%triggerid];
							%Pos_X = getword(%Pos,0);
							%Pos_Y = getword(%Pos,1);
							%Pos_Z = getword(%Pos,2);
							%Pos_X = GetRanDom(%Pos_X - 10,%Pos_X + 10);
							%Pos_Y = GetRanDom(%Pos_Y - 10,%Pos_Y + 10);
							%Pos = %Pos_X @ " " @ %Pos_Y @ " " @ %Pos_Z;

					}
					%obj = SpNewCj2(0,553000013,%Pos,%CopyMapID,0,"1 1 1");//鸿蒙试炼彩蛋
					%randon = getrandom(1,14);

					%obj.BuffRecord = %BuffID;
					%obj.addpacket(%packet);
				}
			}
		case 2:
			for (%t = 2; %t <= 6; %t++)
			{
				%triggerid = 813040005 + %t * 100;
				echo("%triggerid ====" @ %triggerid  @ "         " @ $Tirggerlist[%CopyMapID,%triggerid]);
				if ($Tirggerlist[%CopyMapID,%triggerid] == -1)
					continue;

				for (%i = 0; %i < 5; %i++)
				{
					switch (%triggerid)
					{
						case 813040205:
							%random = getrandom(1,30);
							%pos = $YunXianJie_TriggerIDPos[%triggerid,%random];
						default:
							%Pos = $YunXianJie_TriggerIDPos[%triggerid];
							%Pos_X = getword(%Pos,0);
							%Pos_Y = getword(%Pos,1);
							%Pos_Z = getword(%Pos,2);
							%Pos_X = GetRanDom(%Pos_X - 10,%Pos_X + 10);
							%Pos_Y = GetRanDom(%Pos_Y - 10,%Pos_Y + 10);
							%Pos = %Pos_X @ " " @ %Pos_Y @ " " @ %Pos_Z;

					}
					%obj = SpNewCj2(0,553000014,%Pos,%CopyMapID,0,"1 1 1");//鸿蒙试炼小宝箱
					%Obj.SetShapeName("陨仙界宝藏");
				}
			}
		case 3:
			for (%t = 2; %t <= 6; %t++)
			{
				%triggerid = 813040005 + %t * 100;
				if ($Tirggerlist[%CopyMapID,%triggerid] == -1)
					continue;
				for (%i = 0; %i < 7; %i++)
				{
					switch (%triggerid)
					{
						case 813040205:
							%random = getrandom(1,30);
							%pos = $YunXianJie_TriggerIDPos[%triggerid,%random];
						default:
							%Pos = $YunXianJie_TriggerIDPos[%triggerid];
							%Pos_X = getword(%Pos,0);
							%Pos_Y = getword(%Pos,1);
							%Pos_Z = getword(%Pos,2);
							%Pos_X = GetRanDom(%Pos_X - 10,%Pos_X + 10);
							%Pos_Y = GetRanDom(%Pos_Y - 10,%Pos_Y + 10);
							%Pos = %Pos_X @ " " @ %Pos_Y @ " " @ %Pos_Z;

					}
					if (%i <= 3)
						%obj = SpNewCj2(0,553000014,%Pos,%CopyMapID,0,"1 1 1");//鸿蒙试炼小宝箱
					else
						%obj = SpNewCj2(0,553000015,%Pos,%CopyMapID,0,"2 2 2");//鸿蒙试炼大宝箱
					%Obj.SetShapeName("陨仙界宝藏");
				}
			}
	}

}

//■■■■【鸿蒙试炼】■■■■【创建采集物】■■■■■■■■



//■■■■【鸿蒙试炼】■■■■【开战集体传送】■■■■■■■
function SvrCopymapOpen_1307_TriggerB(%CopyMapID,%CopymapDataID)
{
	Cancel($ScheduleCopymap1307B[%CopyMapID]);//先清除倒计时
	SptCopymap_Close(%CopyMapID);//关闭副本层

	%TeammateList = SptCopyMap_GetAllPlayer(%CopyMapID);//获取副本玩家信息
	%TeammateNum = SptCopyMap_GetPlayerCount(%CopyMapID);//获取副本玩家数量

	for (%i=0; %i< %TeammateNum; %i++)
	{
		%Player = getword(%TeammateList,%i);
		AddAchievementWatch(%Player,0,43,1);//记录成就

		%Ran  =getrandom(2,6);
		%TargetTri =813040005 + %Ran * 100;

		if (%TargetTri == 813040205)
		{
			%Ran = GetRandom(1,30);
			%Pos = $YunXianJie_TriggerIDPos[%TargetTri,%Ran];
			%Pos_X = getword(%Pos,0);
			%Pos_Y = getword(%Pos,1);
			%Pos_Z = getword(%Pos,2);
		}
		else
		{
			%Pos = $YunXianJie_TriggerIDPos[%TargetTri];
			%Pos_X = getword(%Pos,0);
			%Pos_Y = getword(%Pos,1);
			%Pos_Z = getword(%Pos,2);
			%Pos_X = GetRanDom(%Pos_X - 10,%Pos_X + 10);
			%Pos_Y = GetRanDom(%Pos_Y - 10,%Pos_Y + 10);
		}
		%Player.TransportObject(0,0,%Pos_X,%Pos_Y,%Pos_Z);
	}
}
//■■■■【鸿蒙试炼】■■■■【开战集体传送】■■■■■■■

//■■■■【鸿蒙试炼】■■■■【副本结束处理】■■■■■■■
function closecopymap1307(%CopyMapID)
{
	SptCopymap_Close(%CopyMapID);//关闭副本层

	Cancel($ScheduleCopymap1307[%CopyMapID]);//先清除倒计时
	Cancel($HuiDiaoYiGeQuYu[%CopyMapID]);//区域损毁倒计时
	Cancel($createtripacket[%CopyMapID,813040205]);//区域特效倒计时
	Cancel($createtripacket[%CopyMapID,813040405]);//区域特效倒计时
	Cancel($createtripacket[%CopyMapID,813040505]);//区域特效倒计时
	Cancel($createtripacket[%CopyMapID,813040605]);//区域特效倒计时
	Cancel($createtripacket[%CopyMapID,813040305]);//区域特效倒计时
	for (%i = 1; %i <= 5; %i++)
	{
		%TriggerID = 813040005 + %i *100;
		for (%j = 1; %j <= 20; %j++)
		{
			if (!isobject($Copymap1307Packet[%CopyMapID,%TriggerID,%j]))
				break;
			removepacket($Copymap1307Packet[%CopyMapID,%TriggerID,%j]);
		}
	}
	Removepacket($Copymap1307Packet[%CopyMapID,813040205]);//移除区域特效
	Removepacket($Copymap1307Packet[%CopyMapID,813040405]);//移除区域特效
	Removepacket($Copymap1307Packet[%CopyMapID,813040505]);//移除区域特效
	Removepacket($Copymap1307Packet[%CopyMapID,813040605]);//移除区域特效
	Removepacket($Copymap1307Packet[%CopyMapID,813040305]);//移除区域特效

	%TeammateList = SptCopyMap_GetAllPlayer(%CopyMapID);//获取副本玩家信息
	%TeammateNum = SptCopyMap_GetPlayerCount(%CopyMapID);//获取副本玩家数量

	%Pox = GetWord($YunXianJie_TriggerIDPos[813040101],0);
	%Poy = GetWord($YunXianJie_TriggerIDPos[813040101],1);
	%Poz = GetWord($YunXianJie_TriggerIDPos[813040101],2);
	for (%i=0; %i< %TeammateNum; %i++)
	{
		%Player = getword(%TeammateList,%i);
		%Triggerid = %Player.GetTriggerid();
		if (%Triggerid !=  813040101)
		{
			%Pox_A = GetRanDom(%Pox - 10,%Pox + 10);
			%Poy_A = GetRanDom(%Poy - 10,%Poy + 10);
			%Player.Transportobject(0,0,%Pox_A,%Poy_A,%Poz);
		}
		//发送保底奖励
		if (GetSrc(%Player, 6) == 0)
		{
			SetSrc(%player, 6);

			%Level = %Player.getlevel();
			if (%Level < 30) %levelxishu = 0.3;
			else if (%Level < 40) %levelxishu = 1;
			else if (%Level < 50) %levelxishu = 1.2;
			else if (%Level < 60) %levelxishu = 1.6;
			else if (%Level < 70) %levelxishu = 2;
			else %levelxishu = 2.2;
			//保底奖励：	EXP = 等级对应怪物经验 * 玩家等级阶段系数 * （100 + 在副本内生存时间 * 10）
			%Exp = $Monster_Exp[%Level, 1] * %levelxishu * (100 + mfloor(($BattleTimeRecord[%CopyMapID] - 300) / 60)* 100);
			AllAddExp(%Player, %exp);
			SendOneScreenMessage(2, "成功获得经验奖励", %player);
			SendOneChatMessage($chatMsg_System, "<t>你在本次战斗坚持到了最后，获得最终经验奖励：</t>" @ %exp @ "<t>。</t>", %player);
		}
	}
	RemoveCopyMapOnLeaveTeam(%CopyMapID,3);
}
//■■■■【鸿蒙试炼】■■■■【副本结束处理】■■■■■■■


//■■■■【鸿蒙试炼】■■■■【采集物触发】■■■■■■■■

function TriggerEvent_553000013(%Player,%Event,%EventID)//鸿蒙试炼彩蛋
{
	%Player.addbuff(%Event.BuffRecord,%player,1);
	%Event.safedeleteobject();
	return true;
}
function TriggerEvent_553000014(%Player,%Event,%EventID)//鸿蒙试炼小宝箱
{
	%ItemID[1] = 105100111; %ItemMsg[1] = 3; %itemRan[1] = 649;
	%ItemID[2] = 105100121; %ItemMsg[2] = 3; %itemRan[2] = 649;
	%ItemID[3] = 105100131; %ItemMsg[3] = 2; %itemRan[3] = 4090;
	%ItemID[4] = 105105301; %ItemMsg[4] = 2; %itemRan[4] = 3246;
	%ItemID[5] = 105105302; %ItemMsg[5] = 3; %itemRan[5] = 847;
	%ItemID[6] = 105105303; %ItemMsg[6] = 3; %itemRan[6] = 519;

	%Ran = GetRanDom(1,10000);
	%All = 0;
	for (%i = 1; %i <= 6; %i++)
	{
		%All = %All + %itemRan[%i];
		if (%All >= %Ran)
		{
			%ItemID = %ItemID[%i];
			%Msg = %ItemMsg[%i];
			break;
		}
	}
	if (%ItemID > 0)
	{
		%Player.PutItem(%ItemID,1);
		if (%Player.Additem(4,%EventID))
		{
			if (%Msg > 0)
			{
				%ItemName1 = GetItemName(%ItemID,1);
				%ItemName2 = GetItemName(%ItemID,2);
				%HuoDongMingCheng1 = GetHuoDongName("陨仙界宝藏",1);
				%HuoDongMingCheng2 = GetHuoDongName("陨仙界宝藏",2);
				%MapName = GetMapName(%Player,2);
				%Path ="<l i='" @ "813040100 " @ %Player.GetPosition() @ "' t='path'/>";
				%Text1 = "<t>神秘修士在</t>" @ %Path @ "<t>发掘</t>" @ %HuoDongMingCheng1 @ "<t>获得</t>" @ %ItemName1 @ "<t>！</t>";
				%Text2 = "<t>神秘修士在</t>" @ %MapName @ "<t>发掘</t>" @ %HuoDongMingCheng2 @ "<t>获得</t>" @ %ItemName2 @ "<t>！</t>";
				switch (%Msg)
				{
					case 1:
						SendOneLineMessage($Get_Dialog_GeShi[31419] @  %Text1 @ "</t>");
					case 2:
						SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
					case 3:
						SendOneLineMessage($Get_Dialog_GeShi[31419] @  %Text1 @ "</t>");
						SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
				}
			}
		}
	}
	return true;
}
function TriggerEvent_553000015(%Player,%Event,%EventID)//鸿蒙试炼大宝箱
{

	%ItemID[1] = 105100111; %ItemMsg[1] = 3; %itemRan[1] = 1958;
	%ItemID[2] = 105100121; %ItemMsg[2] = 3; %itemRan[2] = 1958;
	%ItemID[3] = 105100112; %ItemMsg[3] = 3; %itemRan[3] = 980;
	%ItemID[4] = 105100122; %ItemMsg[4] = 3; %itemRan[4] = 980;
	%ItemID[5] = 105105302; %ItemMsg[5] = 3; %itemRan[5] = 2558;
	%ItemID[6] = 105105303; %ItemMsg[6] = 3; %itemRan[6] = 1566;

	%Ran = GetRanDom(1,10000);
	%All = 0;
	for (%i = 1; %i <= 6; %i++)
	{
		%All = %All + %itemRan[%i];
		if (%All >= %Ran)
		{
			%ItemID = %ItemID[%i];
			%Msg = %ItemMsg[%i];
			break;
		}
	}
	if (%ItemID > 0)
	{
		%Player.PutItem(%ItemID,1);
		if (%Player.Additem(4,%EventID))
		{
			if (%Msg > 0)
			{
				%ItemName1 = GetItemName(%ItemID,1);
				%ItemName2 = GetItemName(%ItemID,2);
				%HuoDongMingCheng1 = GetHuoDongName("陨仙界宝藏",1);
				%HuoDongMingCheng2 = GetHuoDongName("陨仙界宝藏",2);
				%MapName = GetMapName(%Player,2);
				%Path ="<l i='" @ "813040100 " @ %Player.GetPosition() @ "' t='path'/>";
				%Text1 = "<t>神秘修士在</t>" @ %Path @ "<t>发掘</t>" @ %HuoDongMingCheng1 @ "<t>获得</t>" @ %ItemName1 @ "<t>！</t>";
				%Text2 = "<t>神秘修士在</t>" @ %MapName @ "<t>发掘</t>" @ %HuoDongMingCheng2 @ "<t>获得</t>" @ %ItemName2 @ "<t>！</t>";
				//echo( "%Text1===" @ %Text1 );
				switch (%Msg)
				{
					case 1:
						SendOneLineMessage($Get_Dialog_GeShi[31419] @  %Text1 @ "</t>");
					case 2:
						SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
					case 3:
						SendOneLineMessage($Get_Dialog_GeShi[31419] @  %Text1 @ "</t>");
						SendOneLineMessage($Get_Dialog_GeShi[60001] @ %Text2 @ "</t>", $chatMsg_Type_Normal2);
				}
			}
		}
	}
	return true;
}
//■■■■【鸿蒙试炼】■■■■【采集物触发】■■■■■■■■
//SptCombatStarted( %CopyMapID );

//■■■■【鸿蒙试炼】■■■■【数据发送】■■■■■■■■■
function CopyMap1304SendStringToOnePlayer(%Player,%Txt)
{
	%Player.SendPlayerString(7,%Txt @ " " @ %Player.DaTaoShaKillNumber * 1,0);
}
//■■■■【鸿蒙试炼】■■■■【数据发送】■■■■■■■■■


//■■■■【鸿蒙试炼】■■■■【死亡触发】■■■■■■■■■
function SvrEventOnDisabled_1307(%Player,%optype)
{
	//echo( "鸿蒙试炼============" );
	%CopyMapID = %Player.GetLayerID();
	//复活玩家
	if (%Player.GetDamageState() $= "Disabled")
		%Player.SetDamageState(Enabled);
	//添加回血状态
	%Player.AddBuff(399020200,%Player,100);
	//复活保护
	%Player.AddBuff(399010001,%Player,1);
	%Player.TransPortObject(0,0,1.79418,148.958,158.025);
	//发送保底奖励
	if (GetSrc(%Player,6) == 0)
	{
		SetSrc(%player,6);

		%Level = %Player.getlevel();
		if (%Level < 30) %levelxishu = 0.3;
		else if (%Level < 40) %levelxishu = 1;
		else if (%Level < 50) %levelxishu = 1.2;
		else if (%Level < 60) %levelxishu = 1.6;
		else if (%Level < 70) %levelxishu = 2;
		else %levelxishu = 2.2;
		//保底奖励：	EXP = 等级对应怪物经验 * 玩家等级阶段系数 * （100 + 在副本内生存时间 * 10）
		%Exp = $Monster_Exp[%Level,1] * %levelxishu * (100 + mfloor(($BattleTimeRecord[%CopyMapID] - 300) / 60)* 100);
		AllAddExp(%Player,%exp);
		SendOneScreenMessage(2,"成功获得经验奖励",%player);
		SendOneChatMessage($chatMsg_System,"<t>很遗憾，你在本次战场中被淘汰了，获得最后经验奖励：</t>" @ %exp @ "<t>。</t>",%player);
	}
}

function PlayeronDeathCast_1307(%Player,%Killer)
{
	%Killer.DaTaoShaKillNumber++;
	CopyMap1304SendStringToOnePlayer(%Killer,$CopyMapMsgRecord[%CopyMapID]);
}
//■■■■【鸿蒙试炼】■■■■【死亡触发】■■■■■■■■■


function sdssssss()
{
	%Player = SptGetPlayer(50000007);
	%ran = GetRandom(1,16);
	%BuffID = getword($YunXianJie_Buff[%ran],0);
	%packet = getword($YunXianJie_Buff[%ran],1);
	%obj = SpNewCj2(%Player,553000013,0,%Player.GetLayerID(),0,"1 1 1");//鸿蒙试炼彩蛋
	%obj.BuffRecord = %BuffID;
	%obj.addpacket(%packet);
}


function ddssaaaa(%Player)
{

	%Ran  =getrandom(2,6);
	%TargetTri =813040005 + %Ran * 100;

	if (%TargetTri == 813040205)
	{
		%Ran = GetRandom(1,30);
		%Pos = $YunXianJie_TriggerIDPos[%TargetTri,%Ran];
		%Pos_X = getword(%Pos,0);
		%Pos_Y = getword(%Pos,1);
		%Pos_Z = getword(%Pos,2);
	}
	else
	{
		%Pos = $YunXianJie_TriggerIDPos[%TargetTri];
		%Pos_X = getword(%Pos,0);
		%Pos_Y = getword(%Pos,1);
		%Pos_Z = getword(%Pos,2);
		%Pos_X = GetRanDom(%Pos_X - 10,%Pos_X + 10);
		%Pos_Y = GetRanDom(%Pos_Y - 10,%Pos_Y + 10);
	}
	%Player.TransportObject(0,0,%Pos_X,%Pos_Y,%Pos_Z);
}


